diff --git a/ci/build/build-release.sh b/ci/build/build-release.sh
index c87645d3..913a0b9e 100755
--- a/ci/build/build-release.sh
+++ b/ci/build/build-release.sh
@@ -37,6 +37,8 @@ bundle_code_server() {
   rsync out dist "$RELEASE_PATH"
 
   # For source maps and images.
+  mkdir -p "$RELEASE_PATH/cpr"
+  rsync cpr/ "$RELEASE_PATH/cpr"
   mkdir -p "$RELEASE_PATH/src/browser"
   rsync src/browser/media/ "$RELEASE_PATH/src/browser/media"
   mkdir -p "$RELEASE_PATH/src/browser/pages"
diff --git a/cpr/coderpair-firepad.min.js b/cpr/coderpair-firepad.min.js
new file mode 100644
index 00000000..37728004
--- /dev/null
+++ b/cpr/coderpair-firepad.min.js
@@ -0,0 +1,296 @@
+//A modified version of Firepad
+!function(t,e,r){"undefined"!=typeof module&&module.exports?module.exports=e():"function"==typeof r.define&&r.define.amd?define(e):r.Firepad=e()}(0,function(){function t(t){return function(t){if(Array.isArray(t)){for(var e=0,r=new Array(t.length);e<t.length;e++)r[e]=t[e];return r}}(t)||function(t){if(Symbol.iterator in Object(t)||"[object Arguments]"===Object.prototype.toString.call(t))return Array.from(t)}(t)||function(){throw new TypeError("Invalid attempt to spread non-iterable instance")}()}function e(t,e){for(var r=0;r<e.length;r++){var n=e[r];n.enumerable=n.enumerable||!1,n.configurable=!0,"value"in n&&(n.writable=!0),Object.defineProperty(t,n.key,n)}}(r=r||{}).utils={},r.utils.makeEventEmitter=function(t,e){t.prototype.allowedEvents_=e,t.prototype.on=function(t,e,r){this.validateEventType_(t),this.eventListeners_=this.eventListeners_||{},this.eventListeners_[t]=this.eventListeners_[t]||[],this.eventListeners_[t].push({callback:e,context:r})},t.prototype.off=function(t,e){this.validateEventType_(t),this.eventListeners_=this.eventListeners_||{};for(var r=this.eventListeners_[t]||[],n=0;n<r.length;n++)if(r[n].callback===e)return void r.splice(n,1)},t.prototype.trigger=function(t){this.eventListeners_=this.eventListeners_||{};for(var e=this.eventListeners_[t]||[],r=0;r<e.length;r++)e[r].callback.apply(e[r].context,Array.prototype.slice.call(arguments,1))},t.prototype.validateEventType_=function(t){if(this.allowedEvents_){for(var e=!1,r=0;r<this.allowedEvents_.length;r++)if(this.allowedEvents_[r]===t){e=!0;break}if(!e)throw new Error('Unknown event "'+t+'"')}}},r.utils.elt=function(t,e,n){var i=document.createElement(t);if("string"==typeof e)r.utils.setTextContent(i,e);else if(e)for(var o=0;o<e.length;++o)i.appendChild(e[o]);for(var s in n||{})i.setAttribute(s,n[s]);return i},r.utils.setTextContent=function(t,e){t.innerHTML="",t.appendChild(document.createTextNode(e))},r.utils.on=function(t,e,r,n){t.addEventListener?t.addEventListener(e,r,n||!1):t.attachEvent&&t.attachEvent("on"+e,r)},r.utils.off=function(t,e,r,n){t.removeEventListener?t.removeEventListener(e,r,n||!1):t.detachEvent&&t.detachEvent("on"+e,r)},r.utils.preventDefault=function(t){t.preventDefault?t.preventDefault():t.returnValue=!1},r.utils.stopPropagation=function(t){t.stopPropagation?t.stopPropagation():t.cancelBubble=!0},r.utils.stopEvent=function(t){r.utils.preventDefault(t),r.utils.stopPropagation(t)},r.utils.stopEventAnd=function(t){return function(e){return t(e),r.utils.stopEvent(e),!1}},r.utils.trim=function(t){return t.replace(/^\s+/g,"").replace(/\s+$/g,"")},r.utils.stringEndsWith=function(t,e){for(var r="string"==typeof e?[e]:e,n=0;n<r.length;n++){e=r[n];if(-1!==t.indexOf(e,t.length-e.length))return!0}return!1},r.utils.assert=function(t,e){if(!t)throw new Error(e||"assertion error")},r.utils.log=function(){if("undefined"!=typeof console&&void 0!==console.log){for(var t=["Firepad:"],e=0;e<arguments.length;e++)t.push(arguments[e]);console.log.apply(console,t)}},(r=r||{}).Span=function(){function t(t,e){this.pos=t,this.length=e}return t.prototype.end=function(){return this.pos+this.length},t}(),(r=r||{}).TextOp=function(){var t=r.utils;function e(e){this.type=e,this.chars=null,this.text=null,this.attributes=null,"insert"===e?(this.text=arguments[1],t.assert("string"==typeof this.text),this.attributes=arguments[2]||{},t.assert("object"==typeof this.attributes)):"delete"===e?(this.chars=arguments[1],t.assert("number"==typeof this.chars)):"retain"===e&&(this.chars=arguments[1],t.assert("number"==typeof this.chars),this.attributes=arguments[2]||{},t.assert("object"==typeof this.attributes))}return e.prototype.isInsert=function(){return"insert"===this.type},e.prototype.isDelete=function(){return"delete"===this.type},e.prototype.isRetain=function(){return"retain"===this.type},e.prototype.equals=function(t){return this.type===t.type&&this.text===t.text&&this.chars===t.chars&&this.attributesEqual(t.attributes)},e.prototype.attributesEqual=function(t){for(var e in this.attributes)if(this.attributes[e]!==t[e])return!1;for(e in t)if(this.attributes[e]!==t[e])return!1;return!0},e.prototype.hasEmptyAttributes=function(){var t=!0;for(var e in this.attributes){t=!1;break}return t},e}(),(r=r||{}).TextOperation=function(){"use strict";var t=r.TextOp,e=r.utils;function n(){if(!this||this.constructor!==n)return new n;this.ops=[],this.baseLength=0,this.targetLength=0}function i(t){var e=t.ops;switch(e.length){case 1:return e[0];case 2:return e[0].isRetain()?e[1]:e[1].isRetain()?e[0]:null;case 3:if(e[0].isRetain()&&e[2].isRetain())return e[1]}return null}function o(t){return t.ops[0].isRetain()?t.ops[0].chars:0}return n.prototype.equals=function(t){if(this.baseLength!==t.baseLength)return!1;if(this.targetLength!==t.targetLength)return!1;if(this.ops.length!==t.ops.length)return!1;for(var e=0;e<this.ops.length;e++)if(!this.ops[e].equals(t.ops[e]))return!1;return!0},n.prototype.retain=function(e,r){if("number"!=typeof e||e<0)throw new Error("retain expects a positive integer.");if(0===e)return this;this.baseLength+=e,this.targetLength+=e,r=r||{};var n=this.ops.length>0?this.ops[this.ops.length-1]:null;return n&&n.isRetain()&&n.attributesEqual(r)?n.chars+=e:this.ops.push(new t("retain",e,r)),this},n.prototype.insert=function(e,r){if("string"!=typeof e)throw new Error("insert expects a string");if(""===e)return this;r=r||{},this.targetLength+=e.length;var n=this.ops.length>0?this.ops[this.ops.length-1]:null,i=this.ops.length>1?this.ops[this.ops.length-2]:null;return n&&n.isInsert()&&n.attributesEqual(r)?n.text+=e:n&&n.isDelete()?i&&i.isInsert()&&i.attributesEqual(r)?i.text+=e:(this.ops[this.ops.length-1]=new t("insert",e,r),this.ops.push(n)):this.ops.push(new t("insert",e,r)),this},n.prototype.delete=function(e){if("string"==typeof e&&(e=e.length),"number"!=typeof e||e<0)throw new Error("delete expects a positive integer or a string");if(0===e)return this;this.baseLength+=e;var r=this.ops.length>0?this.ops[this.ops.length-1]:null;return r&&r.isDelete()?r.chars+=e:this.ops.push(new t("delete",e)),this},n.prototype.isNoop=function(){return 0===this.ops.length||1===this.ops.length&&this.ops[0].isRetain()&&this.ops[0].hasEmptyAttributes()},n.prototype.clone=function(){for(var t=new n,e=0;e<this.ops.length;e++)this.ops[e].isRetain()?t.retain(this.ops[e].chars,this.ops[e].attributes):this.ops[e].isInsert()?t.insert(this.ops[e].text,this.ops[e].attributes):t.delete(this.ops[e].chars);return t},n.prototype.toString=function(){return(Array.prototype.map||function(t){for(var e=[],r=0,n=this.length;r<n;r++)e[r]=t(this[r]);return e}).call(this.ops,function(t){return t.isRetain()?"retain "+t.chars:t.isInsert()?"insert '"+t.text+"'":"delete "+t.chars}).join(", ")},n.prototype.toJSON=function(){for(var t=[],e=0;e<this.ops.length;e++)this.ops[e].hasEmptyAttributes()||t.push(this.ops[e].attributes),"retain"===this.ops[e].type?t.push(this.ops[e].chars):"insert"===this.ops[e].type?t.push(this.ops[e].text):"delete"===this.ops[e].type&&t.push(-this.ops[e].chars);return 0===t.length&&t.push(0),t},n.fromJSON=function(t/*wb+*/,targ/*+wb*/){for(var r=new n,i=0,o=t.length;i<o;i++){var s=t[i],a={};
+"object"==typeof s&&(a=s,s=t[++i]),"number"==typeof s?s>0?r.retain(s,a):r.delete(-s):
+/*wb+*/"boolean"==typeof s?r.delete(targ):/*+wb*/
+(e.assert("string"==typeof s),r.insert(s,a))}return r},n.prototype.apply=function(t,r,n){if(r=r||[],n=n||[],t.length!==this.baseLength)throw new Error("The operation's base length must be equal to the string's length.");for(var i,o,s=[],a=0,h=0,c=this.ops,u=0,l=c.length;u<l;u++){var p=c[u];if(p.isRetain()){if(h+p.chars>t.length)throw new Error("Operation can't retain more characters than are left in the string.");for(s[a++]=t.slice(h,h+p.chars),i=0;i<p.chars;i++){var d=r[h+i]||{},f={};for(o in d)f[o]=d[o],e.assert(!1!==f[o]);for(o in p.attributes)!1===p.attributes[o]?delete f[o]:f[o]=p.attributes[o],e.assert(!1!==f[o]);n.push(f)}h+=p.chars}else if(p.isInsert())for(s[a++]=p.text,i=0;i<p.text.length;i++){var g={};for(o in p.attributes)g[o]=p.attributes[o],e.assert(!1!==g[o]);n.push(g)}else h+=p.chars}if(h!==t.length)throw new Error("The operation didn't operate on the whole string.");var m=s.join("");return e.assert(m.length===n.length),m},n.prototype.invert=function(t){log1('invert');for(var e=0,r=new n,i=this.ops,o=0,s=i.length;o<s;o++){var a=i[o];a.isRetain()?(r.retain(a.chars),e+=a.chars):a.isInsert()?r.delete(a.text.length):(r.insert(t.slice(e,e+a.chars)),e+=a.chars)}return r},n.prototype.compose=function(t){log1('compose');if(this.targetLength!==t.baseLength)throw new Error("The base length of the second operation has to be the target length of the first operation");function e(t,e,r){var n,i={};for(n in t)i[n]=t[n];for(n in e)r&&!1===e[n]?delete i[n]:i[n]=e[n];return i}for(var r,i=new n,o=this.clone().ops,s=t.clone().ops,a=0,h=0,c=o[a++],u=s[h++];void 0!==c||void 0!==u;)if(c&&c.isDelete())i.delete(c.chars),c=o[a++];else if(u&&u.isInsert())i.insert(u.text,u.attributes),u=s[h++];else{if(void 0===c)throw new Error("Cannot compose operations: first operation is too short.");if(void 0===u)throw new Error("Cannot compose operations: first operation is too long.");if(c.isRetain()&&u.isRetain())r=e(c.attributes,u.attributes),c.chars>u.chars?(i.retain(u.chars,r),c.chars-=u.chars,u=s[h++]):c.chars===u.chars?(i.retain(c.chars,r),c=o[a++],u=s[h++]):(i.retain(c.chars,r),u.chars-=c.chars,c=o[a++]);else if(c.isInsert()&&u.isDelete())c.text.length>u.chars?(c.text=c.text.slice(u.chars),u=s[h++]):c.text.length===u.chars?(c=o[a++],u=s[h++]):(u.chars-=c.text.length,c=o[a++]);else if(c.isInsert()&&u.isRetain())r=e(c.attributes,u.attributes,!0),c.text.length>u.chars?(i.insert(c.text.slice(0,u.chars),r),c.text=c.text.slice(u.chars),u=s[h++]):c.text.length===u.chars?(i.insert(c.text,r),c=o[a++],u=s[h++]):(i.insert(c.text,r),u.chars-=c.text.length,c=o[a++]);else{if(!c.isRetain()||!u.isDelete())throw new Error("This shouldn't happen: op1: "+JSON.stringify(c)+", op2: "+JSON.stringify(u));c.chars>u.chars?(i.delete(u.chars),c.chars-=u.chars,u=s[h++]):c.chars===u.chars?(i.delete(u.chars),c=o[a++],u=s[h++]):(i.delete(c.chars),u.chars-=c.chars,c=o[a++])}}return i},n.prototype.shouldBeComposedWith=function(t){log1('shouldcomp');if(this.isNoop()||t.isNoop())return!0;var e=o(this),r=o(t),n=i(this),s=i(t);return!(!n||!s)&&(n.isInsert()&&s.isInsert()?e+n.text.length===r:!(!n.isDelete()||!s.isDelete())&&(r+s.chars===e||e===r))},n.prototype.shouldBeComposedWithInverted=function(t){log1('shouldinvert');if(this.isNoop()||t.isNoop())return!0;var e=o(this),r=o(t),n=i(this),s=i(t);return!(!n||!s)&&(n.isInsert()&&s.isInsert()?e+n.text.length===r||e===r:!(!n.isDelete()||!s.isDelete())&&r+s.chars===e)},n.transformAttributes=function(t,r){var n,i={},o={},s={};for(n in t)s[n]=!0;for(n in r)s[n]=!0;for(n in s){var a=t[n],h=r[n];e.assert(null!=a||null!=h),null==a?o[n]=h:null==h?i[n]=a:a===h||(i[n]=a)}return[i,o]},n.transform=function(t,e){if(t.baseLength!==e.baseLength)throw new Error("Both operations have to have the same base length");
+
+for(var r=new n,i=new n,o=t.clone().ops,s=e.clone().ops,a=0,h=0,c=o[a++],u=s[h++];void 0!==c||void 0!==u;)
+/*wb+*/
+if (c && c.isInsert() && u && u.isInsert() && c.text == u.text) {
+    r.retain(c.text.length);
+    i.retain(c.text.length);
+    c = o[a++];
+    u = s[h++];
+}else /*+wb*/
+if(c&&c.isInsert())r.insert(c.text,c.attributes),i.retain(c.text.length),c=o[a++];else if(u&&u.isInsert())r.retain(u.text.length),i.insert(u.text,u.attributes),u=s[h++];else{if(void 0===c)throw new Error("Cannot transform operations: first operation is too short.");if(void 0===u)throw new Error("Cannot transform operations: first operation is too long.");var l;if(c.isRetain()&&u.isRetain()){var p=n.transformAttributes(c.attributes,u.attributes);c.chars>u.chars?(l=u.chars,c.chars-=u.chars,u=s[h++]):c.chars===u.chars?(l=u.chars,c=o[a++],u=s[h++]):(l=c.chars,u.chars-=c.chars,c=o[a++]),r.retain(l,p[0]),i.retain(l,p[1])}else if(c.isDelete()&&u.isDelete())c.chars>u.chars?(c.chars-=u.chars,u=s[h++]):c.chars===u.chars?(c=o[a++],u=s[h++]):(u.chars-=c.chars,c=o[a++]);else if(c.isDelete()&&u.isRetain())c.chars>u.chars?(l=u.chars,c.chars-=u.chars,u=s[h++]):c.chars===u.chars?(l=u.chars,c=o[a++],u=s[h++]):(l=c.chars,u.chars-=c.chars,c=o[a++]),r.delete(l);else{if(!c.isRetain()||!u.isDelete())throw new Error("The two operations aren't compatible");c.chars>u.chars?(l=u.chars,c.chars-=u.chars,u=s[h++]):c.chars===u.chars?(l=c.chars,c=o[a++],u=s[h++]):(l=c.chars,u.chars-=c.chars,c=o[a++]),i.delete(l)}}
+
+return[r,i]},n.prototype.transform=function(t){
+    log1("new: " + JSON.stringify(t));
+    log1("currnet: " + JSON.stringify(this));
+    return n.transform(this,t)
+},n}(),(r=r||{}).AnnotationList=function(){var t=r.Span;function e(t,e){if(!t)throw new Error("AnnotationList assertion failed"+(e?": "+e:""))}function n(t,e){this.pos=t,this.length=e.length,this.annotation=e.annotation,this.attachedObject_=e.attachedObject}function i(t,e){this.pos=t,this.length=e.length,this.annotation=e.annotation,this.node_=e}n.prototype.getAttachedObject=function(){return this.attachedObject_},i.prototype.attachObject=function(t){this.node_.attachedObject=t};var o={equals:function(){return!1}};function s(t){this.head_=new a(0,o),this.changeHandler_=t}function a(t,e){this.length=t,this.annotation=e,this.attachedObject=null,this.next=null}return s.prototype.insertAnnotatedSpan=function(r,n){this.wrapOperation_(new t(r.pos,0),function(t,i){e(!i||null===i.next);var s=new a(r.length,n);if(i){e(r.pos>t&&r.pos<t+i.length);var h=new a(0,o);return h.next=new a(r.pos-t,i.annotation),h.next.next=s,s.next=new a(t+i.length-r.pos,i.annotation),h.next}return s})},s.prototype.removeSpan=function(t){0!==t.length&&this.wrapOperation_(t,function(r,n){e(null!==n);var i=new a(0,o),s=i;for(t.pos>r&&(s.next=new a(t.pos-r,n.annotation),s=s.next);t.end()>r+n.length;)r+=n.length,n=n.next;var h=r+n.length-t.end();return h>0&&(s.next=new a(h,n.annotation)),i.next})},s.prototype.updateSpan=function(t,r){0!==t.length&&this.wrapOperation_(t,function(n,i){e(null!==i);var s=new a(0,o),h=s,c=n,u=t.pos-c;for(e(u<i.length),u>0&&(h.next=new a(u,i.annotation),c+=(h=h.next).length);null!==i&&t.end()>=n+i.length;){var l=n+i.length-c;h.next=new a(l,r(i.annotation,l)),h=h.next,n+=i.length,i=i.next,c=n}var p=t.end()-c;return p>0&&(e(p<i.length),h.next=new a(p,r(i.annotation,p)),c+=(h=h.next).length,h.next=new a(n+i.length-c,i.annotation)),s.next})},s.prototype.wrapOperation_=function(t,e){if(t.pos<0)throw new Error("Span start cannot be negative.");var r,o=[],s=[],h=this.getAffectedNodes_(t);null!==h.start?(r=h.end.next,h.end.next=null):r=h.succ;var c=e(h.startPos,h.start),u=!1,l=!1;if(c){var p;for(this.mergeNodesWithSameAnnotations_(c),h.pred&&h.pred.annotation.equals(c.annotation)?(u=!0,c.length+=h.pred.length,h.beforePred.next=c,p=h.predPos):(h.beforeStart.next=c,p=h.startPos);c.next;)s.push(new i(p,c)),p+=c.length,c=c.next;h.succ&&h.succ.annotation.equals(c.annotation)?(c.length+=h.succ.length,l=!0,c.next=h.succ.next):c.next=r,s.push(new i(p,c))}else h.pred&&h.succ&&h.pred.annotation.equals(h.succ.annotation)?(u=!0,l=!0,c=new a(h.pred.length+h.succ.length,h.pred.annotation),h.beforePred.next=c,c.next=h.succ.next,s.push(new i(h.startPos-h.pred.length,c))):h.beforeStart.next=r;u&&o.push(new n(h.predPos,h.pred));for(var d=h.startPos,f=h.start;null!==f;)o.push(new n(d,f)),d+=f.length,f=f.next;l&&o.push(new n(d,h.succ)),this.changeHandler_(o,s)},s.prototype.getAffectedNodes_=function(t){for(var e={},r=null,n=this.head_,i=n.next,o=0;null!==i&&t.pos>=o+i.length;)o+=i.length,r=n,n=i,i=i.next;if(null===i&&(0!==t.length||t.pos!==o))throw new Error("Span start exceeds the bounds of the AnnotationList.");for(e.startPos=o,0===t.length&&t.pos===o?e.start=null:e.start=i,e.beforeStart=n,o===t.pos&&o>0?(e.pred=n,e.predPos=o-n.length,e.beforePred=r):e.pred=null;null!==i&&t.end()>o;)o+=i.length,n=i,i=i.next;if(t.end()>o)throw new Error("Span end exceeds the bounds of the AnnotationList.");return 0===t.length&&t.end()===o?e.end=null:e.end=n,e.succ=o===t.end()?i:null,e},s.prototype.mergeNodesWithSameAnnotations_=function(t){if(t)for(var e=null,r=t;r;)e&&e.annotation.equals(r.annotation)?(e.length+=r.length,e.next=r.next):e=r,r=r.next},s.prototype.forEach=function(t){for(var e=this.head_.next;null!==e;)t(e.length,e.annotation,e.attachedObject),e=e.next},s.prototype.getAnnotatedSpansForPos=function(t){for(var e=0,r=this.head_.next,i=null;null!==r&&e+r.length<=t;)e+=r.length,i=r,r=r.next;if(null===r&&e!==t)throw new Error("pos exceeds the bounds of the AnnotationList");var o=[];return e===t&&i&&o.push(new n(e-i.length,i)),r&&o.push(new n(e,r)),o},s.prototype.getAnnotatedSpansForSpan=function(e){if(0===e.length)return[];for(var r=[],n=this.getAffectedNodes_(e),i=n.startPos,o=n.start;null!==o&&i<e.end();){var s=Math.max(i,e.pos),a=Math.min(i+o.length,e.end()),h=new t(s,a-s);h.annotation=o.annotation,r.push(h),i+=o.length,o=o.next}return r},s.prototype.count=function(){for(var t=0,r=this.head_.next,n=null;null!==r;)n&&e(!n.annotation.equals(r.annotation)),n=r,r=r.next,t++;return t},a.prototype.clone=function(){var t=new a(this.spanLength,this.annotation);return t.next=this.next,t},s}(),(r=r||{}).Cursor=function(){"use strict";function t(t,e){this.position=t,this.selectionEnd=e}return t.fromJSON=function(e){return new t(e.position,e.selectionEnd)},t.prototype.equals=function(t){return this.position===t.position&&this.selectionEnd===t.selectionEnd},t.prototype.compose=function(t){return t},t.prototype.transform=function(e){function r(t){for(var r=t,n=e.ops,i=0,o=e.ops.length;i<o&&(n[i].isRetain()?t-=n[i].chars:n[i].isInsert()?r+=n[i].text.length:(r-=Math.min(t,n[i].chars),t-=n[i].chars),!(t<0));i++);return r}var n=r(this.position);return this.position===this.selectionEnd?new t(n,n):new t(n,r(this.selectionEnd))},t}(),(r=r||{}).FirebaseAdapter=function(t){"undefined"==typeof firebase&&"function"==typeof require&&"function"!=typeof Firebase&&(firebase=require("firebase"));var e=r.TextOperation,n=r.utils;function i(t,r,n,/*wb+*/dataref,usrref/*+wb*/){this.ref_=t,/*wb+*/this.dataref_=dataref,this.usrref_=usrref,/*+wb*/this.ready_=!1,this.firebaseCallbacks_=[],this.zombie_=!1,this.document_=new e,this.revision_=0,this.pendingReceivedRevisions_={};var i=this;if(r){this.setUserId(r),this.setColor(n);var o=t.root.child(".info/connected");this.firebaseOn_(o,"value",function(t){!0===t.val()&&i.initializeUserData_()},this),this.on("ready",function(){i.monitorCursors_()})}else this.userId_=t.push().key;setTimeout(function(){i.monitorHistory_()},0)}function o(t,e){if(!t)throw new Error(e||"assertion error")}n.makeEventEmitter(i,["ready","cursor","operation","ack","retry"]),i.prototype.dispose=function(){var t=this;this.ready_?(this.removeFirebaseCallbacks_(),this.userRef_&&(this.userRef_.child("cursor").remove(),this.userRef_.child("color").remove()),this.ref_=null,this.document_=null,this.zombie_=!0):this.on("ready",function(){t.dispose()})},i.prototype.setUserId=function(t){this.userRef_&&(this.userRef_.child("cursor").remove(),this.userRef_.child("cursor").onDisconnect().cancel(),this.userRef_.child("color").remove(),this.userRef_.child("color").onDisconnect().cancel()),this.userId_=t,this.userRef_=this.ref_.child("users").child(t),this.initializeUserData_()},i.prototype.isHistoryEmpty=function(){return o(this.ready_,"Not ready yet."),0===this.revision_},i.prototype.sendOperation=function(t,e){var r=this;if(this.ready_){log1('check: '+this.document_.targetLength + ' ' + t.baseLength),o(this.document_.targetLength===t.baseLength,"sendOperation() called with invalid operation.");var i=a(this.revision_);this.sent_={id:i,op:t},function t(i,o){log1(i+' ' +JSON.stringify(o));r.ref_.child("history").child(i).transaction(function(t){if(null===t)return o},function(s,a,h){if(s){if("disconnect"!==s.message)throw n.log("Transaction failure!",s),s;r.sent_&&r.sent_.id===i?setTimeout(function(){t(i,o)},0):e&&e(s,!1)}else /*wb+*/log1(r.dataref_.toString()),r.dataref_.set(2),/*+wb*/e&&e(null,a)},!1)}(i,{a:r.userId_,o:t.toJSON(),t:firebase.database.ServerValue.TIMESTAMP})}else this.on("ready",function(){r.trigger("retry")})},
+i.prototype.sendCursor=function(t){
+    this.userRef_.child("cursor").set(t),
+this.cursor_=t},
+i.prototype.sendCursorLC=function(t){
+this.usrref_.child("cursor").set(t)},
+i.prototype.setColor=function(t){this.userRef_.child("color").set(t),
+this.usrref_.child("color").set(t),
+this.color_=t},i.prototype.getDocument=function(){return this.document_},i.prototype.registerCallbacks=function(t){for(var e in t)this.on(e,t[e])},i.prototype.initializeUserData_=function(){this.userRef_.child("cursor").onDisconnect().remove(),this.userRef_.child("color").onDisconnect().remove(),this.sendCursor(this.cursor_||null),this.setColor(this.color_||null)},i.prototype.monitorCursors_=function(){var t=this.ref_.child("users"),e=this;function r(t){var r=t.key,n=t.val();e.trigger("cursor",r,n.cursor,n.color)}this.firebaseOn_(t,"child_added",r),this.firebaseOn_(t,"child_changed",r),this.firebaseOn_(t,"child_removed",function(t){var r=t.key;e.trigger("cursor",r,null)})},i.prototype.monitorHistory_=function(){var t=this;this.ref_.child("checkpoint").once("value",function(e){if(!t.zombie_){var r=e.child("id").val(),n=e.child("o").val(),i=e.child("a").val();null!=n&&null!=r&&null!==i?(t.pendingReceivedRevisions_[r]={o:n,a:i},t.checkpointRevision_=function(t){o(t.length>0&&t[0]===s[t.length+8]);for(var e=0,r=1;r<t.length;r++)e*=s.length,e+=s.indexOf(t[r]);return e}(r),t.monitorHistoryStartingAt_(t.checkpointRevision_+1)):(t.checkpointRevision_=0,t.monitorHistoryStartingAt_(t.checkpointRevision_))}})},i.prototype.monitorHistoryStartingAt_=function(t){var e=this.ref_.child("history").startAt(null,a(t)),r=this;setTimeout(function(){r.firebaseOn_(e,"child_added",function(t){var e=t.key;r.pendingReceivedRevisions_[e]=t.val(),r.ready_&&r.handlePendingReceivedRevisions_()}),e.once("value",function(){r.handleInitialRevisions_()})},0)},i.prototype.handleInitialRevisions_=function(){o(!this.ready_,"Should not be called multiple times."),this.revision_=this.checkpointRevision_;for(var t=a(this.revision_),e=this.pendingReceivedRevisions_;null!=e[t];){var r=this.parseRevision_(e[t]);r?this.document_=this.document_.compose(r.operation):n.log("Invalid operation.",this.ref_.toString(),t,e[t]),delete e[t],this.revision_++,t=a(this.revision_)}this.trigger("operation",this.document_),this.ready_=!0;var i=this;setTimeout(function(){i.trigger("ready")},0)},i.prototype.handlePendingReceivedRevisions_=function(){for(var t=this.pendingReceivedRevisions_,e=a(this.revision_),r=!1;null!=t[e];){this.revision_++;var i=this.parseRevision_(t[e]);i?(this.document_=this.document_.compose(i.operation),this.sent_&&e===this.sent_.id?this.sent_.op.equals(i.operation)&&i.author===this.userId_?(this.revision_%100==0&&this.saveCheckpoint_(),this.sent_=null,this.trigger("ack")):(log1('compare: '),log1(JSON.stringify(this.sent_)),log1(JSON.stringify(i)),r=!0,this.trigger("operation",i.operation)):this.trigger("operation",i.operation)):n.log("Invalid operation.",this.ref_.toString(),e,t[e]),delete t[e],e=a(this.revision_)}r&&(this.sent_=null,this.trigger("retry"))},i.prototype.parseRevision_=function(t){if("object"!=typeof t)return null;if("string"!=typeof t.a||"object"!=typeof t.o)return null;var r=null;try{r=e.fromJSON(t.o/*wb+*/,this.document_.targetLength/*+wb*/)}catch(t){return null}return r.baseLength!==this.document_.targetLength?null:{author:t.a,operation:r}},i.prototype.saveCheckpoint_=function(){this.ref_.child("checkpoint").set({a:this.userId_,o:this.document_.toJSON(),id:a(this.revision_-1)})},i.prototype.firebaseOn_=function(t,e,r,n){return this.firebaseCallbacks_.push({ref:t,eventType:e,callback:r,context:n}),t.on(e,r,n),r},i.prototype.firebaseOff_=function(t,e,r,n){t.off(e,r,n);for(var i=0;i<this.firebaseCallbacks_.length;i++){var o=this.firebaseCallbacks_[i];if(o.ref===t&&o.eventType===e&&o.callback===r&&o.context===n){this.firebaseCallbacks_.splice(i,1);break}}},i.prototype.removeFirebaseCallbacks_=function(){for(var t=0;t<this.firebaseCallbacks_.length;t++){var e=this.firebaseCallbacks_[t];e.ref.off(e.eventType,e.callback,e.context)}this.firebaseCallbacks_=[]};var s="0123456789ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz";function a(t){if(0===t)return"A0";for(var e="";t>0;){var r=t%s.length;e=s[r]+e,t-=r,t/=s.length}return s[e.length+9]+e}return i}(),(r=r||{}).RichTextToolbar=function(t){var e=r.utils;function n(t){this.imageInsertionUI=t,this.element_=this.makeElement_()}return e.makeEventEmitter(n,["bold","italic","underline","strike","font","font-size","color","left","center","right","unordered-list","ordered-list","todo-list","indent-increase","indent-decrease","undo","redo","insert-image"]),n.prototype.element=function(){return this.element_},n.prototype.makeButton_=function(t,r){var n=this;r=r||t;var i=e.elt("a",[e.elt("span","",{class:"firepad-tb-"+r})],{class:"firepad-btn"});return e.on(i,"click",e.stopEventAnd(function(){n.trigger(t)})),i},n.prototype.makeElement_=function(){var t=this.makeFontDropdown_(),r=this.makeFontSizeDropdown_(),n=this.makeColorDropdown_(),i=[e.elt("div",[t],{class:"firepad-btn-group"}),e.elt("div",[r],{class:"firepad-btn-group"}),e.elt("div",[n],{class:"firepad-btn-group"}),e.elt("div",[this.makeButton_("bold"),this.makeButton_("italic"),this.makeButton_("underline"),this.makeButton_("strike","strikethrough")],{class:"firepad-btn-group"}),e.elt("div",[this.makeButton_("unordered-list","list-2"),this.makeButton_("ordered-list","numbered-list"),this.makeButton_("todo-list","list")],{class:"firepad-btn-group"}),e.elt("div",[this.makeButton_("indent-decrease"),this.makeButton_("indent-increase")],{class:"firepad-btn-group"}),e.elt("div",[this.makeButton_("left","paragraph-left"),this.makeButton_("center","paragraph-center"),this.makeButton_("right","paragraph-right")],{class:"firepad-btn-group"}),e.elt("div",[this.makeButton_("undo"),this.makeButton_("redo")],{class:"firepad-btn-group"})];this.imageInsertionUI&&i.push(e.elt("div",[this.makeButton_("insert-image")],{class:"firepad-btn-group"}));var o=e.elt("div",i,{class:"firepad-toolbar-wrapper"}),s=e.elt("div",null,{class:"firepad-toolbar"});return s.appendChild(o),s},n.prototype.makeFontDropdown_=function(){for(var t=["Arial","Comic Sans MS","Courier New","Impact","Times New Roman","Verdana"],r=[],n=0;n<t.length;n++){var i=e.elt("span",t[n]);i.setAttribute("style","font-family:"+t[n]),r.push({content:i,value:t[n]})}return this.makeDropdown_("Font","font",r)},n.prototype.makeFontSizeDropdown_=function(){for(var t=[9,10,12,14,18,24,32,42],r=[],n=0;n<t.length;n++){var i=e.elt("span",t[n].toString());i.setAttribute("style","font-size:"+t[n]+"px; line-height:"+(t[n]-6)+"px;"),r.push({content:i,value:t[n]})}return this.makeDropdown_("Size","font-size",r,"px")},n.prototype.makeColorDropdown_=function(){for(var t=["black","red","green","blue","yellow","cyan","magenta","grey"],r=[],n=0;n<t.length;n++){var i=e.elt("div");i.className="firepad-color-dropdown-item",i.setAttribute("style","background-color:"+t[n]),r.push({content:i,value:t[n]})}return this.makeDropdown_("Color","color",r)},n.prototype.makeDropdown_=function(t,r,n,i){i=i||"";var o=this,s=e.elt("a",t+" ▾",{class:"firepad-btn firepad-dropdown"}),a=e.elt("ul",[],{class:"firepad-dropdown-menu"});s.appendChild(a);var h=!1;var c=!1;function u(){h&&(a.style.display="",e.off(document,"click",u,!0),h=!1),c=!0,setTimeout(function(){c=!1},0)}function l(t,n){"object"!=typeof t&&(t=document.createTextNode(String(t)));var s=e.elt("a",[t]);e.on(s,"click",e.stopEventAnd(function(){u(),o.trigger(r,n+i)})),a.appendChild(s)}for(var p=0;p<n.length;p++){l(n[p].content,n[p].value)}return e.on(s,"click",e.stopEventAnd(function(){c||h||(a.style.display="block",e.on(document,"click",u,!0),h=!0)})),s},n}(),(r=r||{}).WrappedOperation=function(t){"use strict";function e(t,e){this.wrapped=t,this.meta=e;}function r(t,e){for(var r in t)t.hasOwnProperty(r)&&(e[r]=t[r])}function n(t,e){return t&&"object"==typeof t&&"function"==typeof t.transform?t.transform(e):t}return e.prototype.apply=function(){return this.wrapped.apply.apply(this.wrapped,arguments)},e.prototype.invert=function(){var t=this.meta;return new e(this.wrapped.invert.apply(this.wrapped,arguments),t&&"object"==typeof t&&"function"==typeof t.invert?t.invert.apply(t,arguments):t)},e.prototype.compose=function(t){return new e(this.wrapped.compose(t.wrapped),function(t,e){if(t&&"object"==typeof t){if("function"==typeof t.compose)return t.compose(e);var n={};return r(t,n),r(e,n),n}return e}(this.meta,t.meta))},e.transform=function(t,r){var i=t.wrapped.transform(r.wrapped);return[new e(i[0],n(t.meta,r.wrapped)),new e(i[1],n(r.meta,t.wrapped))]},e.prototype.transform=function(t){return e.transform(this,t)},e}(),(r=r||{}).UndoManager=function(){"use strict";var t="normal";function e(e){this.maxItems=e||50,this.state=t,this.dontCompose=!1,this.undoStack=[],this.redoStack=[]}function r(t,e){for(var r=[],n=e.constructor,i=t.length-1;i>=0;i--){var o=n.transform(t[i],e);"function"==typeof o[0].isNoop&&o[0].isNoop()||r.push(o[0]),e=o[1]}return r.reverse()}return e.prototype.add=function(t,e){if("undoing"===this.state)this.redoStack.push(t),this.dontCompose=!0;else if("redoing"===this.state)this.undoStack.push(t),this.dontCompose=!0;else{var r=this.undoStack;!this.dontCompose&&e&&r.length>0?r.push(t.compose(r.pop())):(r.push(t),r.length>this.maxItems&&r.shift()),this.dontCompose=!1,this.redoStack=[]}},e.prototype.transform=function(t){this.undoStack=r(this.undoStack,t),this.redoStack=r(this.redoStack,t)},e.prototype.performUndo=function(e){if(this.state="undoing",0===this.undoStack.length)throw new Error("undo not possible");e(this.undoStack.pop()),this.state=t},e.prototype.performRedo=function(e){if(this.state="redoing",0===this.redoStack.length)throw new Error("redo not possible");e(this.redoStack.pop()),this.state=t},e.prototype.canUndo=function(){return 0!==this.undoStack.length},e.prototype.canRedo=function(){return 0!==this.redoStack.length},e.prototype.isUndoing=function(){return"undoing"===this.state},e.prototype.isRedoing=function(){return"redoing"===this.state},e}(),(r=r||{}).Client=function(){"use strict";function t(){this.state=r}function e(){}t.prototype.setState=function(t){this.state=t},t.prototype.applyClient=function(t){this.setState(this.state.applyClient(this,t))},t.prototype.applyServer=function(t){this.setState(this.state.applyServer(this,t))},t.prototype.serverAck=function(){this.setState(this.state.serverAck(this))},t.prototype.serverRetry=function(){this.setState(this.state.serverRetry(this))},t.prototype.sendOperation=function(t){throw new Error("sendOperation must be defined in child class")},t.prototype.applyOperation=function(t){throw new Error("applyOperation must be defined in child class")},t.Synchronized=e,e.prototype.applyClient=function(t,e){log1("apply client");return t.sendOperation(e),new n(e)},e.prototype.applyServer=function(t,e){return t.applyOperation(e),this},e.prototype.serverAck=function(t){throw new Error("There is no pending operation.")},e.prototype.serverRetry=function(t){throw new Error("There is no pending operation.")};var r=new e;function n(t){this.outstanding=t}function i(t,e){this.outstanding=t,this.buffer=e}return t.AwaitingConfirm=n,n.prototype.applyClient=function(t,e){return new i(this.outstanding,e)},n.prototype.applyServer=function(t,e){var r=this.outstanding.transform(e);return t.applyOperation(r[1]),new n(r[0])},n.prototype.serverAck=function(t){return r},n.prototype.serverRetry=function(t){return t.sendOperation(this.outstanding),this},t.AwaitingWithBuffer=i,i.prototype.applyClient=function(t,e){var r=this.buffer.compose(e);return new i(this.outstanding,r)},i.prototype.applyServer=function(t,e){var r=this.outstanding.transform(e),n=this.buffer.transform(r[1]);return t.applyOperation(n[1]),new i(r[0],n[0])},i.prototype.serverRetry=function(t){var e=this.outstanding.compose(this.buffer);return t.sendOperation(e),new n(e)},i.prototype.serverAck=function(t){return t.sendOperation(this.buffer),new n(this.buffer)},t}(),(r=r||{}).EditorClient=function(){"use strict";var t=r.Client,e=r.Cursor,n=r.UndoManager,i=r.WrappedOperation;function o(t,e){this.cursorBefore=t,this.cursorAfter=e}function s(t,e){this.id=t,this.editorAdapter=e}function a(r,i){t.call(this),this.serverAdapter=r,this.editorAdapter=i,this.undoManager=new n,this.clients={};var o=this;this.editorAdapter.registerCallbacks({change:function(t,e){log1("apply client change"),o.onChange(t,e)},cursorActivity:function(){o.onCursorActivity()},blur:function(){o.onBlur()},focus:function(){o.onFocus()}}),this.editorAdapter.registerUndo(function(){o.undo()}),this.editorAdapter.registerRedo(function(){o.redo()}),this.serverAdapter.registerCallbacks({ack:function(){o.serverAck(),o.focused&&o.state instanceof t.Synchronized&&(o.updateCursor(),o.sendCursor(o.cursor)),o.emitStatus()},retry:function(){o.serverRetry()},operation:function(t){log1('op');o.applyServer(t)},cursor:function(r,n,i){if(o.serverAdapter.userId_!==r&&o.state instanceof t.Synchronized){var s=o.getClientObject(r);n?(i&&s.setColor(i),s.updateCursor(e.fromJSON(n))):s.removeCursor()}}})}return o.prototype.invert=function(){return new o(this.cursorAfter,this.cursorBefore)},o.prototype.compose=function(t){return new o(this.cursorBefore,t.cursorAfter)},o.prototype.transform=function(t){return new o(this.cursorBefore?this.cursorBefore.transform(t):null,this.cursorAfter?this.cursorAfter.transform(t):null)},s.prototype.setColor=function(t){this.color=t},s.prototype.updateCursor=function(t){this.removeCursor(),this.cursor=t,this.mark=this.editorAdapter.setOtherCursor(t,this.color,this.id)},s.prototype.removeCursor=function(){this.mark&&this.mark.clear()},function(t,e){function r(){}r.prototype=e.prototype,t.prototype=new r,t.prototype.constructor=t}(a,t),a.prototype.getClientObject=function(t){var e=this.clients[t];return e||(this.clients[t]=new s(t,this.editorAdapter))},a.prototype.applyUnredo=function(t){this.undoManager.add(this.editorAdapter.invertOperation(t)),this.editorAdapter.applyOperation(t.wrapped),this.cursor=t.meta.cursorAfter,this.cursor&&this.editorAdapter.setCursor(this.cursor),this.applyClient(t.wrapped)},a.prototype.undo=function(){var t=this;this.undoManager.canUndo()&&this.undoManager.performUndo(function(e){t.applyUnredo(e)})},a.prototype.redo=function(){var t=this;this.undoManager.canRedo()&&this.undoManager.performRedo(function(e){t.applyUnredo(e)})},a.prototype.onChange=function(t,e){var r=this.cursor;this.updateCursor();var n,s=this.undoManager.undoStack.length>0&&e.shouldBeComposedWithInverted((n=this.undoManager.undoStack,n[n.length-1]).wrapped),a=new o(this.cursor,r);this.undoManager.add(new i(e,a),s),this.applyClient(t)},a.prototype.updateCursor=function(){this.cursor=this.editorAdapter.getCursor()},
+
+a.prototype.onCursorActivity=function(){var t=this.cursor;this.updateCursor(),
+!this.focused||t&&this.cursor.equals(t)||this.sendCursor(this.cursor)},
+
+a.prototype.onBlur=function(){this.cursor=null,this.sendCursor(null),this.focused=!1},a.prototype.onFocus=function(){this.focused=!0,this.onCursorActivity()},
+a.prototype.sendCursor=function(e){this.state instanceof t.AwaitingWithBuffer||(this.serverAdapter.sendCursor(e),this.serverAdapter.sendCursorLC(this.editorAdapter.getCursorLC(e)))},
+a.prototype.sendOperation=function(t){this.serverAdapter.sendOperation(t),this.emitStatus()},a.prototype.applyOperation=function(t){this.editorAdapter.applyOperation(t),this.updateCursor(),this.undoManager.transform(new i(t,null))},a.prototype.emitStatus=function(){var e=this;setTimeout(function(){e.trigger("synced",e.state instanceof t.Synchronized)},0)},a}(),r.utils.makeEventEmitter(r.EditorClient,["synced"]),void 0!==r&&null!==r||(r={}),r.ACEAdapter=function(){var n=function(){function n(t){var e;!function(t,e){if(!(t instanceof e))throw new TypeError("Cannot call a class as a function")}(this,n),this.onChange=this.onChange.bind(this),this.onBlur=this.onBlur.bind(this),this.onFocus=this.onFocus.bind(this),this.onCursorActivity=this.onCursorActivity.bind(this),this.ace=t,this.aceSession=this.ace.getSession(),this.aceDoc=this.aceSession.getDocument(),this.aceDoc.setNewLineMode("unix"),this.grabDocumentState(),this.ace.on("change",this.onChange),this.ace.on("blur",this.onBlur),this.ace.on("focus",this.onFocus),this.aceSession.selection.on("changeCursor",this.onCursorActivity),null==this.aceRange&&(this.aceRange=(null!=(e=ace.require)?e:require)("ace/range").Range)}var i,o,s;return i=n,(o=[{key:"grabDocumentState",value:function(){return this.lastDocLines=this.aceDoc.getAllLines(),this.lastCursorRange=this.aceSession.selection.getRange()}},{key:"detach",value:function(){return this.ace.removeListener("change",this.onChange),this.ace.removeListener("blur",this.onBlur),this.ace.removeListener("focus",this.onFocus),this.aceSession.selection.removeListener("changeCursor",this.onCursorActivity)}},{key:"onChange",value:function(e){var r;if(!this.ignoreChanges)return r=this.operationFromACEChange(e),this.trigger.apply(this,["change"].concat(t(r))),this.grabDocumentState()}},{key:"onBlur",value:function(){if(this.ace.selection.isEmpty())return this.trigger("blur")}},{key:"onFocus",value:function(){return this.trigger("focus")}},{key:"onCursorActivity",value:function(){var t=this;return setTimeout(function(){return t.trigger("cursorActivity")},0)}},{key:"operationFromACEChange",value:function(t){var e,n,i,o,s,a,h;return t.data?("insertLines"===(o=(n=t.data).action)||"removeLines"===o?(h=n.lines.join("\n")+"\n",n.action.replace("Lines","")):(h=n.text.replace(this.aceDoc.getNewLineCharacter(),"\n"),n.action.replace("Text","")),a=this.indexFromPos(n.range.start)):(h=t.lines.join("\n"),a=this.indexFromPos(t.start)),s=this.lastDocLines.join("\n").length-a,"remove"===t.action&&(s-=h.length),i=(new r.TextOperation).retain(a).insert(h).retain(s),e=(new r.TextOperation).retain(a).delete(h).retain(s),"remove"===t.action?[e,i]:[i,e]}},{key:"applyOperationToACE",value:function(t){var e,r,n,i,o,s,a,h;for(r=0,n=0,i=(a=t.ops).length;n<i;n++)(o=a[n]).isRetain()?r+=o.chars:o.isInsert()?(this.aceDoc.insert(this.posFromIndex(r),o.text),r+=o.text.length):o.isDelete()&&(e=this.posFromIndex(r),h=this.posFromIndex(r+o.chars),s=this.aceRange.fromPoints(e,h),this.aceDoc.remove(s));return this.grabDocumentState()}},{key:"posFromIndex",value:function(t){var e,r,n,i,o;for(o=e=0,r=(i=this.aceDoc.$lines).length;e<r&&!(t<=(n=i[o]).length);o=++e)t-=n.length+1;return{row:o,column:t}}},{key:"indexFromPos",value:function(t,e){var r,n,i,o;for(null==e&&(e=this.lastDocLines),n=0,r=i=0,o=t.row;0<=o?i<o:i>o;r=0<=o?++i:--i)n+=this.lastDocLines[r].length+1;return n+t.column}},{key:"getValue",value:function(){return this.aceDoc.getValue()}},{key:"getCursor",value:function(){var t,e,n;try{n=this.indexFromPos(this.aceSession.selection.getRange().start,this.aceDoc.$lines),e=this.indexFromPos(this.aceSession.selection.getRange().end,this.aceDoc.$lines)}catch(r){r;try{n=this.indexFromPos(this.lastCursorRange.start),e=this.indexFromPos(this.lastCursorRange.end)}catch(r){t=r,console.log("Couldn't figure out the cursor range:",t,"-- setting it to 0:0."),n=0,e=0}}if(n>e){var i=[e,n];n=i[0],e=i[1]}return new r.Cursor(n,e)}},{key:"setCursor",value:function(t){var e,r;if(r=this.posFromIndex(t.position),e=this.posFromIndex(t.selectionEnd),t.position>t.selectionEnd){var n=[e,r];r=n[0],e=n[1]}return this.aceSession.selection.setSelectionRange(new this.aceRange(r.row,r.column,e.row,e.column))}},{key:"setOtherCursor",value:function(t,e,r){var n,i,o,s,a,h,c,u=this;if(null==this.otherCursors&&(this.otherCursors={}),(o=this.otherCursors[r])&&(o.start.detach(),o.end.detach(),this.aceSession.removeMarker(o.id)),c=this.posFromIndex(t.position),s=this.posFromIndex(t.selectionEnd),t.selectionEnd<t.position){var l=[s,c];c=l[0],s=l[1]}return n="other-client-selection-".concat(e.replace("#","")),(a=t.position===t.selectionEnd)&&(n=n.replace("selection","cursor")),i=".".concat(n," {\n  position: absolute;\n  background-color: ").concat(a?"transparent":e,";\n  border-left: 2px solid ").concat(e,";\n}"),this.addStyleRule(i),this.otherCursors[r]=o=new this.aceRange(c.row,c.column,s.row,s.column),h=this,o.clipRows=function(){var t;return(t=h.aceRange.prototype.clipRows.apply(this,arguments)).isEmpty=function(){return!1},t},o.start=this.aceDoc.createAnchor(o.start),o.end=this.aceDoc.createAnchor(o.end),o.id=this.aceSession.addMarker(o,n,"text"),{clear:function(){return o.start.detach(),o.end.detach(),u.aceSession.removeMarker(o.id)}}}},{key:"addStyleRule",value:function(t){var e;if("undefined"!=typeof document&&null!==document&&(this.addedStyleRules||(this.addedStyleRules={},e=document.createElement("style"),document.documentElement.getElementsByTagName("head")[0].appendChild(e),this.addedStyleSheet=e.sheet),!this.addedStyleRules[t]))return this.addedStyleRules[t]=!0,this.addedStyleSheet.insertRule(t,0)}},{key:"registerCallbacks",value:function(t){this.callbacks=t}},{key:"trigger",value:function(t){for(var e,r,n=arguments.length,i=new Array(n>1?n-1:0),o=1;o<n;o++)i[o-1]=arguments[o];return null!=(e=this.callbacks)&&null!=(r=e[t])?r.apply(this,i):void 0}},{key:"applyOperation",value:function(t){return t.isNoop()||(this.ignoreChanges=!0),this.applyOperationToACE(t),this.ignoreChanges=!1}},{key:"registerUndo",value:function(t){return this.ace.undo=t}},{key:"registerRedo",value:function(t){return this.ace.redo=t}},{key:"invertOperation",value:function(t){return t.invert(this.getValue())}}])&&e(i.prototype,o),s&&e(i,s),n}();return n.prototype.ignoreChanges=!1,n}.call(void 0);var r,n=function(t,e,r){return"."+t+" {\n  position: relative;\nbackground-color: "+e+";\nborder-left: 2px solid "+r+";\n}"},i=function(t,e){if("undefined"==typeof document||null===document)return!1;if(-1===this.addedStyleRules.indexOf(t)){var r=document.createElement("style"),n=document.createTextNode(e);r.appendChild(n),document.head.appendChild(r),this.addedStyleRules.push(t)}},
+
+o=function(){
+function t(t) {
+    if (null !== t && "undefined" != typeof global && global.monaco && !t instanceof global.monaco) throw new Error("MonacoAdapter: Incorrect Parameter Recieved in constructor, expected valid Monaco Instance");
+    this.monaco = t,
+    this.monacoModel = this.monaco.getModel(),
+    this.lastDocLines = this.monacoModel.getLinesContent(),
+    this.lastCursorRange = this.monaco.getSelection(),
+    this.callbacks = {}, this.otherCursors = [],
+    this.addedStyleRules = [],
+    this.ignoreChanges = !1,
+    /*wb+*/this.no_edits=false;/*+wb*/
+    this.onChange = this.onChange.bind(this),
+    this.onBlur = this.onBlur.bind(this),
+    this.onFocus = this.onFocus.bind(this),
+    this.onCursorActivity = this.onCursorActivity.bind(this),
+    this.changeHandler = this.monacoModel.onDidChangeContent(this.onChange),
+    //this.changeHandler = this.monaco.onDidChangeModelContent(this.onChange),
+    this.didBlurHandler = this.monaco.onDidBlurEditorWidget(this.onBlur),
+    this.didFocusHandler = this.monaco.onDidFocusEditorWidget(this.onFocus),
+    this.didChangeCursorPositionHandler = this.monaco.onDidChangeCursorPosition(this.onCursorActivity)
+}
+return t.prototype.detach = function () {
+        //this.changeHandler.dispose(),
+        this.didBlurHandler.dispose(),
+        this.didFocusHandler.dispose(),
+        this.didChangeCursorPositionHandler.dispose()
+    },
+    t.prototype.reattach = function () {
+    //this.changeHandler = this.monaco.onDidChangeModelContent(this.onChange),
+    //this.changeHandler = this.modelData.onDidChangeModelContent(this.onChange),
+    this.didBlurHandler = this.monaco.onDidBlurEditorWidget(this.onBlur),
+    this.didFocusHandler = this.monaco.onDidFocusEditorWidget(this.onFocus),
+    this.didChangeCursorPositionHandler = this.monaco.onDidChangeCursorPosition(this.onCursorActivity)
+    },
+    /*wb+*/
+    t.prototype.setNoEdits = function (t) {
+        this.no_edits = (t?true:false);
+    },
+    t.prototype.getNoEdits = function () {
+        return this.no_edits;
+    },
+    /*+wb*/
+    t.prototype.getCursor = function () {
+        var t = this.monaco.getSelection();
+        void 0 !== t && null !== t || (t = this.lastCursorRange);
+        var e = t.getStartPosition(), n = t.getEndPosition(),
+        i = this.monacoModel.getOffsetAt(e),
+        o = this.monacoModel.getOffsetAt(n);
+        if (i > o) { var s = [o, i]; i = s[0], o = s[1] }
+            return new r.Cursor(i, o)
+    },
+    t.prototype.getCursorLC = function(t){
+        if(!t)return null;
+        var e = t.position,
+         r = t.selectionEnd,
+         n = this.monacoModel.getPositionAt(e),
+         i = this.monacoModel.getPositionAt(r);
+         if (e > r) {
+             var o = [i, n];
+             n = o[0],
+             i = o[1]
+        }
+        return {l:n.lineNumber, c:n.column}
+    },
+    t.prototype.setCursor = function (t) {
+         var e = t.position,
+         r = t.selectionEnd,
+         n = this.monacoModel.getPositionAt(e),
+         i = this.monacoModel.getPositionAt(r);
+         if (e > r) {
+             var o = [i, n];
+             n = o[0],
+             i = o[1]
+        }
+        this.monaco.setSelection(new monaco.Range(n.lineNumber, n.column, i.lineNumber, i.column))
+    },
+    t.prototype.deltaDecorations = function(oldDecorations, newDecorations) {
+		
+		if (oldDecorations.length === 0 && newDecorations.length === 0) {
+			return oldDecorations;
+		}
+        
+		return this.monacoModel.deltaDecorations(oldDecorations, newDecorations, parseInt(this.monaco.getId().split(':')[1]));
+	},
+    t.prototype.setOtherCursor = function (t, e, r) {
+        if ("object" != typeof t || "number" != typeof t.position || "number" != typeof t.selectionEnd)
+            return !1;
+         if ("string" != typeof e || !e.match(/^#[a-fA-F0-9]{3,6}$/))
+             return !1;
+        var o = t.position,
+        s = t.selectionEnd;
+        if (o < 0 || s < 0)
+            return !1;
+        var a = this.otherCursors.find(function (t) {
+            return t.clientID === r
+        });
+        a || (a = { clientID: r, decoration: [] },
+        this.otherCursors.push(a)),
+        log1(this.monacoModel.uri.path),
+        //a.decoration = this.monaco.deltaDecorations(a.decoration, [],this.modelData);
+        a.decoration = this.deltaDecorations(a.decoration, []);
+        var h, c, u = "other-client-selection-" + e.replace("#", "");
+        o === s ? (u = u.replace("selection", "cursor"),
+        h = n(u, "transparent", e),
+        c = i.call(this, u, h)) : (h = n(u, e, e), c = i.call(this, u, h)), 0 == c && console.log("Monaco Adapter: Failed to add some css style.\nPlease make sure you're running on supported environment.");
+        var l = this.monacoModel.getPositionAt(o),
+        p = this.monacoModel.getPositionAt(s);
+        if (o > s) { var d = [p, l]; l = d[0], p = d[1] }
+	    log1(this.monacoModel.uri.path);
+        //a.decoration = this.monaco.deltaDecorations(a.decoration, [{ range: new monaco.Range(l.lineNumber, l.column, p.lineNumber, p.column), options: { className: u } }],this.modelData);
+        a.decoration = this.deltaDecorations(a.decoration, [{ range: new monaco.Range(l.lineNumber, l.column, p.lineNumber, p.column), options: { className: u } }]);
+        var f = this;
+        return { clear: function () {
+	    log1(f.monacoModel.uri.path);
+        //a.decoration = f.monaco.deltaDecorations(a.decoration, [],f.modelData) } }
+        a.decoration = f.deltaDecorations(a.decoration, []) } }
+    },
+    t.prototype.registerCallbacks = function (t) {
+        this.callbacks = Object.assign({},
+        this.callbacks, t)
+    },
+    t.prototype.registerUndo = function (t) {
+        if ("function" != typeof t) throw new Error("MonacoAdapter: registerUndo method expects a callback function in parameter");
+        this.callbacks.undo = t
+    },
+    t.prototype.registerRedo = function (t) {
+        if ("function" != typeof t) throw new Error("MonacoAdapter: registerRedo method expects a callback function in parameter");
+        this.callbacks.redo = t
+    },
+    t.prototype.operationFromMonacoChanges = function (t, e, n) {
+        var i, o, s, a = t.text, h = t.rangeLength, c = t.rangeOffset + n, u = e.length + n - c;
+        return 0 === a.length && h > 0 ? (s = e.slice(c, c + h), i = (new r.TextOperation).retain(c).delete(h).retain(u - h), o = (new r.TextOperation).retain(c).insert(s).retain(u - h)) : a.length > 0 && h > 0 ? (s = e.slice(c, c + h), i = (new r.TextOperation).retain(c).delete(h).insert(a).retain(u - h), o = (new r.TextOperation).retain(c).delete(a.length).insert(s).retain(u - h)) : (i = (new r.TextOperation).retain(c).insert(a).retain(u), o = (new r.TextOperation).retain(c).delete(a).retain(u)), [i, o]
+    },
+    t.prototype.onChange = function (t) {
+       log1(this.monacoModel.uri.path);
+        var e = this; if (!this.ignoreChanges/*wb+*/&&!this.no_edits/*+wb*/) {
+            var n = this.lastDocLines.join(this.monacoModel.getEOL()),
+            i = 0;
+            if (!t.changes) {
+                var o = (new r.TextOperation).retain(n.length);
+                this.trigger("change", o, o) }
+                t.changes.reverse().forEach(function (t) { var r = e.operationFromMonacoChanges(t, n, i); i += r[0].targetLength - r[0].baseLength, e.trigger.apply(e, ["change"].concat(r)) }),
+                this.lastDocLines = this.monacoModel.getLinesContent()
+        }
+    },
+    t.prototype.trigger = function (t) {
+        if (this.callbacks.hasOwnProperty(t)) {
+            var e = this.callbacks[t]; 0; var r = [];
+            if (arguments.length > 1) for (var n = 1; n < arguments.length; n++)r.push(arguments[n]); e.apply(null, r)
+        }
+    },
+    t.prototype.onBlur = function () {
+        this.monaco.getSelection().isEmpty() && this.trigger("blur")
+    },
+    t.prototype.onFocus = function () {
+        this.trigger("focus")
+    },
+    t.prototype.onCursorActivity = function () {
+        wb_monaco.setActiveModel(this.monacoModel);
+        var t = this; setTimeout(function () { return t.trigger("cursorActivity") }, 1)
+    },
+    t.prototype.asyncForEach = async function(array, callback) {
+        for (let index = 0; index < array.length; index++) {
+            await callback(array[index], index, array);
+        }
+    },
+    t.prototype.applyOperation = function (t) { t.isNoop() || (this.ignoreChanges = !0);
+        /*wb+*/
+        log1(t);
+        if(this.no_edits)return;/*+wb*/
+        var e = 0, r = this;
+        t.ops.forEach(function (t) {
+            if (t.isRetain())
+                e += t.chars;
+            else if (t.isInsert()) {
+                var n = r.monacoModel.getPositionAt(e);
+                log1(r.monacoModel.uri.path);
+                
+                wb_monaco.coderpair.executeEdits([{ range: new monaco.Range(n.lineNumber, n.column, n.lineNumber, n.column), text: t.text, forceMoveMarkers: !0 }],r.monaco,r.monacoModel); 
+                e += t.text.length
+            } else if (t.isDelete()) {
+                var i = r.monacoModel.getPositionAt(e),
+                o = r.monacoModel.getPositionAt(e + t.chars);
+                log1(r.monacoModel.uri.path);
+                
+                wb_monaco.coderpair.executeEdits([{ range: new monaco.Range(i.lineNumber, i.column, o.lineNumber, o.column), text: "", forceMoveMarkers: !0}],r.monaco,r.monacoModel)
+            }
+        }),
+        this.lastDocLines = this.monacoModel.getLinesContent(),
+        this.ignoreChanges = !1
+    },
+    t.prototype.invertOperation = function (t) {
+        t.invert(this.getValue())
+    }, t
+}(); return r.MonacoAdapter = o
+
+
+
+
+,(r=r||{}).AttributeConstants={BOLD:"b",ITALIC:"i",UNDERLINE:"u",STRIKE:"s",FONT:"f",FONT_SIZE:"fs",COLOR:"c",BACKGROUND_COLOR:"bc",ENTITY_SENTINEL:"ent",LINE_SENTINEL:"l",LINE_INDENT:"li",LINE_ALIGN:"la",LIST_TYPE:"lt"},r.sentinelConstants={LINE_SENTINEL_CHARACTER:"",ENTITY_SENTINEL_CHARACTER:""},(r=r||{}).EntityManager=function(){var t=r.utils;function e(){this.entities_={};var e=["src","alt","width","height","style","class"];this.register("img",{render:function(e){t.assert(e.src,"image entity should have 'src'!");for(var r=["src","alt","width","height","style","class"],n="<img ",i=0;i<r.length;i++){var o=r[i];o in e&&(n+=" "+o+'="'+e[o]+'"')}return n+=">"},fromElement:function(t){for(var r={},n=0;n<e.length;n++){var i=e[n];t.hasAttribute(i)&&(r[i]=t.getAttribute(i))}return r}})}return e.prototype.register=function(t,e){r.utils.assert(e.render,"Entity options should include a 'render' function!"),r.utils.assert(e.fromElement,"Entity options should include a 'fromElement' function!"),this.entities_[t]=e},e.prototype.renderToElement=function(t,e){return this.tryRenderToElement_(t,"render",e)},e.prototype.exportToElement=function(t){var e=this.tryRenderToElement_(t,"export")||this.tryRenderToElement_(t,"getHtml")||this.tryRenderToElement_(t,"render");return e.setAttribute("data-firepad-entity",t.type),e},e.prototype.updateElement=function(t,e){var r=t.type,n=t.info;this.entities_[r]&&void 0!==this.entities_[r].update&&this.entities_[r].update(n,e)},e.prototype.fromElement=function(t){var e=t.getAttribute("data-firepad-entity");if(e||(e=t.nodeName.toLowerCase()),e&&this.entities_[e]){var n=this.entities_[e].fromElement(t);return new r.Entity(e,n)}},e.prototype.tryRenderToElement_=function(t,e,n){var i=t.type,o=t.info;if(this.entities_[i]&&this.entities_[i][e]){var s=r.document||window&&window.document,a=this.entities_[i][e](o,n,s);if(a){if("string"==typeof a){var h=(r.document||document).createElement("div");return h.innerHTML=a,h.childNodes[0]}if("object"==typeof a)return r.utils.assert(void 0!==a.nodeType,"Error rendering "+i+" entity.  render() function must return an html string or a DOM element."),a}}},e.prototype.entitySupportsUpdate=function(t){return this.entities_[t]&&this.entities_[t].update},e}(),(r=r||{}).Entity=function(){var t=r.AttributeConstants.ENTITY_SENTINEL,e=t+"_";function n(t,e){if(!(this instanceof n))return new n(t,e);this.type=t,this.info=e||{}}return n.prototype.toAttributes=function(){var r={};for(var n in r[t]=this.type,this.info)r[e+n]=this.info[n];return r},n.fromAttributes=function(r){var i=r[t],o={};for(var s in r)0===s.indexOf(e)&&(o[s.substr(e.length)]=r[s]);return new n(i,o)},n}(),(r=r||{}).RichTextCodeMirror=function(){var t=r.AnnotationList,e=r.Span,n=r.utils,i=r.AttributeConstants,o={c:"color",bc:"background-color",fs:"font-size",li:function(t){return"padding-left: "+40*t+"px"}},s={};function a(e,r,n){this.codeMirror=e,this.options_=n||{},this.entityManager_=r,this.currentAttributes_=null;var i=this;this.annotationList_=new t(function(t,e){i.onAnnotationsChanged_(t,e)}),this.initAnnotationList_(),f(this,"onCodeMirrorBeforeChange_"),f(this,"onCodeMirrorChange_"),f(this,"onCursorActivity_"),parseInt(CodeMirror.version)>=4?this.codeMirror.on("changes",this.onCodeMirrorChange_):this.codeMirror.on("change",this.onCodeMirrorChange_),this.codeMirror.on("beforeChange",this.onCodeMirrorBeforeChange_),this.codeMirror.on("cursorActivity",this.onCursorActivity_),this.changeId_=0,this.outstandingChanges_={},this.dirtyLines_=[]}n.makeEventEmitter(a,["change","attributesChange","newLine"]);var h=r.sentinelConstants.LINE_SENTINEL_CHARACTER,c=r.sentinelConstants.ENTITY_SENTINEL_CHARACTER;function u(t,e){return t.line-e.line||t.ch-e.ch}function l(t,e){return u(t,e)<=0}function p(t){if(0===t.length)return 0;for(var e=0,r=0;r<t.length;r++)e+=t[r].length;return e+t.length-1}function d(t){this.attributes=t||{}}function f(t,e){var r=t[e];t[e]=function(){r.apply(t,arguments)}}return a.prototype.detach=function(){this.codeMirror.off("beforeChange",this.onCodeMirrorBeforeChange_),this.codeMirror.off("change",this.onCodeMirrorChange_),this.codeMirror.off("changes",this.onCodeMirrorChange_),this.codeMirror.off("cursorActivity",this.onCursorActivity_),this.clearAnnotations_()},a.prototype.toggleAttribute=function(t,e){var r=e||!0;if(this.emptySelection_()){var n=this.getCurrentAttributes_();n[t]===r?delete n[t]:n[t]=r,this.currentAttributes_=n}else{var i=this.getCurrentAttributes_()[t]!==r&&r;this.setAttribute(t,i)}},a.prototype.setAttribute=function(t,e){var r=this.codeMirror;if(this.emptySelection_()){var n=this.getCurrentAttributes_();!1===e?delete n[t]:n[t]=e,this.currentAttributes_=n}else this.updateTextAttributes(r.indexFromPos(r.getCursor("start")),r.indexFromPos(r.getCursor("end")),function(r){!1===e?delete r[t]:r[t]=e}),this.updateCurrentAttributes_()},a.prototype.updateTextAttributes=function(t,r,n,o,s){var a=[],h=t,c=this;this.annotationList_.updateSpan(new e(t,r-t),function(t,e){var r={};for(var u in t.attributes)r[u]=t.attributes[u];r[i.LINE_SENTINEL]&&!s||n(r);var l={},p={};return c.computeChangedAttributes_(t.attributes,r,l,p),function(t){for(var e in t)return!1;return!0}(l)||a.push({start:h,end:h+e,attributes:l,attributesInverse:p,origin:o}),h+=e,new d(r)}),a.length>0&&this.trigger("attributesChange",this,a)},a.prototype.computeChangedAttributes_=function(t,e,r,n){var i,o={};for(i in t)o[i]=!0;for(i in e)o[i]=!0;for(i in o)i in e?i in t?t[i]!==e[i]&&(r[i]=e[i],n[i]=t[i]):(r[i]=e[i],n[i]=!1):(r[i]=!1,n[i]=t[i])},a.prototype.toggleLineAttribute=function(t,e){var r,n=this.getCurrentLineAttributes_();r=!(t in n&&n[t]===e)&&e,this.setLineAttribute(t,r)},a.prototype.setLineAttribute=function(t,e){this.updateLineAttributesForSelection(function(r){!1===e?delete r[t]:r[t]=e})},a.prototype.updateLineAttributesForSelection=function(t){var e=this.codeMirror,r=e.getCursor("start"),n=e.getCursor("end"),i=r.line,o=n.line,s=e.getLine(o),a=this.areLineSentinelCharacters_(s.substr(0,n.ch));o>i&&a&&o--,this.updateLineAttributes(i,o,t)},a.prototype.updateLineAttributes=function(t,e,r){for(var n=t;n<=e;n++){var o=this.codeMirror.getLine(n),s=this.codeMirror.indexFromPos({line:n,ch:0});if(o[0]!==h){var a={};a[i.LINE_SENTINEL]=!0,r(a),this.insertText(s,h,a)}else this.updateTextAttributes(s,s+1,r,null,!0)}},a.prototype.replaceText=function(t,e,r,n,i){this.changeId_++;var o="cmrt-"+this.changeId_;this.outstandingChanges_[o]={origOrigin:i,attributes:n};var s=this.codeMirror,a=s.posFromIndex(t),h="number"==typeof e?s.posFromIndex(e):null;s.replaceRange(r,a,h,o)},a.prototype.insertText=function(t,e,r,n){var i=this.codeMirror,o=i.getCursor(),s="RTCMADAPTER"==n&&!i.somethingSelected()&&t==i.indexFromPos(o);this.replaceText(t,null,e,r,n),s&&i.setCursor(o)},a.prototype.removeText=function(t,e,r){var n=this.codeMirror;n.replaceRange("",n.posFromIndex(t),n.posFromIndex(e),r)},a.prototype.insertEntityAtCursor=function(t,e,r){var n=this.codeMirror,i=n.indexFromPos(n.getCursor("head"));this.insertEntityAt(i,t,e,r)},a.prototype.insertEntityAt=function(t,e,n,i){this.codeMirror;this.insertEntity_(t,new r.Entity(e,n),i)},a.prototype.insertEntity_=function(t,e,r){this.replaceText(t,null,c,e.toAttributes(),r)},a.prototype.getAttributeSpans=function(t,r){for(var n=[],i=this.annotationList_.getAnnotatedSpansForSpan(new e(t,r-t)),o=0;o<i.length;o++)n.push({length:i[o].length,attributes:i[o].annotation.attributes});return n},a.prototype.end=function(){var t=this.codeMirror.lineCount()-1;return this.codeMirror.indexFromPos({line:t,ch:this.codeMirror.getLine(t).length})},a.prototype.getRange=function(t,e){var r=this.codeMirror.posFromIndex(t),n=this.codeMirror.posFromIndex(e);return this.codeMirror.getRange(r,n)},a.prototype.initAnnotationList_=function(){var t=this.end();0!==t&&this.annotationList_.insertAnnotatedSpan(new e(0,t),new d)},a.prototype.onAnnotationsChanged_=function(t,e){var r,n={};this.tryToUpdateEntitiesInPlace(t,e);for(var o=0;o<t.length;o++){var s=t[o].annotation.attributes;i.LINE_SENTINEL in s&&(n[this.codeMirror.posFromIndex(t[o].pos).line]=!0),(r=t[o].getAttachedObject())&&r.clear()}for(o=0;o<e.length;o++){var a=e[o].annotation,h=i.LINE_SENTINEL in a.attributes,c=i.ENTITY_SENTINEL in a.attributes,u=this.codeMirror.posFromIndex(e[o].pos);if(h)n[u.line]=!0;else if(c)this.markEntity_(e[o]);else{var l=this.getClassNameForAttributes_(a.attributes);if(""!==l){var p=this.codeMirror.posFromIndex(e[o].pos+e[o].length);r=this.codeMirror.markText(u,p,{className:l}),e[o].attachObject(r)}}}for(var d in n)this.dirtyLines_.push(this.codeMirror.getLineHandle(Number(d))),this.queueLineMarking_()},a.prototype.tryToUpdateEntitiesInPlace=function(t,e){for(var r=t.length;r--;)for(var n=t[r],i=e.length;i--;){var o=e[i];if(n.pos==o.pos&&n.length==o.length&&n.annotation.attributes.ent&&n.annotation.attributes.ent==o.annotation.attributes.ent){var s=o.annotation.attributes.ent;if(this.entityManager_.entitySupportsUpdate(s)){t.splice(r,1),e.splice(i,1);var a=n.getAttachedObject();a.update(o.annotation.attributes),o.attachObject(a)}}}},a.prototype.queueLineMarking_=function(){if(null==this.lineMarkTimeout_){var t=this;this.lineMarkTimeout_=setTimeout(function(){t.lineMarkTimeout_=null;for(var e=[],r=0;r<t.dirtyLines_.length;r++){var n=t.codeMirror.getLineNumber(t.dirtyLines_[r]);e.push(Number(n))}t.dirtyLines_=[],e.sort(function(t,e){return t-e});var i=-1;for(r=0;r<e.length;r++){var o=e[r];o>i&&(i=t.markLineSentinelCharactersForChangedLines_(o,o))}},0)}},a.prototype.addStyleWithCSS_=function(t){var e=document.getElementsByTagName("head")[0],r=document.createElement("style");r.type="text/css",r.styleSheet?r.styleSheet.cssText=t:r.appendChild(document.createTextNode(t)),e.appendChild(r)},a.prototype.getClassNameForAttributes_=function(t){var e="";for(var n in t){var a=t[n];if(n===i.LINE_SENTINEL)r.utils.assert(!0===a,"LINE_SENTINEL attribute should be true if it exists.");else{var h=(this.options_.cssPrefix||"cmrt-")+n;if(!0!==a){n===i.FONT_SIZE&&"string"!=typeof a&&(a+="px");var c=a.toString().toLowerCase().replace(/[^a-z0-9-_]/g,"-");if(h+="-"+c,o[n]&&(s[n]||(s[n]={}),!s[n][c])){s[n][c]=!0;var u=o[n],l="function"==typeof u?u(a):u+": "+a,p=n==i.LINE_INDENT?"pre."+h:"."+h;if(this.addStyleWithCSS_(p+" { "+l+" }"),n===i.LINE_INDENT){p="pre.CodeMirror-line."+h;this.addStyleWithCSS_(p+" { "+l+" }")}}}e=e+" "+h}}return e},a.prototype.markEntity_=function(t){for(var e=t.annotation.attributes,n=r.Entity.fromAttributes(e),i=this.codeMirror,o=this,s=[],a=0;a<t.length;a++){var h=i.posFromIndex(t.pos+a),c=i.posFromIndex(t.pos+a+1),u={collapsed:!0,atomic:!0,inclusiveLeft:!1,inclusiveRight:!1},l=this.createEntityHandle_(n,t.pos),p=this.entityManager_.renderToElement(n,l);p&&(u.replacedWith=p);var d=i.markText(h,c,u);s.push(d),l.setMarker(d)}t.attachObject({clear:function(){for(var t=0;t<s.length;t++)s[t].clear()},update:function(t){for(var e=r.Entity.fromAttributes(t),n=0;n<s.length;n++)o.entityManager_.updateElement(e,s[n].replacedWith)}}),this.queueRefresh_()},a.prototype.queueRefresh_=function(){var t=this;this.refreshTimer_||(this.refreshTimer_=setTimeout(function(){t.codeMirror.refresh(),t.refreshTimer_=null},0))},a.prototype.createEntityHandle_=function(t,e){var n=null,i=this;function o(){if(n){var t=n.find();return t?i.codeMirror.indexFromPos(t.from):null}return e}return{find:o,remove:function(){var t=o();null!=t&&(i.codeMirror.focus(),i.removeText(t,t+1))},replace:function(e){var n=r.AttributeConstants.ENTITY_SENTINEL,s=n+"_",a=o();i.updateTextAttributes(a,a+1,function(r){for(var i in r)delete r[i];for(var o in r[n]=t.type,e)r[s+o]=e[o]})},setMarker:function(t){n=t}}},a.prototype.lineClassRemover_=function(t){var e=this.codeMirror,r=e.getLineHandle(t);return{clear:function(){e.removeLineClass(r,"text",".*")}}},a.prototype.emptySelection_=function(){var t=this.codeMirror.getCursor("start"),e=this.codeMirror.getCursor("end");return t.line===e.line&&t.ch===e.ch},a.prototype.onCodeMirrorBeforeChange_=function(t,e){if("+input"===e.origin||"paste"===e.origin){for(var r=[],n=0;n<e.text.length;n++){var i=e.text[n];i=i.replace(new RegExp("["+h+c+"]","g"),""),r.push(i)}e.update(e.from,e.to,r)}},a.prototype.onCodeMirrorChange_=function(t,r){if("object"==typeof r.from){for(var n=[];r;)n.push(r),r=r.next;r=n}for(var i=this.convertCoordinateSystemForChanges_(r),o=[],s=0;s<i.length;s++){var a,h=i[s],c=h.start,u=(h.end,h.text),l=h.removed,p=h.origin;if(l.length>0){for(var f=this.annotationList_.getAnnotatedSpansForSpan(new e(c,l.length)),g=0,m=0;m<f.length;m++){var y=f[m];o.push({start:c,end:c+y.length,removedAttributes:y.annotation.attributes,removed:l.substr(g,y.length),attributes:{},text:"",origin:h.origin}),g+=y.length}this.annotationList_.removeSpan(new e(c,l.length))}if(u.length>0)"+input"===h.origin||"paste"===h.origin?a=this.currentAttributes_||{}:p in this.outstandingChanges_?(a=this.outstandingChanges_[p].attributes,p=this.outstandingChanges_[p].origOrigin,delete this.outstandingChanges_[p]):a={},this.annotationList_.insertAnnotatedSpan(new e(c,u.length),new d(a)),o.push({start:c,end:c,removedAttributes:{},removed:"",text:u,attributes:a,origin:p})}this.markLineSentinelCharactersForChanges_(r),o.length>0&&this.trigger("change",this,o)},a.prototype.convertCoordinateSystemForChanges_=function(t){var e=this,r=function(t){return e.codeMirror.indexFromPos(t)};function n(t,e){return function(r){return l(r,e.from)?t(r):l(e.to,r)?t({line:r.line+e.text.length-1-(e.to.line-e.from.line),ch:e.to.line<r.line?r.ch:e.text.length<=1?r.ch-(e.to.ch-e.from.ch)+p(e.text):r.ch-e.to.ch+(n=e.text,n[n.length-1]).length})+p(e.removed)-p(e.text):e.from.line===r.line?t(e.from)+r.ch-e.from.ch:t(e.from)+p(e.removed.slice(0,r.line-e.from.line))+1+r.ch;var n}}for(var i=[],o=t.length-1;o>=0;o--){var s=t[o],a=(r=n(r,s))(s.from),h=s.removed.join("\n"),c=s.text.join("\n");i.unshift({start:a,end:a+h.length,removed:h,text:c,origin:s.origin})}return i},a.prototype.markLineSentinelCharactersForChanges_=function(t){for(var e=Number.MAX_VALUE,r=-1,n=0;n<t.length;n++){var i=t[n],o=i.from.line;i.from.ch;(i.removed.length>1||i.removed[0].indexOf(h)>=0)&&(e=Math.min(e,o),r=Math.max(r,o)),i.text.length>1?(e=Math.min(e,o),r=Math.max(r,o+i.text.length-1)):i.text[0].indexOf(h)>=0&&(e=Math.min(e,o),r=Math.max(r,o))}r=Math.min(r,this.codeMirror.lineCount()-1),this.markLineSentinelCharactersForChangedLines_(e,r)},a.prototype.markLineSentinelCharactersForChangedLines_=function(t,e){if(t<Number.MAX_VALUE)for(;t>0&&this.lineIsListItemOrIndented_(t-1);)t--;if(e>-1)for(var r=this.codeMirror.lineCount();e+1<r&&this.lineIsListItemOrIndented_(e+1);)e++;for(var n=[],i=this.codeMirror,o=t;o<=e;o++){var s=i.getLine(o),a=i.getLineHandle(o);if(i.removeLineClass(a,"text",".*"),s.length>0)for(var c=s.indexOf(h);c>=0;){for(var u=c;c<s.length&&s[c]===h;){for(var l=i.findMarksAt({line:o,ch:c}),p=0;p<l.length;p++)l[p].isForLineSentinel&&l[p].clear();c++}this.markLineSentinelCharacters_(o,u,c,n),c=s.indexOf(h,c)}else n=[]}return e},a.prototype.markLineSentinelCharacters_=function(t,e,r,n){var o=this.codeMirror,s=null,a=null,h=function(){var t=a.find();return t?t.from.line:null};if(0===e){var c=this.getLineAttributes_(t),u=c[i.LIST_TYPE],l=c[i.LINE_INDENT]||0;for(u&&0===l&&(l=1);l>=n.length;)n.push(1);"o"===u?(s=this.makeOrderedListElement_(n[l]),n[l]++):"u"===u?(s=this.makeUnorderedListElement_(),n[l]=1):"t"===u?(s=this.makeTodoListElement_(!1,h),n[l]=1):"tc"===u&&(s=this.makeTodoListElement_(!0,h),n[l]=1);var p=this.getClassNameForAttributes_(c);""!==p&&this.codeMirror.addLineClass(t,"text",p),n[l+1]=1}var d={inclusiveLeft:!0,collapsed:!0};s&&(d.replacedWith=s),(a=o.markText({line:t,ch:e},{line:t,ch:r},d)).isForLineSentinel=!0},a.prototype.makeOrderedListElement_=function(t){return n.elt("div",t+".",{class:"firepad-list-left"})},a.prototype.makeUnorderedListElement_=function(){return n.elt("div","•",{class:"firepad-list-left"})},a.prototype.toggleTodo=function(t){var e,r=i.LIST_TYPE,n=this.getCurrentLineAttributes_();r in n&&("t"===n[r]||"tc"===n[r])?"t"===n[r]?e="tc":"tc"===n[r]&&(e=!!t&&"t"):e="t",this.setLineAttribute(r,e)},a.prototype.makeTodoListElement_=function(t,e){var r={type:"checkbox",class:"firepad-todo-left"};t&&(r.checked=!0);var i=n.elt("input",!1,r),o=this;return n.on(i,"click",n.stopEventAnd(function(t){o.codeMirror.setCursor({line:e(),ch:1}),o.toggleTodo(!0)})),i},a.prototype.lineIsListItemOrIndented_=function(t){var e=this.getLineAttributes_(t);return!1!==(e[i.LIST_TYPE]||!1)||0!==(e[i.LINE_INDENT]||0)},a.prototype.onCursorActivity_=function(){var t=this;setTimeout(function(){t.updateCurrentAttributes_()},1)},a.prototype.getCurrentAttributes_=function(){return this.currentAttributes_||this.updateCurrentAttributes_(),this.currentAttributes_},a.prototype.updateCurrentAttributes_=function(){var t=this.codeMirror,e=t.indexFromPos(t.getCursor("anchor")),n=t.indexFromPos(t.getCursor("head")),o=n;if(e>n){for(;o<this.end();){var s=this.getRange(o,o+1);if("\n"!==s&&s!==h)break;o++}o<this.end()&&o++}else for(;o>0&&("\n"===(s=this.getRange(o-1,o))||s===h);)o--;var a=this.annotationList_.getAnnotatedSpansForPos(o);this.currentAttributes_={};var c={};for(var u in a.length>0&&!(i.LINE_SENTINEL in a[0].annotation.attributes)?c=a[0].annotation.attributes:a.length>1&&(r.utils.assert(!(i.LINE_SENTINEL in a[1].annotation.attributes),"Cursor can't be between two line sentinel characters."),c=a[1].annotation.attributes),c)"l"!==u&&"lt"!==u&&"li"!==u&&0!==u.indexOf(i.ENTITY_SENTINEL)&&(this.currentAttributes_[u]=c[u])},a.prototype.getCurrentLineAttributes_=function(){var t=this.codeMirror,e=t.getCursor("anchor"),r=t.getCursor("head"),n=r.line;return 0===r.ch&&e.line<r.line&&n--,this.getLineAttributes_(n)},a.prototype.getLineAttributes_=function(t){var n={},i=this.codeMirror.getLine(t);if(i.length>0&&i[0]===h){var o=this.codeMirror.indexFromPos({line:t,ch:0}),s=this.annotationList_.getAnnotatedSpansForSpan(new e(o,1));for(var a in r.utils.assert(1===s.length),s[0].annotation.attributes)n[a]=s[0].annotation.attributes[a]}return n},a.prototype.clearAnnotations_=function(){this.annotationList_.updateSpan(new e(0,this.end()),function(t,e){return new d({})})},a.prototype.newline=function(){var t=this.codeMirror,e=this;if(this.emptySelection_()){var r=t.getCursor("head").line,n=this.getLineAttributes_(r),o=n[i.LIST_TYPE];o&&1===t.getLine(r).length?this.updateLineAttributes(r,r,function(t){delete t[i.LIST_TYPE],delete t[i.LINE_INDENT]}):(t.replaceSelection("\n","end","+input"),this.updateLineAttributes(r+1,r+1,function(t){for(var s in n)t[s]=n[s];"tc"===o&&(t[i.LIST_TYPE]="t"),e.trigger("newLine",{line:r+1,attr:t})}))}else t.replaceSelection("\n","end","+input")},a.prototype.deleteLeft=function(){var t=this.codeMirror,e=t.getCursor("head"),r=this.getLineAttributes_(e.line),n=r[i.LIST_TYPE],o=r[i.LINE_INDENT],s=this.emptySelection_()&&1===e.ch;s&&n?this.updateLineAttributes(e.line,e.line,function(t){delete t[i.LIST_TYPE],delete t[i.LINE_INDENT]}):s&&o&&o>0?this.unindent():t.deleteH(-1,"char")},a.prototype.deleteRight=function(){var t=this.codeMirror,e=t.getCursor("head"),r=t.getLine(e.line),n=this.areLineSentinelCharacters_(r),i=e.line+1<t.lineCount()?t.getLine(e.line+1):"";this.emptySelection_()&&n&&i[0]===h?(t.replaceRange("",{line:e.line,ch:0},{line:e.line+1,ch:0},"+input"),t.setCursor({line:e.line,ch:0})):t.deleteH(1,"char")},a.prototype.indent=function(){this.updateLineAttributesForSelection(function(t){var e=t[i.LINE_INDENT],r=t[i.LIST_TYPE];e?t[i.LINE_INDENT]++:t[i.LINE_INDENT]=r?2:1})},a.prototype.unindent=function(){this.updateLineAttributesForSelection(function(t){var e=t[i.LINE_INDENT];e&&e>1?t[i.LINE_INDENT]=e-1:(delete t[i.LIST_TYPE],delete t[i.LINE_INDENT])})},a.prototype.getText=function(){return this.codeMirror.getValue().replace(new RegExp(h,"g"),"")},a.prototype.areLineSentinelCharacters_=function(t){for(var e=0;e<t.length;e++)if(t[e]!==h)return!1;return!0},d.prototype.equals=function(t){if(!(t instanceof d))return!1;var e;for(e in this.attributes)if(t.attributes[e]!==this.attributes[e])return!1;for(e in t.attributes)if(t.attributes[e]!==this.attributes[e])return!1;return!0},a}(),(r=r||{}).RichTextCodeMirrorAdapter=function(){"use strict";var t=r.TextOperation,e=r.WrappedOperation,n=r.Cursor;function i(t){this.rtcm=t,this.cm=t.codeMirror,h(this,"onChange"),h(this,"onAttributesChange"),h(this,"onCursorActivity"),h(this,"onFocus"),h(this,"onBlur"),this.rtcm.on("change",this.onChange),this.rtcm.on("attributesChange",this.onAttributesChange),this.cm.on("cursorActivity",this.onCursorActivity),this.cm.on("focus",this.onFocus),this.cm.on("blur",this.onBlur)}function o(t,e){return t.line<e.line?-1:t.line>e.line?1:t.ch<e.ch?-1:t.ch>e.ch?1:0}function s(t){var e=t.lineCount()-1;return t.indexFromPos({line:e,ch:t.getLine(e).length})}function a(t,e){if(!t)throw new Error(e||"assertion error")}function h(t,e){var r=t[e];t[e]=function(){r.apply(t,arguments)}}function c(t){for(var e in t)return!1;return!0}function u(t,e){if("string"!=typeof t)throw new TypeError("Expected a string");3===(t=t.replace(/^#/,"")).length&&(t=t[0]+t[0]+t[1]+t[1]+t[2]+t[2]);var r,n=parseInt(t,16),i=[n>>16,n>>8&255,255&n],o="rgb";return null!==(r=e)&&void 0!==r&&(o="rgba",i.push(e)),o+"("+i.join(",")+")"}return i.prototype.detach=function(){this.rtcm.off("change",this.onChange),this.rtcm.off("attributesChange",this.onAttributesChange),this.cm.off("cursorActivity",this.onCursorActivity),this.cm.off("focus",this.onFocus),this.cm.off("blur",this.onBlur)},i.operationFromCodeMirrorChanges=function(e,r){for(var n=s(r),i=(new t).retain(n),o=(new t).retain(n),a=e.length-1;a>=0;a--){var h=e[a],c=h.start,u=n-c-h.text.length;i=(new t).retain(c).delete(h.removed.length).insert(h.text,h.attributes).retain(u).compose(i),o=o.compose((new t).retain(c).delete(h.text.length).insert(h.removed,h.removedAttributes).retain(u)),n+=h.removed.length-h.text.length}return[i,o]},i.operationFromAttributesChanges=function(e,r){for(var n=s(r),i=new t,o=new t,h=0,c=0;c<e.length;c++){var u=e[c],l=u.start-h;a(l>=0),i.retain(l),o.retain(l);var p=u.end-u.start;i.retain(p,u.attributes),o.retain(p,u.attributesInverse),h=u.start+p}return i.retain(n-h),o.retain(n-h),[i,o]},i.prototype.registerCallbacks=function(t){this.callbacks=t},i.prototype.onChange=function(t,e){if("RTCMADAPTER"!==e[0].origin){var r=i.operationFromCodeMirrorChanges(e,this.cm);this.trigger("change",r[0],r[1])}},i.prototype.onAttributesChange=function(t,e){if("RTCMADAPTER"!==e[0].origin){var r=i.operationFromAttributesChanges(e,this.cm);this.trigger("change",r[0],r[1])}},i.prototype.onCursorActivity=function(){var t=this;setTimeout(function(){t.trigger("cursorActivity")},1)},i.prototype.onFocus=function(){this.trigger("focus")},i.prototype.onBlur=function(){this.cm.somethingSelected()||this.trigger("blur")},i.prototype.getValue=function(){return this.cm.getValue()},i.prototype.getCursor=function(){var t,e=this.cm,r=e.getCursor(),i=e.indexFromPos(r);if(e.somethingSelected()){var s=e.getCursor(!0),a=0===o(r,s)?e.getCursor(!1):s;t=e.indexFromPos(a)}else t=i;return new n(i,t)},i.prototype.setCursor=function(t){this.cm.setSelection(this.cm.posFromIndex(t.position),this.cm.posFromIndex(t.selectionEnd))},i.prototype.addStyleRule=function(t){if("undefined"!=typeof document&&null!==document){if(!this.addedStyleRules){this.addedStyleRules={};var e=document.createElement("style");document.documentElement.getElementsByTagName("head")[0].appendChild(e),this.addedStyleSheet=e.sheet}if(!this.addedStyleRules[t])return this.addedStyleRules[t]=!0,this.addedStyleSheet.insertRule(t,0)}},i.prototype.setOtherCursor=function(t,e,r){var n=this.cm.posFromIndex(t.position);if("string"==typeof e&&e.match(/^#[a-fA-F0-9]{3,6}$/)){var i=this.rtcm.end();if("object"==typeof t&&"number"==typeof t.position&&"number"==typeof t.selectionEnd&&!(t.position<0||t.position>i||t.selectionEnd<0||t.selectionEnd>i)){if(t.position===t.selectionEnd){var o=this.cm.cursorCoords(n),s=document.createElement("span");return s.className="other-client",s.style.borderLeftWidth="2px",s.style.borderLeftStyle="solid",s.style.borderLeftColor=e,s.style.marginLeft=s.style.marginRight="-1px",s.style.height=.9*(o.bottom-o.top)+"px",s.setAttribute("data-clientid",r),s.style.zIndex=0,this.cm.setBookmark(n,{widget:s,insertLeft:!0})}var a,h,c="selection-"+e.replace("#",""),l="."+c+" { background: "+u(e)+";\n background: "+u(e,.4)+";}";return this.addStyleRule(l),t.selectionEnd>t.position?(a=n,h=this.cm.posFromIndex(t.selectionEnd)):(a=this.cm.posFromIndex(t.selectionEnd),h=n),this.cm.markText(a,h,{className:c})}}},i.prototype.trigger=function(t){var e=Array.prototype.slice.call(arguments,1),r=this.callbacks&&this.callbacks[t];r&&r.apply(this,e)},i.prototype.applyOperation=function(t){t.ops.length>10&&this.rtcm.codeMirror.getWrapperElement().setAttribute("style","display: none");for(var e=t.ops,r=0,n=0,i=e.length;n<i;n++){var o=e[n];o.isRetain()?(c(o.attributes)||this.rtcm.updateTextAttributes(r,r+o.chars,function(t){for(var e in o.attributes)!1===o.attributes[e]?delete t[e]:t[e]=o.attributes[e]},"RTCMADAPTER",!0),r+=o.chars):o.isInsert()?(this.rtcm.insertText(r,o.text,o.attributes,"RTCMADAPTER"),r+=o.text.length):o.isDelete()&&this.rtcm.removeText(r,r+o.chars,"RTCMADAPTER")}t.ops.length>10&&(this.rtcm.codeMirror.getWrapperElement().setAttribute("style",""),this.rtcm.codeMirror.refresh())},i.prototype.registerUndo=function(t){this.cm.undo=t},i.prototype.registerRedo=function(t){this.cm.redo=t},i.prototype.invertOperation=function(r){for(var n,i,o=0,s=this.rtcm.codeMirror,a=new t,h=0;h<r.wrapped.ops.length;h++){var u=r.wrapped.ops[h];if(u.isRetain())if(c(u.attributes))a.retain(u.chars),o+=u.chars;else for(n=this.rtcm.getAttributeSpans(o,o+u.chars),i=0;i<n.length;i++){var l={};for(var p in u.attributes){var d=u.attributes[p],f=n[i].attributes[p];!1===d?f&&(l[p]=f):d!==f&&(l[p]=f||!1)}a.retain(n[i].length,l),o+=n[i].length}else if(u.isInsert())a.delete(u.text.length);else if(u.isDelete()){var g=s.getRange(s.posFromIndex(o),s.posFromIndex(o+u.chars));n=this.rtcm.getAttributeSpans(o,o+u.chars);var m=0;for(i=0;i<n.length;i++)a.insert(g.substr(m,n[i].length),n[i].attributes),m+=n[i].length;o+=u.chars}}return new e(a,r.meta.invert())},i}(),(r=r||{}).Formatting=function(){var t=r.AttributeConstants;function e(t){if(!(this instanceof e))return new e(t);this.attributes=t||{}}return e.prototype.cloneWithNewAttribute_=function(t,r){var n={};for(var i in this.attributes)n[i]=this.attributes[i];return!1===r?delete n[t]:n[t]=r,new e(n)},e.prototype.bold=function(e){return this.cloneWithNewAttribute_(t.BOLD,e)},e.prototype.italic=function(e){return this.cloneWithNewAttribute_(t.ITALIC,e)},e.prototype.underline=function(e){return this.cloneWithNewAttribute_(t.UNDERLINE,e)},e.prototype.strike=function(e){return this.cloneWithNewAttribute_(t.STRIKE,e)},e.prototype.font=function(e){return this.cloneWithNewAttribute_(t.FONT,e)},e.prototype.fontSize=function(e){return this.cloneWithNewAttribute_(t.FONT_SIZE,e)},e.prototype.color=function(e){return this.cloneWithNewAttribute_(t.COLOR,e)},e.prototype.backgroundColor=function(e){return this.cloneWithNewAttribute_(t.BACKGROUND_COLOR,e)},e}(),(r=r||{}).Text=function(){return function t(e,n){if(!(this instanceof t))return new t(e,n);this.text=e,this.formatting=n||r.Formatting()}}(),(r=r||{}).LineFormatting=function(){var t=r.AttributeConstants;function e(r){if(!(this instanceof e))return new e(r);this.attributes=r||{},this.attributes[t.LINE_SENTINEL]=!0}return e.LIST_TYPE={NONE:!1,ORDERED:"o",UNORDERED:"u",TODO:"t",TODOCHECKED:"tc"},e.prototype.cloneWithNewAttribute_=function(t,r){var n={};for(var i in this.attributes)n[i]=this.attributes[i];return!1===r?delete n[t]:n[t]=r,new e(n)},e.prototype.indent=function(e){return this.cloneWithNewAttribute_(t.LINE_INDENT,e)},e.prototype.align=function(e){return this.cloneWithNewAttribute_(t.LINE_ALIGN,e)},e.prototype.listItem=function(e){return r.utils.assert(!1===e||"u"===e||"o"===e||"t"===e||"tc"===e),this.cloneWithNewAttribute_(t.LIST_TYPE,e)},e.prototype.getIndent=function(){return this.attributes[t.LINE_INDENT]||0},e.prototype.getAlign=function(){return this.attributes[t.LINE_ALIGN]||0},e.prototype.getListItem=function(){return this.attributes[t.LIST_TYPE]||!1},e}(),(r=r||{}).Line=function(){return function t(e,n){if(!(this instanceof t))return new t(e,n);"[object Array]"!==Object.prototype.toString.call(e)&&(e=void 0===e?[]:[e]),this.textPieces=e,this.formatting=n||r.LineFormatting()}}(),(r=r||{}).ParseHtml=function(){var t,e=r.LineFormatting.LIST_TYPE;function n(t,n,i){this.listType=t||e.UNORDERED,this.lineFormatting=n||r.LineFormatting(),this.textFormatting=i||r.Formatting()}function i(){this.lines=[],this.currentLine=[],this.currentLineListItemType=null}n.prototype.withTextFormatting=function(t){return new n(this.listType,this.lineFormatting,t)},n.prototype.withLineFormatting=function(t){return new n(this.listType,t,this.textFormatting)},n.prototype.withListType=function(t){return new n(t,this.lineFormatting,this.textFormatting)},n.prototype.withIncreasedIndent=function(){var t=this.lineFormatting.indent(this.lineFormatting.getIndent()+1);return new n(this.listType,t,this.textFormatting)},n.prototype.withAlign=function(t){var e=this.lineFormatting.align(t);return new n(this.listType,e,this.textFormatting)},i.prototype.newlineIfNonEmpty=function(t){this.cleanLine_(),this.currentLine.length>0&&this.newline(t)},i.prototype.newlineIfNonEmptyOrListItem=function(t){this.cleanLine_(),(this.currentLine.length>0||null!==this.currentLineListItemType)&&this.newline(t)},i.prototype.newline=function(t){this.cleanLine_();var e=t.lineFormatting;null!==this.currentLineListItemType&&(e=e.listItem(this.currentLineListItemType),this.currentLineListItemType=null),this.lines.push(r.Line(this.currentLine,e)),this.currentLine=[]},i.prototype.makeListItem=function(t){this.currentLineListItemType=t},i.prototype.cleanLine_=function(){if(this.currentLine.length>0){var t=this.currentLine.length-1;this.currentLine[0].text=this.currentLine[0].text.replace(/^ +/,""),this.currentLine[t].text=this.currentLine[t].text.replace(/ +$/g,"");for(var e=0;e<this.currentLine.length;e++)this.currentLine[e].text=this.currentLine[e].text.replace(/\u00a0/g," ")}1===this.currentLine.length&&""===this.currentLine[0].text&&(this.currentLine=[])};var o=o||{ELEMENT_NODE:1,TEXT_NODE:3};function s(n,i,s){if(n.nodeType===o.ELEMENT_NODE){var h=t.fromElement(n);if(h)return void s.currentLine.push(new r.Text(r.sentinelConstants.ENTITY_SENTINEL_CHARACTER,new r.Formatting(h.toAttributes())))}switch(n.nodeType){case o.TEXT_NODE:var c=n.nodeValue.replace(/[ \n\t]+/g," ");s.currentLine.push(r.Text(c,i.textFormatting));break;case o.ELEMENT_NODE:switch(i=function(t,e){for(var n=t.textFormatting,i=t.lineFormatting,o=e.split(";"),s=0;s<o.length;s++){var a=o[s].split(":");if(2===a.length){var h=r.utils.trim(a[0]).toLowerCase(),c=r.utils.trim(a[1]).toLowerCase();switch(h){case"text-decoration":var u=c.indexOf("underline")>=0,l=c.indexOf("line-through")>=0;n=n.underline(u).strike(l);break;case"font-weight":var p="bold"===c||parseInt(c)>=600;n=n.bold(p);break;case"font-style":var d="italic"===c||"oblique"===c;n=n.italic(d);break;case"color":n=n.color(c);break;case"background-color":n=n.backgroundColor(c);break;case"text-align":i=i.align(c);break;case"font-size":var f=null;r.utils.stringEndsWith(c,["px","pt","%","em","xx-small","x-small","small","medium","large","x-large","xx-large","smaller","larger"])?f=c:parseInt(c)&&(f=parseInt(c)+"px"),f&&(n=n.fontSize(f));break;case"font-family":var g=r.utils.trim(c.split(",")[0]);g=(g=g.replace(/['"]/g,"")).replace(/\w\S*/g,function(t){return t.charAt(0).toUpperCase()+t.substr(1).toLowerCase()}),n=n.font(g)}}}return t.withLineFormatting(i).withTextFormatting(n)}(i,n.getAttribute("style")||""),n.nodeName.toLowerCase()){case"div":case"h1":case"h2":case"h3":case"p":s.newlineIfNonEmpty(i),a(n,i,s),s.newlineIfNonEmpty(i);break;case"center":i=i.withAlign("center"),s.newlineIfNonEmpty(i),a(n,i.withAlign("center"),s),s.newlineIfNonEmpty(i);break;case"b":case"strong":a(n,i.withTextFormatting(i.textFormatting.bold(!0)),s);break;case"u":a(n,i.withTextFormatting(i.textFormatting.underline(!0)),s);break;case"i":case"em":a(n,i.withTextFormatting(i.textFormatting.italic(!0)),s);break;case"s":a(n,i.withTextFormatting(i.textFormatting.strike(!0)),s);break;case"font":var u=n.getAttribute("face"),l=n.getAttribute("color"),p=parseInt(n.getAttribute("size"));u&&(i=i.withTextFormatting(i.textFormatting.font(u))),l&&(i=i.withTextFormatting(i.textFormatting.color(l))),p&&(i=i.withTextFormatting(i.textFormatting.fontSize(p))),a(n,i,s);break;case"br":s.newline(i);break;case"ul":s.newlineIfNonEmptyOrListItem(i);var d="firepad-todo"===n.getAttribute("class")?e.TODO:e.UNORDERED;a(n,i.withListType(d).withIncreasedIndent(),s),s.newlineIfNonEmpty(i);break;case"ol":s.newlineIfNonEmptyOrListItem(i),a(n,i.withListType(e.ORDERED).withIncreasedIndent(),s),s.newlineIfNonEmpty(i);break;case"li":!function(t,r,n){n.newlineIfNonEmptyOrListItem(r);var i="firepad-checked"===t.getAttribute("class")?e.TODOCHECKED:r.listType;n.makeListItem(i);var o=n.currentLine;a(t,r,n),(o===n.currentLine||n.currentLine.length>0)&&n.newline(r)}(n,i,s);break;case"style":break;default:a(n,i,s)}}}function a(t,e,r){if(t.hasChildNodes())for(var n=0;n<t.childNodes.length;n++)s(t.childNodes[n],e,r)}return function(e,o){var a=(r.document||document).createElement("div");a.innerHTML=e,t=o;var h=new i;return s(a,new n,h),h.lines}}(),(r=r||{}).SerializeHtml=function(){var t=r.utils,e=r.AttributeConstants,n=r.LineFormatting.LIST_TYPE,i='<style>ul.firepad-todo { list-style: none; margin-left: 0; padding-left: 0; } ul.firepad-todo > li { padding-left: 1em; text-indent: -1em; } ul.firepad-todo > li:before { content: "\\2610"; padding-right: 5px; } ul.firepad-todo > li.firepad-checked:before { content: "\\2611"; padding-right: 5px; }</style>\n';function o(t){return t===n.ORDERED?"<ol>":t===n.UNORDERED?"<ul>":'<ul class="firepad-todo">'}function s(t){return t===n.ORDERED?"</ol>":"</ul>"}function a(t){return t.replace(/&/g,"&amp;").replace(/"/g,"&quot;").replace(/'/g,"&#39;").replace(/</g,"&lt;").replace(/>/g,"&gt;").replace(/\u00a0/g,"&nbsp;")}return function(h,c){for(var u,l,p="",d=!0,f=[],g=!1,m=!0,y=!0,v=0,_=h.ops[v],b=!1;_;){t.assert(_.isInsert());var E=_.attributes;if(d){d=!1;var C=0,x=null,w="left";e.LINE_SENTINEL in E&&(C=E[e.LINE_INDENT]||0,x=E[e.LIST_TYPE]||null,w=E[e.LINE_ALIGN]||"left"),x&&(C=C||1),g?(p+="</li>",g=!1):m||(y&&(p+="<br/>"),p+="</div>"),m=!1,t.assert(C>=0,"Indent must not be negative.");for(;f.length>C||C===f.length&&null!==x&&(u=x,l=f[f.length-1],!(u===l||u===n.TODO&&l===n.TODOCHECKED||u===n.TODOCHECKED&&l===n.TODO));)p+=s(f.pop());for(;f.length<C;){var A=x||n.UNORDERED;b=x==n.TODO||x==n.TODOCHECKED||b,p+=o(A),f.push(A)}var T="left"!==w?' style="text-align:'+w+'"':"";if(x){var L="";switch(x){case n.TODOCHECKED:L=' class="firepad-checked"';break;case n.TODO:L=' class="firepad-unchecked"'}p+="<li"+L+T+">",g=!0}else p+="<div"+T+">";y=!0}if(e.LINE_SENTINEL in E)_=h.ops[++v];else if(e.ENTITY_SENTINEL in E){for(var I=0;I<_.text.length;I++){var M=r.Entity.fromAttributes(E);p+=c.exportToElement(M).outerHTML}_=h.ops[++v]}else{var N="",S="";for(var k in E){var R,O,F=E[k];k===e.BOLD||k===e.ITALIC||k===e.UNDERLINE||k===e.STRIKE?(t.assert(!0===F),R=O=k):k===e.FONT_SIZE?(R='span style="font-size: '+F,R+="string"!=typeof F||-1===F.indexOf("px",F.length-2)?'px"':'"',O="span"):k===e.FONT?(R='span style="font-family: '+F+'"',O="span"):k===e.COLOR?(R='span style="color: '+F+'"',O="span"):k===e.BACKGROUND_COLOR?(R='span style="background-color: '+F+'"',O="span"):t.log(!1,"Encountered unknown attribute while rendering html: "+k),R&&(N+="<"+R+">"),O&&(S="</"+O+">"+S)}var D=_.text,P=D.indexOf("\n");P>=0?(d=!0,_=P<D.length-1?new r.TextOp("insert",D.substr(P+1),E):h.ops[++v],D=D.substr(0,P)):_=h.ops[++v],(D=D.replace(/  +/g,function(t){return new Array(t.length+1).join(" ")}).replace(/^ /," ").replace(/ $/," ")).length>0&&(y=!1),p+=N+a(D)+S}}for(g?p+="</li>":m||(y&&(p+="&nbsp;"),p+="</div>");f.length>0;)p+=s(f.pop());return b&&(p=i+p),p}}(),(r=r||{}).textPiecesToInserts=function(t,e){var n=[];function i(e,i){e instanceof r.Text&&(i=e.formatting.attributes,e=e.text),n.push({string:e,attributes:i}),t="\n"===e[e.length-1]}function o(e,n){t&&i(r.sentinelConstants.LINE_SENTINEL_CHARACTER,e.formatting.attributes);for(var o=0;o<e.textPieces.length;o++)i(e.textPieces[o]);n&&i("\n")}for(var s=0;s<e.length;s++)e[s]instanceof r.Line?o(e[s],s<e.length-1):i(e[s]);return n},(r=r||{}).Headless=function(){var t=r.TextOperation,e=r.FirebaseAdapter,n=r.EntityManager,i=r.ParseHtml;function o(t){if(!(this instanceof o))return new o(t);var r,i;"string"==typeof t?(void 0===window.firebase&&"object"!=typeof r?(console.log("REQUIRING"),r=require("firebase")):r=window.firebase,i=r.database().refFromURL(t)):i=t,this.entityManager_=new n,this.firebaseAdapter_=new e(i),this.ready_=!1,this.zombie_=!1}return o.prototype.getDocument=function(t){var e=this;if(e.ready_)return t(e.firebaseAdapter_.getDocument());e.firebaseAdapter_.on("ready",function(){e.ready_=!0,t(e.firebaseAdapter_.getDocument())})},o.prototype.getText=function(t){if(this.zombie_)throw new Error("You can't use a firepad.Headless after calling dispose()!");this.getDocument(function(e){var n=e.apply("");for(var i in r.sentinelConstants)n=n.replace(new RegExp(r.sentinelConstants[i],"g"),"");t(n)})},o.prototype.setText=function(e,r){if(this.zombie_)throw new Error("You can't use a firepad.Headless after calling dispose()!");var n=t().insert(e);this.sendOperationWithRetry(n,r)},o.prototype.initializeFakeDom=function(t){if("object"==typeof document||"object"==typeof r.document)t();else{const e=require("jsdom"),{JSDOM:n}=e,{window:i}=new n("<head></head><body></body>");if(r.document)return i.close(),t();r.document=i.document,t()}},o.prototype.getHtml=function(t){var e=this;if(this.zombie_)throw new Error("You can't use a firepad.Headless after calling dispose()!");e.initializeFakeDom(function(){e.getDocument(function(n){t(r.SerializeHtml(n,e.entityManager_))})})},o.prototype.setHtml=function(e,n){var o=this;if(this.zombie_)throw new Error("You can't use a firepad.Headless after calling dispose()!");o.initializeFakeDom(function(){for(var s=i(e,o.entityManager_),a=r.textPiecesToInserts(!0,s),h=new t,c=0;c<a.length;c++)h.insert(a[c].string,a[c].attributes);o.sendOperationWithRetry(h,n)})},o.prototype.sendOperationWithRetry=function(t,e){var r=this;r.getDocument(function(n){var i=t.clone().delete(n.targetLength);r.firebaseAdapter_.sendOperation(i,function(n,i){i?void 0!==e&&e(null,i):r.sendOperationWithRetry(t,e)})})},o.prototype.dispose=function(){this.zombie_=!0,this.firebaseAdapter_.dispose()},o}(),(r=r||{}).Firepad=function(t){if(!r.RichTextCodeMirrorAdapter)throw new Error("Oops! It looks like you're trying to include lib/firepad.js directly.  This is actually one of many source files that make up firepad.  You want dist/firepad.js instead.");var e=r.RichTextCodeMirrorAdapter,n=r.RichTextCodeMirror,i=r.RichTextToolbar,o=r.ACEAdapter,s=r.MonacoAdapter,a=r.FirebaseAdapter,h=r.EditorClient,c=r.EntityManager,u=r.AttributeConstants,l=r.utils,p=(r.LineFormatting.LIST_TYPE,t.CodeMirror),d=t.ace;t.monaco;function f(r,i,u/*wb+*/,no_edits,dataref,usrref/*+wb*/){if(!(this instanceof f))return new f(r,i,u/*wb+*/,no_edits,dataref,usrref/*+wb*/);if(!p&&!d&&!t.monaco)throw new Error("Couldn't find CodeMirror, ACE or Monaco.  Did you forget to include codemirror.js/ace.js or import monaco?");if(this.zombie_=!1,p&&i instanceof p){this.codeMirror_=this.editor_=i;
+
+var m=this.codeMirror_.getValue();if(""!==m)throw new Error("Can't initialize Firepad with a CodeMirror instance that already contains text.")}else if(d&&i&&i.session instanceof d.EditSession){
+
+if(this.ace_=this.editor_=i,""!==(m=this.ace_.getValue()))throw new Error("Can't initialize Firepad with an ACE instance that already contains text.")}else if(t.monaco&&i&&i instanceof t.monaco.constructor){
+
+if(t.monaco,this.monaco_=this.editor_=i,""!==(m=this.monaco_.getValue())/*wb+*/&&!no_edits/*+wb*/)throw new Error("Can't initialize Firepad with a Monaco instance that already contains text.")}else this.codeMirror_=this.editor_=new p(i);var y;y=this.codeMirror_?this.codeMirror_.getWrapperElement():this.ace_?this.ace_.container:this.monaco_.getDomNode(),
+this.parentNode = y.parentNode,
+this.firepadWrapper_=l.elt("div",null,{class:"firepad"}),y.parentNode.replaceChild(this.firepadWrapper_,y),this.firepadWrapper_.appendChild(y),l.on(y,"dragstart",l.stopEvent),this.editor_.firepad=this,this.options_=u||{},this.getOption("richTextShortcuts",!1)&&(p.keyMap.richtext||this.initializeKeyMap_(),this.codeMirror_.setOption("keyMap","richtext"),this.firepadWrapper_.className+=" firepad-richtext"),this.imageInsertionUI=this.getOption("imageInsertionUI",!0),this.getOption("richTextToolbar",!1)&&(this.addToolbar_(),this.firepadWrapper_.className+=" firepad-richtext firepad-with-toolbar"),
+this.addPoweredByLogo_(),this.codeMirror_&&this.codeMirror_.refresh();var v=this.getOption("userId",r.push().key),_=this.getOption("userColor",function(t){for(var e=1,r=0;r<t.length;r++)e=17*(e+t.charCodeAt(r))%360;return function(t,e,r){if(0===e)return g(r,r,r);var n=r<.5?r*(1+e):r+e-e*r,i=2*r-n,o=function(t){return t<0&&(t+=1),t>1&&(t-=1),6*t<1?i+6*(n-i)*t:2*t<1?n:3*t<2?i+6*(n-i)*(2/3-t):i};return g(o(t+1/3),o(t),o(t-1/3))}(e/360,/*wb+*/.5,.35/*+wb*//*wb-1,.75*/)}(v));this.entityManager_=new c,this.firebaseAdapter_=new a(r,v,_/*wb+*/,dataref,usrref/*+wb*/),this.codeMirror_?(this.richTextCodeMirror_=new n(this.codeMirror_,this.entityManager_,{cssPrefix:"firepad-"}),this.editorAdapter_=new e(this.richTextCodeMirror_)):this.ace_?this.editorAdapter_=new o(this.ace_):this.editorAdapter_=new s(this.monaco_),this.client_=new h(this.firebaseAdapter_,this.editorAdapter_);
+/*wb+*/
+if(no_edits){
+    this.editorAdapter_.setNoEdits(true);
+};
+/*+wb*/
+var b=this;this.firebaseAdapter_.on("cursor",function(){b.trigger.apply(b,["cursor"].concat([].slice.call(arguments)))}),this.codeMirror_&&this.richTextCodeMirror_.on("newLine",function(){b.trigger.apply(b,["newLine"].concat([].slice.call(arguments)))}),this.firebaseAdapter_.on("ready",function(){b.ready_=!0,this.ace_&&this.editorAdapter_.grabDocumentState(),this.monaco_&&this.editorAdapter_.grabDocumentState();var t=b.getOption("defaultText",null);t&&b.isHistoryEmpty()&&b.setText(t),b.trigger("ready")}),this.client_.on("synced",function(t){b.trigger("synced",t)}),"Microsoft Internet Explorer"==navigator.appName&&navigator.userAgent.match(/MSIE 8\./)&&(window.onload=function(){var t=document.getElementsByTagName("head")[0],e=document.createElement("style");e.type="text/css",e.styleSheet.cssText=":before,:after{content:none !important;}",t.appendChild(e),setTimeout(function(){t.removeChild(e)},0)})}
+function g(t,e,r){function n(t){var e=Math.round(255*t).toString(16);return 1===e.length?"0"+e:e}return"#"+n(t)+n(e)+n(r)}return l.makeEventEmitter(f),f.fromCodeMirror=f,f.fromACE=f,f.fromMonaco=f,
+f.prototype.detach=function(){
+    log1("in detach");
+    this.codeMirror_?editorWrapper=this.codeMirror_.getWrapperElement():this.ace_?editorWrapper=this.ace_.container:editorWrapper=this.monaco_.getDomNode(),
+    log1(editorWrapper.className),
+    this.firepadWrapper_.removeChild(editorWrapper),
+    this.firepadWrapper_.parentNode.replaceChild(editorWrapper, this.firepadWrapper_),
+    //this.firepadWrapper_.parentNode.removeChild(this.firepadWrapper_),
+    //this.editorAdapter_.onBlur();
+    this.editorAdapter_.detach();
+    this.detached=true;
+},
+f.prototype.reattach=function(){
+    log1("in reattach");
+    this.codeMirror_?editorWrapper=this.codeMirror_.getWrapperElement():this.ace_?editorWrapper=this.ace_.container:editorWrapper=this.monaco_.getDomNode(),
+    log1(editorWrapper.className),
+    editorWrapper.parentNode.replaceChild(this.firepadWrapper_, editorWrapper),
+    this.firepadWrapper_.appendChild(editorWrapper),
+    //this.parentNode.appendChild(this.firepadWrapper_),
+    this.editorAdapter_.reattach();
+    this.editorAdapter_.onFocus(),
+    this.detached=false;
+},
+f.prototype.destroy=function(){
+    this.zombie_=!0;
+    if(!this.detached){
+	this.detach();
+    }
+    //this.editorAdapter_.modelData._dispose();
+    this.monaco_._postDetachModelCleanup(this.monacoModel);
+    this.editor_.firepad=null,
+    this.codeMirror_&&"richtext"===this.codeMirror_.getOption("keyMap")&&this.codeMirror_.setOption("keyMap","default"),this.firebaseAdapter_.dispose(),this.editorAdapter_.detach(),this.richTextCodeMirror_&&this.richTextCodeMirror_.detach()},
+//f.prototype.getModelData=function(){
+//    return this.editorAdapter_.modelData;
+//},
+f.prototype.dispose=function(){
+    this.zombie_=!0,
+    this.codeMirror_?editorWrapper=this.codeMirror_.getWrapperElement():this.ace_?editorWrapper=this.ace_.container:editorWrapper=this.monaco_.getDomNode(),
+    this.firepadWrapper_.removeChild(editorWrapper),
+    this.firepadWrapper_.parentNode.replaceChild(editorWrapper,this.firepadWrapper_),
+    this.editor_.firepad=null,
+    this.codeMirror_&&"richtext"===this.codeMirror_.getOption("keyMap")&&this.codeMirror_.setOption("keyMap","default"),this.firebaseAdapter_.dispose(),this.editorAdapter_.detach(),this.richTextCodeMirror_&&this.richTextCodeMirror_.detach()},
+
+f.prototype.setUserId=function(t){this.firebaseAdapter_.setUserId(t)},f.prototype.setUserColor=function(t){this.firebaseAdapter_.setColor(t)},f.prototype.getText=function(){return this.assertReady_("getText"),this.codeMirror_?this.richTextCodeMirror_.getText():this.ace_?this.ace_.getSession().getDocument().getValue():this.monaco_.getModel().getValue()},f.prototype.setText=function(t){return this.assertReady_("setText"),this.monaco_?this.monaco_.getModel().setValue(t):this.ace_?this.ace_.getSession().getDocument().setValue(t):(this.codeMirror_.getWrapperElement().setAttribute("style","display: none"),this.codeMirror_.setValue(""),this.insertText(0,t),this.codeMirror_.getWrapperElement().setAttribute("style",""),this.codeMirror_.refresh(),void this.editorAdapter_.setCursor({position:0,selectionEnd:0}))},f.prototype.insertTextAtCursor=function(t){this.insertText(this.codeMirror_.indexFromPos(this.codeMirror_.getCursor()),t)},f.prototype.insertText=function(t,e){l.assert(!this.ace_,"Not supported for ace yet."),l.assert(!this.monaco_,"Not supported for monaco yet."),this.assertReady_("insertText"),"[object Array]"!==Object.prototype.toString.call(e)&&(e=[e]);var n=this;n.codeMirror_.operation(function(){for(var i=0===t,o=r.textPiecesToInserts(i,e),s=0;s<o.length;s++){var a=o[s].string,h=o[s].attributes;n.richTextCodeMirror_.insertText(t,a,h),t+=a.length}})},f.prototype.getOperationForSpan=function(t,e){for(var n=this.richTextCodeMirror_.getRange(t,e),i=this.richTextCodeMirror_.getAttributeSpans(t,e),o=0,s=new r.TextOperation,a=0;a<i.length;a++)s.insert(n.substr(o,i[a].length),i[a].attributes),o+=i[a].length;return s},f.prototype.getHtml=function(){return this.getHtmlFromRange(null,null)},f.prototype.getHtmlFromSelection=function(){var t=this.codeMirror_.getCursor("start"),e=this.codeMirror_.getCursor("end"),r=this.codeMirror_.indexFromPos(t),n=this.codeMirror_.indexFromPos(e);return this.getHtmlFromRange(r,n)},f.prototype.getHtmlFromRange=function(t,e){this.assertReady_("getHtmlFromRange");var n=null!=t&&null!=e?this.getOperationForSpan(t,e):this.getOperationForSpan(0,this.codeMirror_.getValue().length);return r.SerializeHtml(n,this.entityManager_)},f.prototype.insertHtml=function(t,e){var n=r.ParseHtml(e,this.entityManager_);this.insertText(t,n)},f.prototype.insertHtmlAtCursor=function(t){this.insertHtml(this.codeMirror_.indexFromPos(this.codeMirror_.getCursor()),t)},f.prototype.setHtml=function(t){var e=r.ParseHtml(t,this.entityManager_);this.setText(e)},f.prototype.isHistoryEmpty=function(){return this.assertReady_("isHistoryEmpty"),this.firebaseAdapter_.isHistoryEmpty()},f.prototype.bold=function(){this.richTextCodeMirror_.toggleAttribute(u.BOLD),this.codeMirror_.focus()},f.prototype.italic=function(){this.richTextCodeMirror_.toggleAttribute(u.ITALIC),this.codeMirror_.focus()},f.prototype.underline=function(){this.richTextCodeMirror_.toggleAttribute(u.UNDERLINE),this.codeMirror_.focus()},f.prototype.strike=function(){this.richTextCodeMirror_.toggleAttribute(u.STRIKE),this.codeMirror_.focus()},f.prototype.fontSize=function(t){this.richTextCodeMirror_.setAttribute(u.FONT_SIZE,t),this.codeMirror_.focus()},f.prototype.font=function(t){this.richTextCodeMirror_.setAttribute(u.FONT,t),this.codeMirror_.focus()},f.prototype.color=function(t){this.richTextCodeMirror_.setAttribute(u.COLOR,t),this.codeMirror_.focus()},f.prototype.highlight=function(){this.richTextCodeMirror_.toggleAttribute(u.BACKGROUND_COLOR,"rgba(255,255,0,.65)"),this.codeMirror_.focus()},f.prototype.align=function(t){if("left"!==t&&"center"!==t&&"right"!==t)throw new Error('align() must be passed "left", "center", or "right".');this.richTextCodeMirror_.setLineAttribute(u.LINE_ALIGN,t),this.codeMirror_.focus()},f.prototype.orderedList=function(){this.richTextCodeMirror_.toggleLineAttribute(u.LIST_TYPE,"o"),this.codeMirror_.focus()},f.prototype.unorderedList=function(){this.richTextCodeMirror_.toggleLineAttribute(u.LIST_TYPE,"u"),this.codeMirror_.focus()},f.prototype.todo=function(){this.richTextCodeMirror_.toggleTodo(),this.codeMirror_.focus()},f.prototype.newline=function(){this.richTextCodeMirror_.newline()},f.prototype.deleteLeft=function(){this.richTextCodeMirror_.deleteLeft()},f.prototype.deleteRight=function(){this.richTextCodeMirror_.deleteRight()},f.prototype.indent=function(){this.richTextCodeMirror_.indent(),this.codeMirror_.focus()},f.prototype.unindent=function(){this.richTextCodeMirror_.unindent(),this.codeMirror_.focus()},f.prototype.undo=function(){this.codeMirror_.undo()},f.prototype.redo=function(){this.codeMirror_.redo()},f.prototype.insertEntity=function(t,e,r){this.richTextCodeMirror_.insertEntityAtCursor(t,e,r)},f.prototype.insertEntityAt=function(t,e,r,n){this.richTextCodeMirror_.insertEntityAt(t,e,r,n)},f.prototype.registerEntity=function(t,e){this.entityManager_.register(t,e)},f.prototype.getOption=function(t,e){return t in this.options_?this.options_[t]:e},f.prototype.assertReady_=function(t){if(!this.ready_)throw new Error('You must wait for the "ready" event before calling '+t+".");if(this.zombie_)throw new Error("You can't use a Firepad after calling dispose()!  [called "+t+"]")},f.prototype.makeImageDialog_=function(){this.makeDialog_("img","Insert image url")},f.prototype.makeDialog_=function(t,e){var r=this,n=l.elt("input",null,{class:"firepad-dialog-input",id:t,type:"text",placeholder:e,autofocus:"autofocus"}),i=l.elt("a","Submit",{class:"firepad-btn",id:"submitbtn"});l.on(i,"click",l.stopEventAnd(function(){var e=document.getElementById("overlay");e.style.visibility="hidden";var n=document.getElementById(t).value;null!==n&&r.insertEntity(t,{src:n}),r.firepadWrapper_.removeChild(e)}));var o=l.elt("a","Cancel",{class:"firepad-btn"});l.on(o,"click",l.stopEventAnd(function(){var t=document.getElementById("overlay");t.style.visibility="hidden",r.firepadWrapper_.removeChild(t)}));var s=l.elt("div",[i,o],{class:"firepad-btn-group"}),a=l.elt("div",[n,s],{class:"firepad-dialog-div"}),h=l.elt("div",[a],{class:"firepad-dialog",id:"overlay"});this.firepadWrapper_.appendChild(h)},f.prototype.addToolbar_=function(){this.toolbar=new i(this.imageInsertionUI),this.toolbar.on("undo",this.undo,this),this.toolbar.on("redo",this.redo,this),this.toolbar.on("bold",this.bold,this),this.toolbar.on("italic",this.italic,this),this.toolbar.on("underline",this.underline,this),this.toolbar.on("strike",this.strike,this),this.toolbar.on("font-size",this.fontSize,this),this.toolbar.on("font",this.font,this),this.toolbar.on("color",this.color,this),this.toolbar.on("left",function(){this.align("left")},this),this.toolbar.on("center",function(){this.align("center")},this),this.toolbar.on("right",function(){this.align("right")},this),this.toolbar.on("ordered-list",this.orderedList,this),this.toolbar.on("unordered-list",this.unorderedList,this),this.toolbar.on("todo-list",this.todo,this),this.toolbar.on("indent-increase",this.indent,this),this.toolbar.on("indent-decrease",this.unindent,this),this.toolbar.on("insert-image",this.makeImageDialog_,this),this.firepadWrapper_.insertBefore(this.toolbar.element(),this.firepadWrapper_.firstChild)},/*wb+*/f.prototype.getNoEdits=function(){return this.editorAdapter_.getNoEdits()},f.prototype.setNoEdits=function(edits){this.editorAdapter_.setNoEdits(edits);},/*+wb*/f.prototype.addPoweredByLogo_=function(){var t=l.elt("a",null,{class:wb_monaco.logo});t.setAttribute("href","http://www.firepad.io/"),t.setAttribute("target","_blank"),this.firepadWrapper_.appendChild(t)},f.prototype.initializeKeyMap_=function(){function t(t){return function(e){setTimeout(function(){t.call(e.firepad)},0)}}p.keyMap.richtext={"Ctrl-B":t(this.bold),"Cmd-B":t(this.bold),"Ctrl-I":t(this.italic),"Cmd-I":t(this.italic),"Ctrl-U":t(this.underline),"Cmd-U":t(this.underline),"Ctrl-H":t(this.highlight),"Cmd-H":t(this.highlight),Enter:t(this.newline),Delete:t(this.deleteRight),Backspace:t(this.deleteLeft),Tab:t(this.indent),"Shift-Tab":t(this.unindent),fallthrough:["default"]}},f}(this),r.Firepad.Formatting=r.Formatting,r.Firepad.Text=r.Text,r.Firepad.Entity=r.Entity,r.Firepad.LineFormatting=r.LineFormatting,r.Firepad.Line=r.Line,r.Firepad.TextOperation=r.TextOperation,r.Firepad.Headless=r.Headless,r.Firepad.RichTextCodeMirrorAdapter=r.RichTextCodeMirrorAdapter,r.Firepad.ACEAdapter=r.ACEAdapter,r.Firepad.MonacoAdapter=r.MonacoAdapter,r.Firepad},this);
diff --git a/cpr/coderpair.js b/cpr/coderpair.js
new file mode 100644
index 00000000..bf24fac9
--- /dev/null
+++ b/cpr/coderpair.js
@@ -0,0 +1,354 @@
+// Copyright (C) Robert Beach. All rights reserved.
+// Coderpair Firepad Integration
+
+(function(){
+    // resourceMap  maps resource to firepadMap
+    // firepadMap maps instance identifier to firepad instance
+    resourceMap = new Map();
+
+    var activeModel;
+        
+    wb_monaco.currentGroup = 0;
+    
+    wb_monaco.modelsMap = new Map();
+    wb_monaco.suppressSave = false;
+    wb_monaco.suppressTriggerDiff = false;
+    wb_monaco.autoSaveDelay = 200;
+    wb_monaco.timeout1 = null;
+
+    wb_monaco.setRange = function (range) {
+        if(!monaco.Range)
+            monaco.Range = range;
+    };
+
+    /*
+    *  connectEditorToFirepad
+    *
+    *  editor: ICodeEditor  (The monaco editor)
+    *  resource: string (The location of the resource)
+    *  instanceID: string (Identifies a unique instance of an open resource)
+    *  options: object (optional parameters)
+    *
+    */
+    wb_monaco.connectEditorToFirepad = function (editor, resource, instanceID, options) {
+        log1("in connectEditorToFirepad: " + editor._id + ' ' + resource.path + ' ' + instanceID);
+        if (wb_monaco.disabled || resource.scheme=='untitled') return;
+        var model = editor.getModel();
+        if (model) {
+            log2("has model");
+            if (!wb_monaco.modelsMap.has(model)) {
+                log2("setting model");
+                wb_monaco.modelsMap.set(model,new Map());
+            };
+            var firepadMap = wb_monaco.modelsMap.get(model);
+            wb_monaco.goToRange=null;
+            if (!firepadMap.has(editor._id)) {
+                log2("firepadMap has editor id");
+                firepadMap.set(editor._id, null);
+                wb_monaco.suppressSave = true;
+                if(options && options.diff_original){
+                    wb_monaco.suppressTriggerDiff = true;
+                }
+                var value = model.getValue();
+                model.instanceId = instanceID;
+                log2('mtoi '+moreThanOneInstance(model));
+                var mtoi = moreThanOneInstance(model);
+                if(!mtoi)model.setValue('');
+                wb_monaco.suppressTriggerDiff = false;
+                wb_monaco.suppressSave = false;
+                initFirepad(model, editor, resource, value, mtoi)
+            }
+        }
+    };
+
+    function initFirepad(model, editor, resource, value, mtoi) {
+        var path = model.uri.path.replace(/\./gi, "_");
+        log2("initFirepad path: " + path);
+        var ref = firebase.database().ref();
+        var fileref = ref.child(wb_monaco.firepad_ref.childref + "/files" + path);
+
+        // Create a data file indicator for the path, if it does not exist
+        var dataref = ref.child(wb_monaco.firepad_ref.childref + "/data" + path);
+        var usrref = ref.child('users/' + wb_monaco.user);
+        dataref.transaction(function (currentData) {
+            if (currentData === null || currentData === 1) {
+                return 1;
+            } else {
+                log2('File ready');
+                return; // Abort the transaction.
+            }
+        }, function (error, committed, snapshot) {
+            var readyState = 0;
+            if (error) {
+                log2('Transaction I failed abnormally!', error);
+            } else if (!committed) {
+                readyState = 2;
+                log2('We aborted the transaction (because file exists).');
+            } else {
+                log2('File pending');
+                readyState = 1;
+            }
+            if (readyState != 0) {
+                if (readyState == 1) {
+                    fileref.child('history').orderByKey().limitToLast(1).once("value").then(function(snapshot) {
+                        var characters = '0123456789ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz';
+                        function revisionToId(revision) {
+                            if (revision === 0) {
+                            return 'A0';
+                            }
+        
+                            var str = '';
+                            while (revision > 0) {
+                            var digit = (revision % characters.length);
+                            str = characters[digit] + str;
+                            revision -= digit;
+                            revision /= characters.length;
+                            }
+        
+                            // Prefix with length (starting at 'A' for length 1) to ensure the id's sort lexicographically.
+                            var prefix = characters[str.length + 9];
+                            return prefix + str;
+                        }
+        
+                        function revisionFromId(revisionId) {
+                            
+                            var revision = 0;
+                            for(var i = 1; i < revisionId.length; i++) {
+                            revision *= characters.length;
+                            revision += characters.indexOf(revisionId[i]);
+                            }
+                            return revision;
+                        }
+
+                        var key = "A0";
+                        var rev = snapshot.val();
+                        if(rev){
+                            key = Object.keys(rev)[0];
+                            var id = revisionFromId(key);
+                            id++;
+                            key = revisionToId(id);
+                            fileref.child('history').child(key).transaction(function (currentData) {
+                                if (currentData === null){
+                                    log2('First entry');
+                                    return {
+                                            "a": "-MD3FwTopQvGVUeAtriv", // Random dummy user
+                                            "o": [value,true],
+                                            "t": firebase.database.ServerValue.TIMESTAMP
+                                        };
+                                }else{
+                                    return;
+                                }
+                            }, function (error, committed, snapshot) {
+                                if (error) {
+                                    log2('Transaction II failed abnormally!', error);
+                                } else {
+                                    log2('File OK');
+                                    dataref.set(2);
+                                    document.activeElement.blur();
+                                    var firepad = Firepad.fromMonaco(fileref, editor, {userId: wb_monaco.user}, mtoi,dataref,usrref);
+                                    wb_monaco.modelsMap.get(model).set(editor._id,firepad);
+                                    firepad.on('ready', function () {
+                                        // Firepad is ready.
+                                        setRange();
+                                    });
+                                }
+                            });
+                        }else{
+                            fileref.transaction(function (currentData) {
+                                if (currentData === null){
+                                    log2('First entry');
+                                    return {
+                                        "history": {
+                                            "A0": {
+                                                "a": "-MD3FwTopQvGVUeAtriv", // Random dummy user
+                                                "o": [value],
+                                                "t": firebase.database.ServerValue.TIMESTAMP
+                                            }
+                                        }
+                                    };
+                                    
+                                }else{
+                                    return;
+                                }
+                                }, function (error, committed, snapshot) {
+                                if (error) {
+                                    log2('Transaction II failed abnormally!', error);
+                                } else {
+                                    log2('File OK');
+                                    dataref.set(2);
+                                    document.activeElement.blur();
+                                    var firepad = Firepad.fromMonaco(fileref, editor, {userId: wb_monaco.user}, mtoi,dataref,usrref);
+                                    wb_monaco.modelsMap.get(model).set(editor._id,firepad);
+                                    firepad.on('ready', function () {
+                                        // Firepad is ready.
+                                        setRange();
+                                    });
+                                }
+                            });
+                        }
+                    });
+                } else {
+                    document.activeElement.blur();
+                    var firepad = Firepad.fromMonaco(fileref, editor, {userId: wb_monaco.user}, mtoi,dataref,usrref);
+                    wb_monaco.modelsMap.get(model).set(editor._id,firepad);
+                    firepad.on('ready', function () {
+                        // Firepad is ready.
+                        setRange();
+                    });
+                }
+            }
+        });
+    };
+
+    function setRange(){
+        if(wb_monaco.goToRange){
+            wb_monaco.goToRange.editor.revealRangeInCenter(wb_monaco.goToRange.range)
+        }
+        wb_monaco.goToRange=null;
+    };
+
+    function moreThanOneInstance(model){
+        return (wb_monaco.modelsMap.get(model)).size>1;
+    };
+
+    wb_monaco.setActiveModel =  function(model){
+        if(wb_monaco.disabled)return;
+        if(!model){
+            if(activeModel){
+                clearTimeout(wb_monaco.timeout1);
+                wb_monaco.timeout1 = setTimeout(wb_monaco.writePathRef,200)
+            }
+            activeModel = null;
+            return;
+        }
+        var same = false;
+        if(activeModel){
+            if(activeModel.uri.path == model.uri.path){
+                same = true;
+            }
+        }
+        activeModel = model;
+        if(!same){
+            clearTimeout(wb_monaco.timeout1);
+            wb_monaco.timeout1 = setTimeout(wb_monaco.writePathRef,200)
+        }
+    };
+
+    wb_monaco.writePathRef = function(){
+       if(activeModel){
+            firebase.database().ref('users/' + wb_monaco.user).child("path").set(activeModel.uri.path);
+       }else{
+            firebase.database().ref('users/' + wb_monaco.user).child("path").remove();
+       }
+       firebase.database().ref('users/' + wb_monaco.user).child("cursor").remove();
+    }
+        
+    wb_monaco.destroyFirepad = function(model){
+        log2("in destroy firepad");
+        if(wb_monaco.disabled)
+            return;
+        var firepadMap=wb_monaco.modelsMap.get(model);
+        if(firepadMap){
+            for (let fp of firepadMap.values()) {
+                fp.destroy();
+            }
+            wb_monaco.modelsMap.delete(model);
+            log2("Firepad: delete model from map");
+        }
+    };
+
+    wb_monaco.attachFirepad = function(model,id){
+        log2("in attachFirepad");
+        if(isDebug && isDebug2)console.trace();
+        if(wb_monaco.disabled)
+            return;
+        var firepadMap=wb_monaco.modelsMap.get(model);
+        if(firepadMap){
+            var firepad=firepadMap.get(id);
+            if(firepad){
+                firepad.reattach();
+                firebase.database().ref('users/' + wb_monaco.user).child("path").set(model.uri.path);
+                log2("Firepad: reattach instance: " + model.uri)
+            }
+        }
+    };
+
+    wb_monaco.detachFirepad = function(model,id){
+        log2("in detachFirepad");
+        if(wb_monaco.disabled)
+            return;
+        var firepadMap=wb_monaco.modelsMap.get(model);
+        if(firepadMap){
+            var firepad=firepadMap.get(id);
+            if(firepad){
+                firepad.detach();
+                log2("Firepad: detach but don't delete: " + model.uri)
+            }
+        }
+    };
+
+    wb_monaco.hasPreviousModelData = function(model,id){
+        log2("in hasPreviousModelData");
+        if(wb_monaco.disabled)
+            return;
+        var firepadMap=wb_monaco.modelsMap.get(model);
+        if(firepadMap){
+            var firepad=firepadMap.get(id);
+            if(firepad){
+                return true;
+            }
+        }
+        return false;
+    };
+
+    wb_monaco.getPreviousModelData = function(model,id){
+        log2("in getPreviousModelData");
+        if(wb_monaco.disabled)
+            return;
+        var firepadMap=wb_monaco.modelsMap.get(model);
+        if(firepadMap){
+            var firepad=firepadMap.get(id);
+            if(firepad){
+                return firepad.getModelData();
+            }
+        }
+    };
+
+    wb_monaco.invalidate = async function(p){
+        log2("in invalidate: " + p);
+        if(wb_monaco.disabled)
+            return Promise.resolve(true);
+        var ref = firebase.database().ref();
+        var path = p.replace(/\./gi, "_");
+        var fileref = ref.child(wb_monaco.firepad_ref.childref + "/files" + path);
+        var dataref = ref.child(wb_monaco.firepad_ref.childref + "/data" + path);
+        log2("invalidate path: " + path);
+        await dataref.remove()
+        .then(function () {
+            log2('Remove done');
+        })
+        .catch(function(error) {
+            log2("Remove failed: " + error.message)
+            resolve(false);
+        });
+        return Promise.resolve(true)
+    };
+
+    wb_monaco.isInvalid = function(p){
+        if(wb_monaco.disabled)
+            return Promise.resolve(false);
+        var ref = firebase.database().ref();
+        var path = p.replace(/\./gi, "_");
+        var dataref = ref.child(wb_monaco.firepad_ref.childref + "/data" + path);
+        
+        return new Promise(resolve => {
+            dataref.once('value').then(function(snapshot) {
+                if(snapshot.val()==null){
+                    resolve(true);
+                }else{
+                    resolve(false);
+                }
+            });
+        });
+    }
+}());
diff --git a/cpr/hello.js b/cpr/hello.js
new file mode 100644
index 00000000..fbc50d74
--- /dev/null
+++ b/cpr/hello.js
@@ -0,0 +1 @@
+console.log(hi);
\ No newline at end of file
diff --git a/cpr/userlist.css b/cpr/userlist.css
new file mode 100644
index 00000000..9a5dd7ba
--- /dev/null
+++ b/cpr/userlist.css
@@ -0,0 +1,144 @@
+.firepad-userlist {
+  /* default height */
+  height: 230px;
+  min-width: 175px;
+  background: #333333; /* Old browsers */
+  color: #cccccc;
+  -webkit-box-shadow: -3px 2px 9px 2px rgba(0,0,0,0.59); 
+  box-shadow: -3px 2px 9px 2px rgba(0,0,0,0.59);
+}
+
+.firepad-userlist {
+  text-align: left;
+  font-family: 'Helvetica Neue', sans-serif;
+  line-height: normal;
+  padding:15px;
+}
+
+.firepad-userlist-close {
+  cursor:pointer;
+  position: absolute;
+  outline: none;
+  left: 277px;
+  top: 8px;
+  height:12px;
+  
+}
+
+.codicon.firepad-userlist-close {
+  color: #c5c5c5;
+}
+  
+  .firepad-userlist-heading {
+    font-size: 12px;
+    font-weight: bold;
+    color:#999999;
+    padding:2px;
+    border-bottom: 2px solid #555555;
+  }
+
+  .firepad-userlist-users-outer {
+    position: absolute;
+    left: 15px;
+    right: 15px;
+    top: 38px;
+    bottom: 10px;
+    height:208px;
+  }
+  
+  .firepad-userlist-users {
+    height:208px;
+  }
+  
+  .firepad-userlist-user {
+    position: relative;
+    cursor:pointer;
+    margin: 0px 0;
+    height: 32px;
+    border-bottom: 1px solid #555555;
+    padding:9px 0px 10px 0px;
+  }
+
+  .firepad-userlist-user:hover{
+    background: #363636;
+  }
+  
+  .firepad-userlist-color-indicator {
+    display: inline-block;
+    width: 32px;
+    height: 32px;
+    border: 1px solid #ccc;
+    -webkit-border-radius: 4px;
+    -moz-border-radius: 4px;
+    border-radius: 4px;
+  }
+  
+  input.firepad-userlist-name-input {
+    position: absolute;
+    background-color: #333333;
+    color:#cccccc;
+    left: 38px;
+    top: 6px;
+    width: 105px;
+    height: 20px;
+    border: 0;
+    border-bottom: 1px solid #5999bb;
+    -webkit-border-radius: 0;
+    -moz-border-radius: 0;
+    border-radius: 0;
+    font-size: 14px;
+    line-height: 14px;
+    padding: 1px;
+    outline:none;
+  }
+  
+  .firepad-userlist-name-hint {
+    position: absolute;
+    left: 38px;
+    top: 32px;
+    width: 300px; /* I'd rather it clip than wrap. */
+    font-size: 9px;
+    line-height: 11px;
+  }
+  
+  .firepad-userlist-name {
+    position: absolute;
+    top: 11px;
+    left: 38px;
+    width: 290px;
+    font-size: 13px;
+  }
+
+  .firepad-user-line {
+    font-size: 12px;
+    margin-left:10px;
+  }
+
+  .firepad-user-path-inner {
+    font-size: 12px;
+    height:14px;
+    font-family: 'Helvetica Neue', sans-serif;
+  }
+
+  .firepad-user-path {
+    position: absolute;
+    top: 29px;
+    left: 38px;
+    height:14px;
+  }
+  
+  /*
+    overflow-x: scroll;
+    overflow-y: hidden;
+    user-select:auto;
+    -webkit-user-select:auto;
+    touch-action: auto;
+    scrollbar-width: none;  
+    -ms-overflow-style: none; 
+  }
+  */
+
+  .firepad-user-path::-webkit-scrollbar {
+    width: 0px;
+     background: transparent; /* Chrome/Safari/Webkit */
+  }
\ No newline at end of file
diff --git a/cpr/userlist.js b/cpr/userlist.js
new file mode 100644
index 00000000..0a1c6859
--- /dev/null
+++ b/cpr/userlist.js
@@ -0,0 +1,354 @@
+var FirepadUserList = (function() {
+    const SLIDER_OFFSET = 57;
+    const USERDIV_WIDTH = 220;
+    function FirepadUserList(ref, place, userId, displayName) {
+      if (!(this instanceof FirepadUserList)) {
+        return new FirepadUserList(ref, place, userId, displayName);
+      }
+  
+      this.ref_ = ref;
+      this.userId_ = userId;
+      this.place_ = place;
+      this.firebaseCallbacks_ = [];
+  
+      var self = this;
+      this.hasName_ = !!displayName;
+      this.displayName_ = displayName || 'Guest ' + Math.floor(Math.random() * 1000);
+      this.firebaseOn_(ref.root.child('.info/connected'), 'value', function(s) {
+        if (s.val() !== true) {
+          wb_monaco.setActiveModel(null);
+        }
+        if (s.val() === true && self.displayName_) {
+          var nameRef = ref.child(self.userId_).child('name');
+          var userRef = ref.child(self.userId_);
+          userRef.onDisconnect().remove();
+          nameRef.set(self.displayName_);
+          ref.child(self.userId_).child('color').set(colorFromUserId(self.userId_))
+        }
+      });
+    }
+    FirepadUserList.prototype.makeUserList = function(){
+      var userlist_users = elt('div', [
+        this.makeUserEntryForSelf_(),
+        this.makeUserEntriesForOthers_()
+      ], {'class': 'firepad-userlist-users' });
+      
+      var outer = elt('div', userlist_users, { 'class': 'firepad-userlist-users-outer'} );
+
+      var scrollbar = wb_monaco.coderpair.makeUserScrollbar(outer,userlist_users);
+        
+      this.userList_= elt('div', [
+        this.makeHeading_(),
+        outer
+      ], {'class': 'firepad-userlist' });
+  
+      //this.userList_.addEventListener("wheel", function(e){e.stopPropagation()}, {passive: false} );
+      this.place_.appendChild(this.userList_);
+      var close = elt('a', null, {'class': 'action-label codicon codicon-close firepad-userlist-close', 'role' : 'button','title':'close','tabindex':"0'"});
+      this.place_.appendChild(close);
+      $(".firepad-userlist-close").click(hideDialog)
+      //scrollbar._scrollable.setScrollPositionNow({scrollLeft:107});
+      //scrollbar._horizontalScrollbar._updateSlider2(57);
+    }
+
+    function hideDialog(){
+      wb_monaco.coderpair.hideDialog()
+    }
+  
+    // This is the primary "constructor" for symmetry with Firepad.
+    FirepadUserList.fromDiv = FirepadUserList;
+  
+    FirepadUserList.prototype.dispose = function() {
+      this.removeFirebaseCallbacks_();
+      this.ref_.child(this.userId_).remove();
+    
+      this.place_.removeChild(this.userList_);
+    };
+  
+    FirepadUserList.prototype.makeHeading_ = function() {
+      var counterSpan = elt('span', '0');
+      this.firebaseOn_(this.ref_, 'value', function(usersSnapshot) {
+        setTextContent(counterSpan, "" + usersSnapshot.numChildren());
+        wb_monaco.coderpair.setUserScrollbarDimensions(usersSnapshot.numChildren())
+      });
+  
+      return elt('div', [
+        elt('span', 'ONLINE ('),
+        counterSpan,
+        elt('span', ')')
+      ], { 'class': 'firepad-userlist-heading' });
+    };
+  
+    FirepadUserList.prototype.makeUserEntryForSelf_ = function() {
+      var myUserRef = this.ref_.child(this.userId_);
+  
+      var colorDiv = elt('div', null, { 'class': 'firepad-userlist-color-indicator' });
+      this.firebaseOn_(myUserRef.child('color'), 'value', function(colorSnapshot) {
+        var color = colorSnapshot.val();
+        if (isValidColor(color)) {
+          colorDiv.style.backgroundColor = color;
+        }
+      });
+  
+      var nameInput = elt('input', null, { type: 'text', 'class': 'firepad-userlist-name-input'} );
+      nameInput.value = this.displayName_;
+  
+      var nameHint = elt('div', 'ENTER YOUR NAME', { 'class': 'firepad-userlist-name-hint'} );
+      if (this.hasName_) nameHint.style.display = 'none';
+  
+      // Update Firebase when name changes.
+      var self = this;
+      on(nameInput, 'change', function(e) {
+        var name = nameInput.value || "Guest " + Math.floor(Math.random() * 1000);
+        myUserRef.onDisconnect().remove();
+        myUserRef.child('name').set(name);
+        nameHint.style.display = 'none';
+        nameInput.blur();
+        self.displayName_ = name;
+        stopEvent(e);
+      });
+  
+      var nameDiv = elt('div', [nameInput, nameHint]);
+  
+      return elt('div', [ colorDiv, nameDiv ], {
+        'class': 'firepad-userlist-user ' + 'firepad-user-' + this.userId_
+      });
+    };
+  
+    FirepadUserList.prototype.makeUserEntriesForOthers_ = function() {
+      var self = this;
+      var userList = elt('div');
+      var userId2Element = { };
+  
+      function updateChild(userSnapshot, prevChildName) {
+        var userId = userSnapshot.key;
+        var div = userId2Element[userId];
+        if (div) {
+          userList.removeChild(div);
+          delete userId2Element[userId];
+        }
+        var name = userSnapshot.child('name').val();
+        if (typeof name !== 'string') { name = 'Guest'; }
+        name = name.substring(0, 20);
+  
+        var color = userSnapshot.child('color').val();
+        if (!isValidColor(color)) {
+          color = "#ffb"
+        }
+
+        var path = userSnapshot.child('path').val() || '';
+        if(path.length && path.charAt(path.length-1) == "/"){
+          path = path.substr(0,path.length-1);
+        }
+
+        var pathLength = '5px';
+        if (path != '') {
+          pathLength = $.fn.textWidth(path, "12px 'Helvetica Neue', sans-serif")
+        }
+
+        var cursor = userSnapshot.child('cursor').val() || '';
+        if(cursor != "")
+          cursor = "ln: "+cursor.l+" col: "+cursor.c+"";
+  
+        var colorDiv = elt('div', null, { 'class': 'firepad-userlist-color-indicator' });
+        colorDiv.style.backgroundColor = color;
+  
+        var nameDiv = elt('div', name || 'Guest', { 'class': 'firepad-userlist-name' });
+
+        var lineDiv = elt('span', cursor, { 'class': 'firepad-user-line'} );
+
+        nameDiv.appendChild(lineDiv);
+
+        var pathDivInner = elt('div', path, { 'class': 'firepad-user-path-inner'} );
+        
+        //pathDivInner.addEventListener("wheel", function(e){e.stopPropagation()}, {passive: false} );
+        
+        pathDivInner.style.width = pathLength + 'px';
+        
+        var pathDiv = elt('div', [pathDivInner], { 'class': 'firepad-user-path'} );
+        
+        //pathDiv.addEventListener("wheel", function(e){e.stopPropagation()}, {passive: false} );
+
+        pathDiv.style.width = Math.min(pathLength,USERDIV_WIDTH)+'px';
+
+        var userDiv = elt('div', [ colorDiv, nameDiv,pathDiv], {
+          'class': 'firepad-userlist-user ' + 'firepad-user-' + userId
+        });
+
+        var scrollbar = wb_monaco.coderpair.makePathScrollbar(pathDiv,pathDivInner)
+        scrollbar.setScrollDimensions({width: USERDIV_WIDTH,scrollWidth:pathLength});
+        userId2Element[userId] = userDiv;
+  
+        if (userId === self.userId_) {
+          // HACK: We go ahead and insert ourself in the DOM, so we can easily order other users against it.
+          // But don't show it.
+          userDiv.style.display = 'none';
+        }else{
+          if(path)
+            $(userDiv).click({path: path,cursor:cursor},openURI);
+        }
+  
+        var nextElement =  prevChildName ? userId2Element[prevChildName].nextSibling : userList.firstChild;
+        userList.insertBefore(userDiv, nextElement);
+        scrollbar._scrollable.setScrollPositionNow({scrollLeft:2000});
+		    scrollbar._horizontalScrollbar._updateSlider2(SLIDER_OFFSET);
+      }
+  
+      this.firebaseOn_(this.ref_, 'child_added', updateChild);
+      this.firebaseOn_(this.ref_, 'child_changed', updateChild);
+      this.firebaseOn_(this.ref_, 'child_moved', updateChild);
+      this.firebaseOn_(this.ref_, 'child_removed', function(removedSnapshot) {
+        var userId = removedSnapshot.key;
+        var div = userId2Element[userId];
+        if (div) {
+          userList.removeChild(div);
+          delete userId2Element[userId];
+        }
+      });
+      return userList;
+    };
+
+    function openURI(event) {
+        if (!$(event.target).hasClass('scrollbar horizontal')) {
+          wb_monaco.coderpair.openURI(event.data.path,event.data.cursor)
+        }
+    };
+  
+    FirepadUserList.prototype.firebaseOn_ = function(ref, eventType, callback, context) {
+      this.firebaseCallbacks_.push({ref: ref, eventType: eventType, callback: callback, context: context });
+      ref.on(eventType, callback, context);
+      return callback;
+    };
+  
+    FirepadUserList.prototype.firebaseOff_ = function(ref, eventType, callback, context) {
+      ref.off(eventType, callback, context);
+      for(var i = 0; i < this.firebaseCallbacks_.length; i++) {
+        var l = this.firebaseCallbacks_[i];
+        if (l.ref === ref && l.eventType === eventType && l.callback === callback && l.context === context) {
+          this.firebaseCallbacks_.splice(i, 1);
+          break;
+        }
+      }
+    };
+  
+    FirepadUserList.prototype.removeFirebaseCallbacks_ = function() {
+      for(var i = 0; i < this.firebaseCallbacks_.length; i++) {
+        var l = this.firebaseCallbacks_[i];
+        l.ref.off(l.eventType, l.callback, l.context);
+      }
+      this.firebaseCallbacks_ = [];
+    };
+  
+    /** Assorted helpers */
+  
+    function isValidColor(color) {
+      return typeof color === 'string' &&
+        (color.match(/^#[a-fA-F0-9]{3,6}$/) || color == 'transparent');
+    }
+
+
+    $.fn.textWidth = function(text, font) {
+      if (!$.fn.textWidth.fakeEl) $.fn.textWidth.fakeEl = $('<span>').hide().appendTo(document.body);
+      $.fn.textWidth.fakeEl.text(text || this.val() || this.text()).css('font', font || this.css('font'));
+      return Math.round($.fn.textWidth.fakeEl.width())+5;
+    };
+
+    function colorFromUserId (userId) {
+      var a = 1;
+      for (var i = 0; i < userId.length; i++) {
+        a = 17 * (a+userId.charCodeAt(i)) % 360;
+      }
+      var hue = a/360;
+  
+      return hsl2hex(hue, .5, 0.35);
+    }
+  
+    function rgb2hex (r, g, b) {
+      function digits (n) {
+        var m = Math.round(255*n).toString(16);
+        return m.length === 1 ? '0'+m : m;
+      }
+      return '#' + digits(r) + digits(g) + digits(b);
+    }
+  
+    function hsl2hex (h, s, l) {
+      if (s === 0) { return rgb2hex(l, l, l); }
+      var var2 = l < 0.5 ? l * (1+s) : (l+s) - (s*l);
+      var var1 = 2 * l - var2;
+      var hue2rgb = function (hue) {
+        if (hue < 0) { hue += 1; }
+        if (hue > 1) { hue -= 1; }
+        if (6*hue < 1) { return var1 + (var2-var1)*6*hue; }
+        if (2*hue < 1) { return var2; }
+        if (3*hue < 2) { return var1 + (var2-var1)*6*(2/3 - hue); }
+        return var1;
+      };
+      return rgb2hex(hue2rgb(h+1/3), hue2rgb(h), hue2rgb(h-1/3));
+    }
+  
+  
+    /** DOM helpers */
+    function elt(tag, content, attrs) {
+      var e = document.createElement(tag);
+      if (typeof content === "string") {
+        setTextContent(e, content);
+      } else if (content) {
+        for (var i = 0; i < content.length; ++i) { e.appendChild(content[i]); }
+      }
+      for(var attr in (attrs || { })) {
+        e.setAttribute(attr, attrs[attr]);
+      }
+      return e;
+    }
+  
+    function setTextContent(e, str) {
+      e.innerHTML = "";
+      e.appendChild(document.createTextNode(str));
+    }
+  
+    function on(emitter, type, f) {
+      if (emitter.addEventListener) {
+        emitter.addEventListener(type, f, false);
+      } else if (emitter.attachEvent) {
+        emitter.attachEvent("on" + type, f);
+      }
+    }
+  
+    function off(emitter, type, f) {
+      if (emitter.removeEventListener) {
+        emitter.removeEventListener(type, f, false);
+      } else if (emitter.detachEvent) {
+        emitter.detachEvent("on" + type, f);
+      }
+    }
+  
+    function preventDefault(e) {
+      if (e.preventDefault) {
+        e.preventDefault();
+      } else {
+        e.returnValue = false;
+      }
+    }
+  
+    function stopPropagation(e) {
+      if (e.stopPropagation) {
+        e.stopPropagation();
+      } else {
+        e.cancelBubble = true;
+      }
+    }
+  
+    function stopEvent(e) {
+      preventDefault(e);
+      stopPropagation(e);
+    }
+  
+    return FirepadUserList;
+  })();
+  
+
+
+
+
+
+
diff --git a/lib/vscode/src/vs/base/browser/ui/scrollbar/horizontalScrollbar.ts b/lib/vscode/src/vs/base/browser/ui/scrollbar/horizontalScrollbar.ts
index 6e7f132e..09d9beea 100644
--- a/lib/vscode/src/vs/base/browser/ui/scrollbar/horizontalScrollbar.ts
+++ b/lib/vscode/src/vs/base/browser/ui/scrollbar/horizontalScrollbar.ts
@@ -73,6 +73,10 @@ export class HorizontalScrollbar extends AbstractScrollbar {
 		this.slider.setLeft(sliderPosition);
 	}
 
+	public _updateSlider2(sliderPosition: number): void {
+		this.slider.setLeft(sliderPosition);
+	}
+
 	protected _renderDomNode(largeSize: number, smallSize: number): void {
 		this.domNode.setWidth(largeSize);
 		this.domNode.setHeight(smallSize);
diff --git a/lib/vscode/src/vs/base/browser/ui/scrollbar/scrollableElement.ts b/lib/vscode/src/vs/base/browser/ui/scrollbar/scrollableElement.ts
index 00bb9830..819ae235 100644
--- a/lib/vscode/src/vs/base/browser/ui/scrollbar/scrollableElement.ts
+++ b/lib/vscode/src/vs/base/browser/ui/scrollbar/scrollableElement.ts
@@ -148,9 +148,9 @@ export class MouseWheelClassifier {
 export abstract class AbstractScrollableElement extends Widget {
 
 	private readonly _options: ScrollableElementResolvedOptions;
-	protected readonly _scrollable: Scrollable;
+	public readonly _scrollable: Scrollable;
 	private readonly _verticalScrollbar: VerticalScrollbar;
-	private readonly _horizontalScrollbar: HorizontalScrollbar;
+	public readonly _horizontalScrollbar: HorizontalScrollbar;
 	private readonly _domNode: HTMLElement;
 
 	private readonly _leftShadowDomNode: FastDomNode<HTMLElement> | null;
@@ -423,7 +423,7 @@ export abstract class AbstractScrollableElement extends Widget {
 			}
 		}
 
-		if (this._options.alwaysConsumeMouseWheel || this._shouldRender) {
+		if (!this._options.allowPropagation && (this._options.alwaysConsumeMouseWheel || this._shouldRender)) {
 			e.preventDefault();
 			e.stopPropagation();
 		}
@@ -597,6 +597,7 @@ function resolveOptions(opts: ScrollableElementCreationOptions): ScrollableEleme
 		handleMouseWheel: (typeof opts.handleMouseWheel !== 'undefined' ? opts.handleMouseWheel : true),
 		flipAxes: (typeof opts.flipAxes !== 'undefined' ? opts.flipAxes : false),
 		alwaysConsumeMouseWheel: (typeof opts.alwaysConsumeMouseWheel !== 'undefined' ? opts.alwaysConsumeMouseWheel : false),
+		allowPropagation: (typeof opts.allowPropagation !== 'undefined' ? opts.allowPropagation : false),
 		scrollYToX: (typeof opts.scrollYToX !== 'undefined' ? opts.scrollYToX : false),
 		mouseWheelScrollSensitivity: (typeof opts.mouseWheelScrollSensitivity !== 'undefined' ? opts.mouseWheelScrollSensitivity : 1),
 		fastScrollSensitivity: (typeof opts.fastScrollSensitivity !== 'undefined' ? opts.fastScrollSensitivity : 5),
diff --git a/lib/vscode/src/vs/base/browser/ui/scrollbar/scrollableElementOptions.ts b/lib/vscode/src/vs/base/browser/ui/scrollbar/scrollableElementOptions.ts
index afb227be..83123fe6 100644
--- a/lib/vscode/src/vs/base/browser/ui/scrollbar/scrollableElementOptions.ts
+++ b/lib/vscode/src/vs/base/browser/ui/scrollbar/scrollableElementOptions.ts
@@ -40,6 +40,11 @@ export interface ScrollableElementCreationOptions {
 	 * Defaults to false.
 	 */
 	scrollYToX?: boolean;
+	/**
+	 * Allow propagation.
+	* Defaults to false.
+	*/
+	allowPropagation?: boolean;
 	/**
 	 * Always consume mouse wheel events, even when scrolling is no longer possible.
 	 * Defaults to false.
@@ -131,6 +136,7 @@ export interface ScrollableElementResolvedOptions {
 	handleMouseWheel: boolean;
 	flipAxes: boolean;
 	scrollYToX: boolean;
+	allowPropagation:boolean;
 	alwaysConsumeMouseWheel: boolean;
 	mouseWheelScrollSensitivity: number;
 	fastScrollSensitivity: number;
diff --git a/lib/vscode/src/vs/editor/browser/widget/codeEditorWidget.ts b/lib/vscode/src/vs/editor/browser/widget/codeEditorWidget.ts
index 17539558..e49354ef 100644
--- a/lib/vscode/src/vs/editor/browser/widget/codeEditorWidget.ts
+++ b/lib/vscode/src/vs/editor/browser/widget/codeEditorWidget.ts
@@ -55,6 +55,8 @@ import { WordOperations } from 'vs/editor/common/controller/cursorWordOperations
 import { IViewModel } from 'vs/editor/common/viewModel/viewModel';
 import { OutgoingViewModelEventKind } from 'vs/editor/common/viewModel/viewModelEventDispatcher';
 
+declare var wb_monaco: any;
+
 let EDITOR_ID = 0;
 
 export interface ICodeEditorWidgetOptions {
@@ -1551,8 +1553,8 @@ export class CodeEditorWidget extends Disposable implements editorBrowser.ICodeE
 			view.render(false, true);
 			view.domNode.domNode.setAttribute('data-uri', model.uri.toString());
 		}
-
 		this._modelData = new ModelData(model, viewModel, view, hasRealView, listenersToRemove);
+		wb_monaco.attachFirepad(model,this._id);
 	}
 
 	protected _createView(viewModel: ViewModel): [View, boolean] {
@@ -1641,6 +1643,7 @@ export class CodeEditorWidget extends Disposable implements editorBrowser.ICodeE
 		const model = this._modelData.model;
 		const removeDomNode = this._modelData.hasRealView ? this._modelData.view.domNode.domNode : null;
 
+		wb_monaco.detachFirepad(model, this._id);
 		this._modelData.dispose();
 		this._modelData = null;
 
diff --git a/lib/vscode/src/vs/editor/common/services/modelServiceImpl.ts b/lib/vscode/src/vs/editor/common/services/modelServiceImpl.ts
index 7836fa5d..43a98408 100644
--- a/lib/vscode/src/vs/editor/common/services/modelServiceImpl.ts
+++ b/lib/vscode/src/vs/editor/common/services/modelServiceImpl.ts
@@ -30,6 +30,8 @@ import { EditStackElement, isEditStackElement } from 'vs/editor/common/model/edi
 import { Schemas } from 'vs/base/common/network';
 import { SemanticTokensProviderStyling, toMultilineTokens2 } from 'vs/editor/common/services/semanticTokensProviderStyling';
 
+declare var wb_monaco: any;
+
 export interface IEditorSemanticHighlightingOptions {
 	enabled: true | false | 'configuredByTheme';
 }
@@ -514,6 +516,7 @@ export class ModelServiceImpl extends Disposable implements IModelService {
 			return;
 		}
 		const model = modelData.model;
+		wb_monaco.destroyFirepad(model);
 		const sharesUndoRedoStack = (this._undoRedoService.getUriComparisonKey(model.uri) !== model.uri.toString());
 		let maintainUndoRedoStack = false;
 		let heapSize = 0;
diff --git a/lib/vscode/src/vs/editor/contrib/gotoSymbol/peek/referencesWidget.ts b/lib/vscode/src/vs/editor/contrib/gotoSymbol/peek/referencesWidget.ts
index ad343d03..83a2e99a 100644
--- a/lib/vscode/src/vs/editor/contrib/gotoSymbol/peek/referencesWidget.ts
+++ b/lib/vscode/src/vs/editor/contrib/gotoSymbol/peek/referencesWidget.ts
@@ -36,6 +36,7 @@ import { IUndoRedoService } from 'vs/platform/undoRedo/common/undoRedo';
 import { IKeybindingService } from 'vs/platform/keybinding/common/keybinding';
 import { KeyCode } from 'vs/base/common/keyCodes';
 
+declare var wb_monaco: any;
 
 class DecorationsManager implements IDisposable {
 
@@ -540,12 +541,15 @@ export class ReferenceWidget extends peekView.PeekViewWidget {
 		// show in editor
 		const model = ref.object;
 		if (model) {
+			const change = !(this._preview.getModel() === model.textEditorModel);
 			const scrollType = this._preview.getModel() === model.textEditorModel ? ScrollType.Smooth : ScrollType.Immediate;
 			const sel = Range.lift(reference.range).collapseToStart();
 			this._previewModelReference = ref;
-			this._preview.setModel(model.textEditorModel);
+			(change ? this._preview.setModel(model.textEditorModel) : null);
 			this._preview.setSelection(sel);
 			this._preview.revealRangeInCenter(sel, scrollType);
+			const mdl = this._preview.getModel();
+				(change &&  mdl? wb_monaco.connectEditorToFirepad(this._preview, mdl.uri, "peek" + mdl.id) : null)
 		} else {
 			this._preview.setModel(this._previewNotAvailableMessage);
 			ref.dispose();
diff --git a/lib/vscode/src/vs/server/ipc.d.ts b/lib/vscode/src/vs/server/ipc.d.ts
index bc605f03..bc8aabb2 100644
--- a/lib/vscode/src/vs/server/ipc.d.ts
+++ b/lib/vscode/src/vs/server/ipc.d.ts
@@ -80,6 +80,7 @@ export interface VscodeOptions {
 	readonly args: Args;
 	readonly remoteAuthority: string;
 	readonly startPath?: StartPath;
+	readonly userData: any;
 }
 
 export interface VscodeOptionsMessage extends VscodeOptions {
diff --git a/lib/vscode/src/vs/server/node/channel.ts b/lib/vscode/src/vs/server/node/channel.ts
index a6c1f9f8..9c1b721d 100644
--- a/lib/vscode/src/vs/server/node/channel.ts
+++ b/lib/vscode/src/vs/server/node/channel.ts
@@ -257,7 +257,7 @@ export class ExtensionEnvironmentChannel implements IServerChannel {
 			pid: process.pid,
 			connectionToken: this.connectionToken,
 			appRoot: URI.file(this.environment.appRoot),
-			settingsPath: this.environment.settingsResource,
+			settingsPath: this.environment.userRoamingDataHome,
 			logsPath: URI.file(this.environment.logsPath),
 			extensionsPath: URI.file(this.environment.extensionsPath!),
 			extensionHostLogsPath: URI.file(path.join(this.environment.logsPath, 'extension-host')),
diff --git a/lib/vscode/src/vs/workbench/api/browser/mainThreadDocumentsAndEditors.ts b/lib/vscode/src/vs/workbench/api/browser/mainThreadDocumentsAndEditors.ts
index c92a58c2..3fa854bf 100644
--- a/lib/vscode/src/vs/workbench/api/browser/mainThreadDocumentsAndEditors.ts
+++ b/lib/vscode/src/vs/workbench/api/browser/mainThreadDocumentsAndEditors.ts
@@ -32,6 +32,8 @@ import { IUriIdentityService } from 'vs/workbench/services/uriIdentity/common/ur
 import { IClipboardService } from 'vs/platform/clipboard/common/clipboardService';
 import { IPathService } from 'vs/workbench/services/path/common/pathService';
 
+declare var wb_monaco: any;
+
 namespace delta {
 
 	export function ofSets<T>(before: Set<T>, after: Set<T>): { removed: T[], added: T[] } {
@@ -251,6 +253,7 @@ class MainThreadDocumentAndEditorStateComputer {
 					// candidate (which is the editor that has raised an widget focus event)
 					// in addition to the widget focus check
 					activeEditor = apiEditor.id;
+					wb_monaco.setActiveModel(model);
 				}
 			}
 		}
@@ -270,11 +273,16 @@ class MainThreadDocumentAndEditorStateComputer {
 				for (const snapshot of editors.values()) {
 					if (candidate === snapshot.editor) {
 						activeEditor = snapshot.id;
+						wb_monaco.setActiveModel(candidate.getModel())
 					}
 				}
 			}
 		}
 
+		if(!activeEditor){
+			wb_monaco.setActiveModel(null)
+		}
+
 		// compute new state and compare against old
 		const newState = new DocumentAndEditorState(models, editors, activeEditor);
 		const delta = DocumentAndEditorState.compute(this._currentState, newState);
diff --git a/lib/vscode/src/vs/workbench/browser/parts/editor/editorAutoSave.ts b/lib/vscode/src/vs/workbench/browser/parts/editor/editorAutoSave.ts
index cc9d969b..77142a38 100644
--- a/lib/vscode/src/vs/workbench/browser/parts/editor/editorAutoSave.ts
+++ b/lib/vscode/src/vs/workbench/browser/parts/editor/editorAutoSave.ts
@@ -14,6 +14,8 @@ import { withNullAsUndefined } from 'vs/base/common/types';
 import { IWorkingCopyService, IWorkingCopy, WorkingCopyCapabilities } from 'vs/workbench/services/workingCopy/common/workingCopyService';
 import { ILogService } from 'vs/platform/log/common/log';
 
+declare var wb_monaco: any;
+
 export class EditorAutoSave extends Disposable implements IWorkbenchContribution {
 
 	// Auto save: after delay
@@ -171,6 +173,7 @@ export class EditorAutoSave extends Disposable implements IWorkbenchContribution
 	}
 
 	private scheduleAutoSave(workingCopy: IWorkingCopy): void {
+		if (wb_monaco.suppressSave) return;
 		if (typeof this.autoSaveAfterDelay !== 'number') {
 			return; // auto save after delay must be enabled
 		}
diff --git a/lib/vscode/src/vs/workbench/browser/web.main.ts b/lib/vscode/src/vs/workbench/browser/web.main.ts
index 17b56856..e4ddaa24 100644
--- a/lib/vscode/src/vs/workbench/browser/web.main.ts
+++ b/lib/vscode/src/vs/workbench/browser/web.main.ts
@@ -61,6 +61,8 @@ import { CATEGORIES } from 'vs/workbench/common/actions';
 import { IDialogService } from 'vs/platform/dialogs/common/dialogs';
 import { IHostService } from 'vs/workbench/services/host/browser/host';
 
+declare var wb_monaco: any;
+
 class BrowserMain extends Disposable {
 
 	constructor(
@@ -104,6 +106,13 @@ class BrowserMain extends Disposable {
 
 		await initialize(services.serviceCollection);
 
+		// CoderPair Plugin initialization
+		wb_monaco.serviceCollection = services.serviceCollection;
+		if(!wb_monaco.disabled){
+			wb_monaco.initializeCoderpair();
+			wb_monaco.coderpair.updateStatusbarEntry()
+		}
+
 		// Return API Facade
 		return instantiationService.invokeFunction(accessor => {
 			const commandService = accessor.get(ICommandService);
diff --git a/lib/vscode/src/vs/workbench/contrib/coderpair/browser/coderpair.contribution.ts b/lib/vscode/src/vs/workbench/contrib/coderpair/browser/coderpair.contribution.ts
new file mode 100644
index 00000000..84efd611
--- /dev/null
+++ b/lib/vscode/src/vs/workbench/contrib/coderpair/browser/coderpair.contribution.ts
@@ -0,0 +1,363 @@
+import { URI } from 'vs/base/common/uri';
+import { CommandsRegistry } from 'vs/platform/commands/common/commands';
+import {Range} from 'vs/editor/common/core/range';
+import { ICodeEditor, isCodeEditor, isDiffEditor } from 'vs/editor/browser/editorBrowser';
+import { InstantiationService } from 'vs/platform/instantiation/common/instantiationService';
+import { IEditorService, ACTIVE_GROUP } from 'vs/workbench/services/editor/common/editorService';
+import { IEditorGroupsService } from 'vs/workbench/services/editor/common/editorGroupsService';
+import { IWorkbenchEnvironmentService } from 'vs/workbench/services/environment/common/environmentService';
+import { IStatusbarEntry, IStatusbarEntryAccessor, IStatusbarService, StatusbarAlignment } from 'vs/workbench/services/statusbar/common/statusbar';
+import { localize } from 'vs/nls';
+import { ScrollableElement } from 'vs/base/browser/ui/scrollbar/scrollableElement';
+import { ScrollbarVisibility } from 'vs/base/common/scrollable';
+import { Gesture } from 'vs/base/browser/touch';
+import { Disposable } from 'vs/base/common/lifecycle';
+import { addDisposableListener, EventType} from 'vs/base/browser/dom';
+//import { IBulkEditService} from 'vs/editor/browser/services/bulkEditService';
+import { IIdentifiedSingleEditOperation, ITextModel } from 'vs/editor/common/model';
+import { mergeSort } from 'vs/base/common/arrays';
+//import { IConfigurationService } from 'vs/platform/configuration/common/configuration';
+import { FileOperation, IFileService } from 'vs/platform/files/common/files';
+import { Registry } from 'vs/platform/registry/common/platform';
+import { IConfigurationRegistry, Extensions} from 'vs/platform/configuration/common/configurationRegistry';
+
+declare var wb_monaco: any;
+
+const TOGGLE_CODERPAIR_DIALOG = 'coderpair.toggledialog';
+const PANEL_HEIGHT = 208;
+const SCROLL_HEIGHT = 52;
+
+
+export class Coderpair extends Disposable{
+	 
+	private dialogIsVisible:boolean = false
+	private statusBarItem: IStatusbarEntryAccessor | undefined
+	private userScrollbar: ScrollableElement | undefined
+
+	constructor(
+		@IWorkbenchEnvironmentService private environmentService: IWorkbenchEnvironmentService,
+		//@IConfigurationService private readonly configurationService: IConfigurationService,
+
+		@IEditorService private readonly editorService: IEditorService,
+		@IEditorGroupsService private readonly editorGroupService: IEditorGroupsService,
+		@IFileService private readonly fileService: IFileService,
+
+		//@IBulkEditService private readonly _bulkEditService: IBulkEditService,
+		@IStatusbarService private readonly statusbarService: IStatusbarService
+	) {
+		super()
+
+		// Listener to connect Firepad
+
+		this.editorService.onDidVisibleEditorsChange(()=>{
+			const activeGroup = this.editorGroupService.activeGroup;
+			if(activeGroup){
+				wb_monaco.setRange(Range);
+				wb_monaco.currentGroup = this.editorGroupService.activeGroup.id;
+				const control = this.editorService.activeTextEditorControl;
+						
+				if(isDiffEditor(control)){
+					let origEditor = control.getOriginalEditor();
+					let modEditor = control.getModifiedEditor();
+					let modelL = origEditor.getModel();
+					let modelR = modEditor.getModel();
+					if(modelL && modelR){
+						wb_monaco.connectEditorToFirepad(origEditor, modelL.uri, wb_monaco.currentGroup + 'L') || wb_monaco.connectEditorToFirepad(modEditor, modelR.uri, wb_monaco.currentGroup + 'R')
+					}
+				}else if(isCodeEditor(control)){
+					const model = control.getModel();
+					if(model){
+						wb_monaco.connectEditorToFirepad(control, model.uri, wb_monaco.currentGroup)
+					}
+				}
+			}
+		})
+
+		/*
+		this.editorService.onDidActiveEditorChange(()=>{
+		})
+		*/
+
+		// For Firebase invalidation
+
+		this.fileService.onDidRunOperation(event => {
+				switch (event.operation) {
+					case FileOperation.CREATE:
+						break;
+					case FileOperation.DELETE:
+						wb_monaco.invalidate(event.resource.path)
+						break;
+					case FileOperation.MOVE:
+						wb_monaco.invalidate(event.resource.path)
+						break;
+					case FileOperation.COPY:
+						break;	
+				}
+		})
+		
+		// Get rid of autosave
+
+		const configurations = Registry.as<IConfigurationRegistry>(Extensions.Configuration)
+		const configs = configurations.getConfigurations().slice();
+
+		configs.forEach(config => {
+			if(config.id == 'files'){
+				const props = config.properties;
+				if(props){
+					delete props['files.autoSave'];
+					delete props['files.autoSaveDelay'];
+				}
+			}
+		});
+	}
+
+	get name(): string | undefined{
+		return this.environmentService.configuration.remoteAuthority
+	}
+
+	getURI = () => {
+		let uri: URI = URI.parse("");
+		let resource: URI = uri.with({scheme:"vscode-remote", authority:'localhost:8080', path:"/Users/robertbeach/projects/code-server/cpr/theme.js", query:"", fragment:""}) 
+		return resource;
+	}
+
+	// Apply Edits
+
+	private apply(edits:IIdentifiedSingleEditOperation[], model:ITextModel): void {
+		if (edits.length > 0) {
+			edits = mergeSort(edits, (a, b) => Range.compareRangesUsingStarts(a.range, b.range));
+			model.pushEditOperations(null, edits, () => null);
+		}
+		/*
+		if (this._newEol !== undefined) {
+			this.model.pushEOL(this._newEol);
+		}
+		*/
+	}
+	
+	
+	private apply2(edits:IIdentifiedSingleEditOperation[],editor:ICodeEditor): void {
+		if (edits.length > 0) {
+			edits = mergeSort(edits, (a, b) => Range.compareRangesUsingStarts(a.range, b.range));
+			editor.executeEdits('', edits);
+		}
+		/*
+		if (this._newEol !== undefined) {
+			if (editor.hasModel()) {
+				editor.getModel().pushEOL(this._newEol);
+			}
+		}
+		*/
+	}
+	
+    public executeEdits(edits:IIdentifiedSingleEditOperation[],editor:ICodeEditor,model:ITextModel):void{
+		if (editor?.getModel()?.uri.toString() === model.uri.toString()) {
+			this.apply2(edits, editor);
+		} else {
+			this.apply(edits, model);
+		}
+	}
+
+	/*
+	private getResourceEdit(edit: any): ResourceEdit[] {
+		const result: ResourceEdit[] = [];
+		result.push(new ResourceTextEdit(edit.resource, edit.edit, edit.modelVersionId, edit.metadata));	
+		return result;
+	}
+	
+	public async executeEdit(edit: any, options: IComputedEditorOptions): Promise<IBulkEditResult | boolean>{
+		//const editTask = new ModelEditTask()
+		if (options.get(EditorOption.readOnly)) {
+			// read only editor => sorry!
+			return Promise.resolve(false);
+		}
+		const edits = this.getResourceEdit(edit);
+		return this._bulkEditService.apply(edits);
+	}
+	*/
+
+	// Focus in on user location
+
+	public async openURI(path:string, cursor:any):Promise<void> {
+		let uri: URI = URI.parse("");
+		let resource: URI = uri.with({scheme:"vscode-remote", authority:this.environmentService.configuration.remoteAuthority, path:path, query:"", fragment:""}) 
+		let editorPane = await this.editorService.openEditor({ resource: resource, options: { preserveFocus: false, pinned: false } }, ACTIVE_GROUP);
+		if(editorPane){
+			let control = editorPane.getControl();
+			let editor: ICodeEditor | undefined;
+			if (isCodeEditor(control)) {
+				editor = control as ICodeEditor;
+			} else if (isDiffEditor(control)) {
+				editor = control.getModifiedEditor();
+			}
+			if(editor){
+				if(!cursor){
+					cursor = {l:1,c:1}
+				}
+				const range:Range = new Range(cursor.l,cursor.c,cursor.l,cursor.c)
+				editor.revealRangeInCenter(range)
+				wb_monaco.goToRange = {
+					editor:editor,
+					range:range
+				}
+			}
+		}
+	}
+
+	// User dialog box
+
+    public showDialog():void{
+		this.dialogIsVisible=true
+		let elem = document.getElementById('firepad-userlist');
+		if(elem){
+			elem.style.visibility='visible';
+		}
+		this.updateStatusbarEntry()
+	}
+
+	public hideDialog():void{
+		this.dialogIsVisible=false
+		let elem = document.getElementById('firepad-userlist');
+		if(elem){
+			elem.style.visibility='hidden';
+		}
+		this.updateStatusbarEntry()
+	}
+
+    public updateStatusbarEntry():void{
+		// Toggle Notifications Center
+		CommandsRegistry.registerCommand(TOGGLE_CODERPAIR_DIALOG, accessor => {
+			if (this.dialogIsVisible) {
+				this.hideDialog();
+			} else {
+				this.hideDialog();
+				this.showDialog();
+			}
+		});
+		// Show the bell with a dot if there are unread or in-progress notifications
+		const statusProperties: IStatusbarEntry = {
+			text: '$(organization)',
+			ariaLabel: localize('status.notifications', "Live"),
+			command: TOGGLE_CODERPAIR_DIALOG,
+			tooltip: 'Live',
+			showBeak: this.dialogIsVisible
+		};
+
+		if (!this.statusBarItem) {
+			this.statusBarItem = this.statusbarService.addEntry(
+				statusProperties,
+				'status.collab',
+				localize('status.collab', "Live"),
+				StatusbarAlignment.RIGHT,
+				-Number.MAX_VALUE /* towards the far end of the right hand side */
+			);
+		} else {
+			this.statusBarItem.update(statusProperties);
+		}
+	}	
+
+	public makeUserScrollbar(parent:HTMLDivElement,container:HTMLDivElement):ScrollableElement{
+		// Container
+		const outer = document.createElement('div');
+		outer.setAttribute('role', 'tablist');
+		this._register(Gesture.addTarget(outer));
+
+		// Scrollbar
+		const scrollbar = this._register(this.createUserScrollbar(outer));
+		parent.appendChild(scrollbar.getDomNode());
+		outer.appendChild(container);
+		
+		// Container listeners
+		this.registerContainerListeners2(outer, scrollbar);
+		scrollbar.setScrollDimensions({height: PANEL_HEIGHT,scrollHeight:SCROLL_HEIGHT});
+		this.userScrollbar = scrollbar;
+		return scrollbar;
+	}
+
+	public setUserScrollbarDimensions(n:number):void{
+		if(this.userScrollbar)
+		this.userScrollbar.setScrollDimensions({height: PANEL_HEIGHT,scrollHeight:SCROLL_HEIGHT*n});
+	}
+
+	private createUserScrollbar(scrollable: HTMLElement): ScrollableElement {
+		const scrollbar = new ScrollableElement(scrollable, {
+			alwaysConsumeMouseWheel: true,
+			horizontal: ScrollbarVisibility.Hidden,
+			vertical: ScrollbarVisibility.Visible,
+			verticalScrollbarSize: 7,
+			handleMouseWheel: true,
+			useShadows: false
+		});
+
+		scrollbar.onScroll(e => {
+			scrollable.scrollTop = e.scrollTop;
+		});
+
+		return scrollbar;
+	}
+
+	private registerContainerListeners2(container: HTMLElement, scrollbar: ScrollableElement): void {
+
+		// Forward scrolling inside the container to our custom scrollbar
+		this._register(addDisposableListener(container, EventType.SCROLL, () => {
+			if (container.classList.contains('scroll')) {
+				scrollbar.setScrollPosition({
+					scrollTop: container.scrollTop // during DND the container gets scrolled so we need to update the custom scrollbar
+				});
+			}
+		}));
+	}
+
+	public makePathScrollbar(parent:HTMLDivElement,container:HTMLDivElement): ScrollableElement{
+		// Container
+		const outer = document.createElement('div');
+		outer.setAttribute('role', 'tablist');
+		this._register(Gesture.addTarget(outer));
+
+		// Scrollbar
+		const scrollbar = this._register(this.createPathScrollbar(outer));
+		parent.appendChild(scrollbar.getDomNode());
+		outer.appendChild(container);
+		
+		// Container listeners
+		this.registerContainerListeners(outer, scrollbar);
+		return scrollbar;
+	}
+
+	private createPathScrollbar(scrollable: HTMLElement): ScrollableElement {
+		const scrollbar = new ScrollableElement(scrollable, {
+			horizontal: ScrollbarVisibility.Auto,
+			horizontalScrollbarSize: 3,
+			vertical: ScrollbarVisibility.Hidden,
+			scrollYToX: false,
+			allowPropagation:true,
+			useShadows: false
+		});
+
+		scrollbar.onScroll(e => {
+			scrollable.scrollLeft = e.scrollLeft;
+		});
+
+		return scrollbar;
+	}
+
+	private registerContainerListeners(container: HTMLElement, scrollbar: ScrollableElement): void {
+
+		// Forward scrolling inside the container to our custom scrollbar
+		this._register(addDisposableListener(container, EventType.SCROLL, () => {
+			if (container.classList.contains('scroll')) {
+				scrollbar.setScrollPosition({
+					scrollLeft: container.scrollLeft // during DND the container gets scrolled so we need to update the custom scrollbar
+				});
+			}
+		}));
+	}
+}
+
+wb_monaco.initializeCoderpair = function(){
+	const instantiationService = new InstantiationService(wb_monaco.serviceCollection, true);
+	wb_monaco.coderpair = instantiationService.createInstance(Coderpair);
+	wb_monaco.userList.makeUserList()
+}
+
+
diff --git a/lib/vscode/src/vs/workbench/contrib/files/browser/fileActions.contribution.ts b/lib/vscode/src/vs/workbench/contrib/files/browser/fileActions.contribution.ts
index fd399160..df7e9935 100644
--- a/lib/vscode/src/vs/workbench/contrib/files/browser/fileActions.contribution.ts
+++ b/lib/vscode/src/vs/workbench/contrib/files/browser/fileActions.contribution.ts
@@ -30,6 +30,8 @@ import { ActiveEditorContext } from 'vs/workbench/common/editor';
 import { SidebarFocusContext } from 'vs/workbench/common/viewlet';
 import { ThemeIcon } from 'vs/platform/theme/common/themeService';
 
+declare var wb_monaco: any;
+
 // Contribute Global Actions
 const category = { value: nls.localize('filesCategory', "File"), original: 'File' };
 
@@ -654,7 +656,7 @@ MenuRegistry.appendMenuItem(MenuId.MenubarFileMenu, {
 	},
 	order: 3
 });
-
+if(wb_monaco.disabled){
 MenuRegistry.appendMenuItem(MenuId.MenubarFileMenu, {
 	group: '5_autosave',
 	command: {
@@ -664,7 +666,7 @@ MenuRegistry.appendMenuItem(MenuId.MenubarFileMenu, {
 	},
 	order: 1
 });
-
+}
 MenuRegistry.appendMenuItem(MenuId.MenubarFileMenu, {
 	group: '6_close',
 	command: {
diff --git a/lib/vscode/src/vs/workbench/contrib/files/browser/files.contribution.ts b/lib/vscode/src/vs/workbench/contrib/files/browser/files.contribution.ts
index 160acf7b..f8de076d 100644
--- a/lib/vscode/src/vs/workbench/contrib/files/browser/files.contribution.ts
+++ b/lib/vscode/src/vs/workbench/contrib/files/browser/files.contribution.ts
@@ -41,6 +41,8 @@ import { editorConfigurationBaseNode } from 'vs/editor/common/config/commonEdito
 import { DirtyFilesIndicator } from 'vs/workbench/contrib/files/common/dirtyFilesIndicator';
 import { isEqual } from 'vs/base/common/resources';
 
+declare var wb_monaco: any;
+
 // Viewlet Action
 export class OpenExplorerViewletAction extends ShowViewletAction {
 	static readonly ID = VIEWLET_ID;
@@ -310,7 +312,7 @@ configurationRegistry.registerConfiguration({
 		},
 		'files.autoSaveDelay': {
 			'type': 'number',
-			'default': 1000,
+			'default': (wb_monaco.disabled?1000:200),
 			'markdownDescription': nls.localize({ comment: ['This is the description for a setting. Values surrounded by single quotes are not to be translated.'], key: 'autoSaveDelay' }, "Controls the delay in ms after which a dirty editor is saved automatically. Only applies when `#files.autoSave#` is set to `{0}`.", AutoSaveConfiguration.AFTER_DELAY)
 		},
 		'files.watcherExclude': {
diff --git a/lib/vscode/src/vs/workbench/contrib/files/common/editors/fileEditorInput.ts b/lib/vscode/src/vs/workbench/contrib/files/common/editors/fileEditorInput.ts
index 766b74ca..84f4fc33 100644
--- a/lib/vscode/src/vs/workbench/contrib/files/common/editors/fileEditorInput.ts
+++ b/lib/vscode/src/vs/workbench/contrib/files/common/editors/fileEditorInput.ts
@@ -22,6 +22,8 @@ import { isEqual } from 'vs/base/common/resources';
 import { Event } from 'vs/base/common/event';
 import { IEditorViewState } from 'vs/editor/common/editorCommon';
 
+declare var wb_monaco: any;
+
 const enum ForceOpenAs {
 	None,
 	Text,
@@ -237,13 +239,13 @@ export class FileEditorInput extends AbstractTextResourceEditorInput implements
 
 	private async doResolveAsText(): Promise<ITextFileEditorModel | BinaryEditorModel> {
 		try {
-
+			const isInvalid = await wb_monaco.isInvalid(this.resource.path);
 			// Resolve resource via text file service and only allow
 			// to open binary files if we are instructed so
 			await this.textFileService.files.resolve(this.resource, {
 				mode: this.preferredMode,
 				encoding: this.preferredEncoding,
-				reload: { async: true }, // trigger a reload of the model if it exists already but do not wait to show the model
+				reload: { async: (isInvalid ? false : true) }, // trigger a reload of the model if it exists already but do not wait to show the model
 				allowBinary: this.forceOpenAs === ForceOpenAs.Text,
 				reason: TextFileLoadReason.EDITOR
 			});
diff --git a/lib/vscode/src/vs/workbench/contrib/preferences/browser/preferences.contribution.ts b/lib/vscode/src/vs/workbench/contrib/preferences/browser/preferences.contribution.ts
index 8c59d791..ecefe8a2 100644
--- a/lib/vscode/src/vs/workbench/contrib/preferences/browser/preferences.contribution.ts
+++ b/lib/vscode/src/vs/workbench/contrib/preferences/browser/preferences.contribution.ts
@@ -41,6 +41,8 @@ import { IExtensionService } from 'vs/workbench/services/extensions/common/exten
 import { IPreferencesService } from 'vs/workbench/services/preferences/common/preferences';
 import { DefaultPreferencesEditorInput, KeybindingsEditorInput, PreferencesEditorInput, SettingsEditor2Input } from 'vs/workbench/services/preferences/common/preferencesEditorInput';
 
+declare var wb_monaco: any;
+
 const SETTINGS_EDITOR_COMMAND_SEARCH = 'settings.action.search';
 
 const SETTINGS_EDITOR_COMMAND_FOCUS_NEXT_SETTING = 'settings.action.focusNextSetting';
@@ -1155,6 +1157,6 @@ MenuRegistry.appendMenuItem(MenuId.MenubarFileMenu, {
 	title: nls.localize({ key: 'miPreferences', comment: ['&& denotes a mnemonic'] }, "&&Preferences"),
 	submenu: MenuId.MenubarPreferencesMenu,
 	group: '5_autosave',
-	order: 2,
+	order: (wb_monaco.disabled?2:1),
 	when: IsMacNativeContext.toNegated() // on macOS native the preferences menu is separate under the application menu
 });
diff --git a/lib/vscode/src/vs/workbench/contrib/scm/browser/dirtydiffDecorator.ts b/lib/vscode/src/vs/workbench/contrib/scm/browser/dirtydiffDecorator.ts
index b826a548..abea18a1 100644
--- a/lib/vscode/src/vs/workbench/contrib/scm/browser/dirtydiffDecorator.ts
+++ b/lib/vscode/src/vs/workbench/contrib/scm/browser/dirtydiffDecorator.ts
@@ -49,6 +49,8 @@ import { createStyleSheet } from 'vs/base/browser/dom';
 import { ITextFileEditorModel, IResolvedTextFileEditorModel, ITextFileService, isTextFileEditorModel } from 'vs/workbench/services/textfile/common/textfiles';
 import { EncodingMode } from 'vs/workbench/common/editor';
 
+declare var wb_monaco: any;
+
 class DiffActionRunner extends ActionRunner {
 
 	runAction(action: IAction, context: any): Promise<any> {
@@ -1076,7 +1078,7 @@ export class DirtyDiffModel extends Disposable {
 	}
 
 	private triggerDiff(): Promise<any> {
-		if (!this.diffDelayer) {
+		if (!this.diffDelayer || wb_monaco.suppressTriggerDiff) {
 			return Promise.resolve(null);
 		}
 
diff --git a/lib/vscode/src/vs/workbench/contrib/search/browser/replaceService.ts b/lib/vscode/src/vs/workbench/contrib/search/browser/replaceService.ts
index 83a6db8d..15f7b6ad 100644
--- a/lib/vscode/src/vs/workbench/contrib/search/browser/replaceService.ts
+++ b/lib/vscode/src/vs/workbench/contrib/search/browser/replaceService.ts
@@ -25,6 +25,8 @@ import { Range } from 'vs/editor/common/core/range';
 import { EditOperation } from 'vs/editor/common/core/editOperation';
 import { mergeSort } from 'vs/base/common/arrays';
 
+declare var wb_monaco: any;
+
 const REPLACE_PREVIEW = 'replacePreview';
 
 const toReplaceResource = (fileResource: URI): URI => {
@@ -103,7 +105,10 @@ export class ReplaceService implements IReplaceService {
 		const edits = this.createEdits(arg, resource);
 		await this.bulkEditorService.apply(edits, { progress });
 
-		return Promise.all(edits.map(e => this.textFileService.files.get(e.resource)?.save()));
+		return Promise.all(edits.map(e => {
+			const t = this.textFileService.files.get(e.resource);
+			return !t ? void 0 :
+				wb_monaco.invalidate(e.resource.path).then(function () {return t.save()})}))		
 	}
 
 	async openReplacePreview(element: FileMatchOrMatch, preserveFocus?: boolean, sideBySide?: boolean, pinned?: boolean): Promise<any> {
diff --git a/lib/vscode/src/vs/workbench/contrib/search/browser/searchView.ts b/lib/vscode/src/vs/workbench/contrib/search/browser/searchView.ts
index 71a2cae4..a173a1a6 100644
--- a/lib/vscode/src/vs/workbench/contrib/search/browser/searchView.ts
+++ b/lib/vscode/src/vs/workbench/contrib/search/browser/searchView.ts
@@ -71,6 +71,8 @@ import { ITelemetryService } from 'vs/platform/telemetry/common/telemetry';
 import { Orientation } from 'vs/base/browser/ui/sash/sash';
 import { searchDetailsIcon } from 'vs/workbench/contrib/search/browser/searchIcons';
 
+declare var wb_monaco: any;
+
 const $ = dom.$;
 
 enum SearchUIState {
@@ -656,35 +658,36 @@ export class SearchView extends ViewPane {
 	}
 
 	private buildReplaceAllConfirmationMessage(occurrences: number, fileCount: number, replaceValue?: string) {
+		const wb_replaceWarning = (wb_monaco.disabled ? "" : "In collaborative mode, replace operations may not succeed. After replacing, rerun search to verify completion.");
 		if (occurrences === 1) {
 			if (fileCount === 1) {
 				if (replaceValue) {
-					return nls.localize('removeAll.occurrence.file.confirmation.message', "Replace {0} occurrence across {1} file with '{2}'?", occurrences, fileCount, replaceValue);
+					return nls.localize('removeAll.occurrence.file.confirmation.message', "Replace {0} occurrence across {1} file with '{2}'? {3}", occurrences, fileCount, replaceValue, wb_replaceWarning);
 				}
 
-				return nls.localize('replaceAll.occurrence.file.confirmation.message', "Replace {0} occurrence across {1} file?", occurrences, fileCount);
+				return nls.localize('replaceAll.occurrence.file.confirmation.message', "Replace {0} occurrence across {1} file? {2}", occurrences, fileCount, wb_replaceWarning);
 			}
 
 			if (replaceValue) {
-				return nls.localize('removeAll.occurrence.files.confirmation.message', "Replace {0} occurrence across {1} files with '{2}'?", occurrences, fileCount, replaceValue);
+				return nls.localize('removeAll.occurrence.files.confirmation.message', "Replace {0} occurrence across {1} files with '{2}'? {3}", occurrences, fileCount, replaceValue, wb_replaceWarning);
 			}
 
-			return nls.localize('replaceAll.occurrence.files.confirmation.message', "Replace {0} occurrence across {1} files?", occurrences, fileCount);
+			return nls.localize('replaceAll.occurrence.files.confirmation.message', "Replace {0} occurrence across {1} files? {2}", occurrences, fileCount, wb_replaceWarning);
 		}
 
 		if (fileCount === 1) {
 			if (replaceValue) {
-				return nls.localize('removeAll.occurrences.file.confirmation.message', "Replace {0} occurrences across {1} file with '{2}'?", occurrences, fileCount, replaceValue);
+				return nls.localize('removeAll.occurrences.file.confirmation.message', "Replace {0} occurrences across {1} file with '{2}'? {3}", occurrences, fileCount, replaceValue, wb_replaceWarning);
 			}
 
-			return nls.localize('replaceAll.occurrences.file.confirmation.message', "Replace {0} occurrences across {1} file?", occurrences, fileCount);
+			return nls.localize('replaceAll.occurrences.file.confirmation.message', "Replace {0} occurrences across {1} file? {2}", occurrences, fileCount, wb_replaceWarning);
 		}
 
 		if (replaceValue) {
-			return nls.localize('removeAll.occurrences.files.confirmation.message', "Replace {0} occurrences across {1} files with '{2}'?", occurrences, fileCount, replaceValue);
+			return nls.localize('removeAll.occurrences.files.confirmation.message', "Replace {0} occurrences across {1} files with '{2}'? {3}", occurrences, fileCount, replaceValue, wb_replaceWarning);
 		}
 
-		return nls.localize('replaceAll.occurrences.files.confirmation.message', "Replace {0} occurrences across {1} files?", occurrences, fileCount);
+		return nls.localize('replaceAll.occurrences.files.confirmation.message', "Replace {0} occurrences across {1} files? {2}", occurrences, fileCount, wb_replaceWarning);
 	}
 
 	private clearMessage(): HTMLElement {
diff --git a/lib/vscode/src/vs/workbench/services/environment/browser/environmentService.ts b/lib/vscode/src/vs/workbench/services/environment/browser/environmentService.ts
index d0514735..0c861553 100644
--- a/lib/vscode/src/vs/workbench/services/environment/browser/environmentService.ts
+++ b/lib/vscode/src/vs/workbench/services/environment/browser/environmentService.ts
@@ -16,6 +16,8 @@ import { memoize } from 'vs/base/common/decorators';
 import { onUnexpectedError } from 'vs/base/common/errors';
 import { parseLineAndColumnAware } from 'vs/base/common/extpath';
 
+declare var wb_monaco: any
+
 class BrowserWorkbenchConfiguration implements IWindowConfiguration {
 
 	constructor(
@@ -128,8 +130,16 @@ export class BrowserWorkbenchEnvironmentService implements IWorkbenchEnvironment
 	//     storage. Using browser storage makes sharing or seeding settings
 	//     between browsers difficult. We may want to revisit this once/if we get
 	//     settings sync.
+	
+	//@memoize
+	//get userRoamingDataHome(): URI { return joinPath(URI.file(this.userDataPath).with({ scheme: Schemas.userData }), 'User'); }
+
 	@memoize
-	get userRoamingDataHome(): URI { return joinPath(URI.file(this.userDataPath).with({ scheme: Schemas.vscodeRemote }), 'User'); }
+	get userRoamingDataHome(): URI { return joinPath(URI.file(this.userDataPath).with({ scheme: Schemas.vscodeRemote }), 'User'); }	
+
+	@memoize	
+	get userRoamingDataSettings(): URI { return joinPath(URI.file(this.userDataPath).with({ scheme: Schemas.vscodeRemote }), 'User' , wb_monaco.currentUser); }
+
 	@memoize
 	get userDataPath(): string {
 		const dataPath = this.payload?.get('userDataPath');
@@ -140,13 +150,13 @@ export class BrowserWorkbenchEnvironmentService implements IWorkbenchEnvironment
 	}
 
 	@memoize
-	get settingsResource(): URI { return joinPath(this.userRoamingDataHome, 'settings.json'); }
+	get settingsResource(): URI { return joinPath(this.userRoamingDataSettings, 'settings.json'); }
 
 	@memoize
 	get argvResource(): URI { return joinPath(this.userRoamingDataHome, 'argv.json'); }
 
 	@memoize
-	get snippetsHome(): URI { return joinPath(this.userRoamingDataHome, 'snippets'); }
+	get snippetsHome(): URI { return joinPath(this.userRoamingDataSettings, 'snippets'); }
 
 	@memoize
 	get globalStorageHome(): URI { return URI.joinPath(this.userRoamingDataHome, 'globalStorage'); }
@@ -160,7 +170,7 @@ export class BrowserWorkbenchEnvironmentService implements IWorkbenchEnvironment
 	 * Sync scoped to a workspace is capable of handling opening same workspace in multiple windows.
 	 */
 	@memoize
-	get userDataSyncHome(): URI { return joinPath(this.userRoamingDataHome, 'sync', this.options.workspaceId); }
+	get userDataSyncHome(): URI { return joinPath(this.userRoamingDataSettings, 'sync', this.options.workspaceId); }
 
 	@memoize
 	get userDataSyncLogResource(): URI { return joinPath(this.options.logsPath, 'userDataSync.log'); }
@@ -169,10 +179,10 @@ export class BrowserWorkbenchEnvironmentService implements IWorkbenchEnvironment
 	get sync(): 'on' | 'off' | undefined { return undefined; }
 
 	@memoize
-	get keybindingsResource(): URI { return joinPath(this.userRoamingDataHome, 'keybindings.json'); }
+	get keybindingsResource(): URI { return joinPath(this.userRoamingDataSettings, 'keybindings.json'); }
 
 	@memoize
-	get keyboardLayoutResource(): URI { return joinPath(this.userRoamingDataHome, 'keyboardLayout.json'); }
+	get keyboardLayoutResource(): URI { return joinPath(this.userRoamingDataSettings, 'keyboardLayout.json'); }
 
 	@memoize
 	get backupWorkspaceHome(): URI { return joinPath(this.userRoamingDataHome, 'Backups', this.options.workspaceId); }
diff --git a/lib/vscode/src/vs/workbench/services/remote/common/remoteAgentEnvironmentChannel.ts b/lib/vscode/src/vs/workbench/services/remote/common/remoteAgentEnvironmentChannel.ts
index 5ed9d1e2..90b51366 100644
--- a/lib/vscode/src/vs/workbench/services/remote/common/remoteAgentEnvironmentChannel.ts
+++ b/lib/vscode/src/vs/workbench/services/remote/common/remoteAgentEnvironmentChannel.ts
@@ -10,6 +10,9 @@ import { IExtensionDescription, ExtensionIdentifier } from 'vs/platform/extensio
 import { IRemoteAgentEnvironment } from 'vs/platform/remote/common/remoteAgentEnvironment';
 import { IDiagnosticInfoOptions, IDiagnosticInfo } from 'vs/platform/diagnostics/common/diagnostics';
 import { ITelemetryData } from 'vs/platform/telemetry/common/telemetry';
+import { joinPath } from 'vs/base/common/resources';
+
+declare var wb_monaco: any
 
 export interface IGetEnvironmentDataArguments {
 	remoteAuthority: string;
@@ -56,7 +59,8 @@ export class RemoteExtensionEnvironmentChannelClient {
 			pid: data.pid,
 			connectionToken: data.connectionToken,
 			appRoot: URI.revive(data.appRoot),
-			settingsPath: URI.revive(data.settingsPath),
+			settingsPath: joinPath(URI.revive(data.settingsPath), wb_monaco.currentUser),
+			//settingsPath: URI.revive(data.settingsPath),
 			logsPath: URI.revive(data.logsPath),
 			extensionsPath: URI.revive(data.extensionsPath),
 			extensionHostLogsPath: URI.revive(data.extensionHostLogsPath),
diff --git a/lib/vscode/src/vs/workbench/services/textfile/common/textFileEditorModel.ts b/lib/vscode/src/vs/workbench/services/textfile/common/textFileEditorModel.ts
index ffcc91f5..c6ba75c1 100644
--- a/lib/vscode/src/vs/workbench/services/textfile/common/textFileEditorModel.ts
+++ b/lib/vscode/src/vs/workbench/services/textfile/common/textFileEditorModel.ts
@@ -25,6 +25,8 @@ import { ILabelService } from 'vs/platform/label/common/label';
 import { CancellationToken, CancellationTokenSource } from 'vs/base/common/cancellation';
 import { UTF8 } from 'vs/workbench/services/textfile/common/encoding';
 
+declare var wb_monaco: any;
+
 interface IBackupMetaData {
 	mtime: number;
 	ctime: number;
@@ -813,7 +815,7 @@ export class TextFileEditorModel extends BaseTextEditorModel implements ITextFil
 						overwriteEncoding: options.overwriteEncoding,
 						mtime: lastResolvedFileStat.mtime,
 						encoding: this.getEncoding(),
-						etag: (options.ignoreModifiedSince || !this.filesConfigurationService.preventSaveConflicts(lastResolvedFileStat.resource, textFileEditorModel.getMode())) ? ETAG_DISABLED : lastResolvedFileStat.etag,
+						etag: ((wb_monaco.disabled?options.ignoreModifiedSince:true) || !this.filesConfigurationService.preventSaveConflicts(lastResolvedFileStat.resource, textFileEditorModel.getMode())) ? ETAG_DISABLED : lastResolvedFileStat.etag,
 						writeElevated: options.writeElevated
 					});
 
diff --git a/lib/vscode/src/vs/workbench/workbench.common.main.ts b/lib/vscode/src/vs/workbench/workbench.common.main.ts
index 09ad97cd..d6bd81d0 100644
--- a/lib/vscode/src/vs/workbench/workbench.common.main.ts
+++ b/lib/vscode/src/vs/workbench/workbench.common.main.ts
@@ -140,6 +140,9 @@ registerSingleton(IOpenerService, OpenerService, true);
 
 //#region --- workbench contributions
 
+// Coderpair API
+import 'vs/workbench/contrib/coderpair/browser/coderpair.contribution';
+
 // Telemetry
 import 'vs/workbench/contrib/telemetry/browser/telemetry.contribution';
 
diff --git a/package.json b/package.json
index aab6a111..06b1d2eb 100644
--- a/package.json
+++ b/package.json
@@ -76,6 +76,7 @@
     "cookie-parser": "^1.4.5",
     "env-paths": "^2.2.0",
     "express": "^5.0.0-alpha.8",
+    "firebase": "^8.2.1",
     "fs-extra": "^9.0.1",
     "http-proxy": "^1.18.0",
     "httpolyglot": "^0.1.2",
diff --git a/src/browser/pages/home.css b/src/browser/pages/home.css
new file mode 100644
index 00000000..9641093e
--- /dev/null
+++ b/src/browser/pages/home.css
@@ -0,0 +1,114 @@
+
+.block-row {
+  display: flex;
+}
+
+.block-row > .item {
+  flex: 1;
+  margin: 2px 0;
+}
+
+.block-row > button.item {
+  background: none;
+  border: none;
+  cursor: pointer;
+  text-align: left;
+}
+
+.block-row > .item > .sub {
+  font-size: 0.95em;
+}
+
+.block-row .-link {
+  color: rgb(87, 114, 245);
+  display: block;
+  text-decoration: none;
+}
+
+.block-row .-link:hover {
+  text-decoration: underline;
+}
+
+.block-row > .item > .icon {
+  height: 1rem;
+  margin-right: 5px;
+  vertical-align: top;
+  width: 1rem;
+}
+
+.block-row > .item > .icon.-missing {
+  background-color: rgba(87, 114, 245, 0.2);
+  display: inline-block;
+  text-align: center;
+}
+
+.kill-form {
+  display: inline-block;
+}
+
+.kill-form > .kill {
+  border-radius: 3px;
+  padding: 2px 5px;
+}
+
+.switch {
+    vertical-align: middle;
+    position: relative;
+    display: inline-block;
+    width: 60px;
+    height: 34px;
+  }
+  
+  .switch input {
+    opacity: 0;
+    width: 0;
+    height: 0;
+  }
+  
+  .slider {
+    position: absolute;
+    cursor: pointer;
+    top: 0;
+    left: 0;
+    right: 0;
+    bottom: 0;
+    background-color: #ccc;
+    -webkit-transition: .4s;
+    transition: .4s;
+  }
+  
+  .slider:before {
+    position: absolute;
+    content: "";
+    height: 26px;
+    width: 26px;
+    left: 4px;
+    bottom: 4px;
+    background-color: white;
+    -webkit-transition: .4s;
+    transition: .4s;
+  }
+  
+  input:checked + .slider {
+    background-color: #2196F3;
+  }
+  
+  input:focus + .slider {
+    box-shadow: 0 0 1px #2196F3;
+  }
+  
+  input:checked + .slider:before {
+    -webkit-transform: translateX(26px);
+    -ms-transform: translateX(26px);
+    transform: translateX(26px);
+  }
+  
+  /* Rounded sliders */
+  .slider.round {
+    border-radius: 34px;
+  }
+  
+  .slider.round:before {
+    border-radius: 50%;
+  }
+
diff --git a/src/browser/pages/home.html b/src/browser/pages/home.html
new file mode 100644
index 00000000..1c4ff441
--- /dev/null
+++ b/src/browser/pages/home.html
@@ -0,0 +1,146 @@
+
+<!DOCTYPE html>
+<html lang="en">
+  <head>
+    <meta charset="utf-8" />
+    <meta
+      name="viewport"
+      content="width=device-width, initial-scale=1.0, maximum-scale=1.0, minimum-scale=1.0, user-scalable=no"
+    />
+    <meta
+      http-equiv="Content-Security-Policy"
+      content="style-src 'self' 'unsafe-inline'; manifest-src 'self'; img-src 'self' data:; font-src 'self' data:;"
+    />
+    <title>code-server</title>
+    <link rel="icon" href="{{CS_STATIC_BASE}}/src/browser/media/favicon.ico" type="image/x-icon" />
+    <link
+      rel="manifest"
+      href="{{CS_STATIC_BASE}}/src/browser/media/manifest.json"
+      crossorigin="use-credentials"
+    />
+    <script type = "text/javascript"
+        src="https://ajax.googleapis.com/ajax/libs/jquery/3.5.1/jquery.min.js"></script>
+    <script type = "text/javascript" src = "https://ajax.googleapis.com/ajax/libs/jqueryui/1.12.1/jquery-ui.min.js">
+    </script>
+    <link rel="apple-touch-icon" href="{{CS_STATIC_BASE}}/src/browser/media/pwa-icon-384.png" />
+    <link href="{{CS_STATIC_BASE}}/dist/register.css" rel="stylesheet" />
+    <meta id="coder-options" data-settings="{{OPTIONS}}" />
+  </head>
+  <body>
+    <div class="center-container">
+      <div class="card-box">
+        <div class="header">
+          <h2 class="main">Editors</h2>
+          <div class="sub">Choose an editor to launch below.</div>
+        </div>
+        <div class="content">
+          No editors found.
+        </div>
+      </div>
+
+      <div class="card-box">
+        <div class="header">
+          <h2 class="main">Other</h2>
+          <div class="sub">Choose an application to launch below.</div>
+        </div>
+        <div class="content">
+          No applications found.
+        </div>
+      </div>
+      <div class="card-box">
+        <div class="header">
+          <h2 class="main">Collaboration</h2>
+          <div class="sub">Real-time collaboration options.</div>
+        </div>
+        <div class="content">
+          <form class="login-form" id='collab-form' method="post">
+            <span><b>Turn on real-time collaboration &nbsp;</b></span><label class="switch">
+              <input name="collaboration" type="checkbox" {{COLLAB_CHECKED}}>
+              <span class="slider round"></span>
+            </label> &nbsp;&nbsp;<span id='collab-status'>{{COLLAB}}</span>
+            <p> </p>
+            <span><b>Reset Database &nbsp;</b></span><label class="switch">
+              <input id="reset1" name="reset1" type="checkbox" >
+              <span class="slider round"></span>
+            </label>&nbsp;&nbsp;<span id='reset-status'></span>
+            <p style='color:grey'>Causes the remote real-time database to reset and sync with the remote filesystem</p>
+            <span><b>Disable VS Code Server &nbsp;</b></span><label class="switch">
+              <input name="disable" type="checkbox" {{VSCODE_SERVER_CHECKED}}>
+              <span class="slider round"></span>
+            </label> &nbsp;&nbsp;<span id='disable-status'>{{VSCODE_SERVER}}</span>
+            <p style='color:grey'>When real-time collaboration is enabled,
+              you must disable the VS Code server before making any changes to the remote filesystem from outside the VS Code editor (that includes changes made from the terminal or via Github).
+              Failing to do so may result in loss of data. After making the changes, re-enable the server. The real-time database will automatically resync with the remote filesystem.</p>
+            <p>Enter your admin password and press submit to commit changes.</p>
+            <input class="user" type="text" autocomplete="username" />
+            <input id="base" type="hidden" name="base" value="/" />
+            <input id="form_id" type="hidden" name="form_id" value="1" />
+            <div class="field">
+              <input
+                id="pswd"
+                required
+                autofocus
+                class="password"
+                type="password"
+                placeholder="PASSWORD"
+                name="admin"
+                autocomplete="current-password"
+                value=""
+              />
+              <input class="submit -button" value="SUBMIT" type="submit" />
+            </div>
+            <span id="collab_error">{{ERROR}}</span>
+          </form>
+        </div>
+      </div>
+
+      <div class="card-box">
+        <div class="header">
+          <h2 class="main">Version</h2>
+          <div class="sub">Version information and updates.</div>
+        </div>
+        <div class="content">
+          No updates found.
+        </div>
+      </div>
+    </div>
+    <script>
+        $("#collab-form").submit(function(e) {
+            e.preventDefault(); // avoid to execute the actual submit of the form.
+            var form = $(this);
+            var url = form.attr('action');
+            $.ajax({
+                type: "POST",
+                url: url,
+                data: form.serialize(), // serializes the form's elements.
+                success: function(data)
+                {
+                    //data = JSON.parse(data);
+                    data = data.content;
+                    if(data){
+                        if(data.admin){
+                            $('#collab-status').html((data.collab?"<span style='color:#66b2ff;font-weight:bold'>Enabled</span>":"<span style='color:#ff6666;font-weight:bold'>Disabled</span>"));
+                            $('#reset-status').show().html((data.reset?"<span style='color:#66b2ff;font-weight:bold'>Database Reset</span>":""));
+                            $('#disable-status').html((data.disable?"<span style='color:#ff6666;font-weight:bold'>Server Offline</span>":"<span style='color:#66b2ff;font-weight:bold'>Server Running</span>"))
+                            $('#reset1').prop("checked",false);
+                            $( '#reset-status').delay( 2000 ).fadeOut( 400 );
+                        }
+                        
+                        $('#pswd').val("");
+                        if(data.err){
+                            $('#collab_error').html("<div id='frm1_err' style='padding:15px;color:#ff6666;font-weight:bold' class='error'>"+data.err+"</div>");
+                        }else{
+                            $('#collab_error').html(data.admin?"":"<div id='frm1_err' style='padding:15px;color:#ff6666;font-weight:bold' class='error'>Incorrect Password</div>");
+                        }
+                        if(!data.admin){
+                            $('#frm1_err').effect( "shake" );
+                        }
+                    }
+                }
+            });
+        });
+    </script>
+    <script data-cfasync="false" src="{{CS_STATIC_BASE}}/dist/register.js"></script>
+  </body>
+</html>
+
diff --git a/src/browser/pages/login.css b/src/browser/pages/login.css
index f0586ee8..fbf6593d 100644
--- a/src/browser/pages/login.css
+++ b/src/browser/pages/login.css
@@ -3,7 +3,7 @@ body {
 }
 
 .login-form {
-  display: flex;
+  display: block;
   flex-direction: column;
   flex: 1;
   justify-content: center;
diff --git a/src/browser/pages/vscode.html b/src/browser/pages/vscode.html
index c46cb47a..4ef27319 100644
--- a/src/browser/pages/vscode.html
+++ b/src/browser/pages/vscode.html
@@ -34,13 +34,90 @@
     <link rel="apple-touch-icon" sizes="512x512" href="{{CS_STATIC_BASE}}/src/browser/media/pwa-icon-512.png" />
     <meta name="apple-mobile-web-app-capable" content="yes" />
 
+   <!-- Prefetch to avoid waterfall -->
+    <!-- PROD_ONLY
+    <link rel="prefetch" href="{{CS_STATIC_BASE}}/lib/vscode/node_modules/semver-umd/lib/semver-umd.js">
+    END_PROD_ONLY -->
+    <!-- Firebase -->
+    <script src="https://www.gstatic.com/firebasejs/5.5.4/firebase.js"></script>
+    <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.4.1/jquery.min.js"></script>
+
+    <!-- Firepad -->
+    <link rel="stylesheet" href="https://firepad.io/releases/v1.5.9/firepad.css" />
+    <script src="{{CS_STATIC_BASE}}/cpr/coderpair-firepad.min.js"></script>
+    <link rel="stylesheet" href="{{CS_STATIC_BASE}}/cpr/userlist.css" />
+    <meta name="apple-mobile-web-app-capable" content="yes" />
     <meta id="coder-options" data-settings="{{OPTIONS}}" />
+    <style>
+         .powered-by-wbx {
+               position: absolute;
+               display: block;
+               z-index: 5;
+               right: 60px;
+               bottom: 18px;
+               width: 48px;
+               height: 19px;
+               background-size: 48px 19px;
+               background-image:url('data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAEAAAAAaCAMAAAAwoqp9AAAAAXNSR0IB2cksfwAAAAlwSFlzAAALEwAACxMBAJqcGAAAAblQTFRFAAAA5P3k3/3h0f/R0P3R0v3T0/3U0f3S0//T1f3W0/3V2v/f3fzd2/zb0P3Q2fzZ0v7U0/zT1/3X0v3U0v3S1P3U0P3S1vzX1f3V4P3i1f3V4P/g0v3T1f/V1PzU1f3W1v3X1P3V2//b6P/o7v/u1f3W////0/3U1v3X1fzV2v/g2P3Y0/7U1P3V1/3Z1v3X0/zV1P3V1f3V1f3X2f/e5v/m0P3S0f3S3v/e1f7V0v3T2/zd3/3f4Pzk1f3X0P3S4P/g4//j1P3V6f/p4Pzg0v3T3/3f1v3Y2f3Z1P3U1v3X1PzW0v3T3v3e1v3X1f3X1P3U5f3lz/3S1f3W6v/q1P3V2P3Z0v3U3v3e0/3U1f3V1f3W1P3X2f3Z2v/a0f3R4/zl2PzY2f3Z1v3X2v7a1/3Z1vzY5v/s0/3U2v3b1/3Y1/7Y7f/t0/7T2f/Z0f3T1/3X2f7b8P/w1/3X2f3b1P3V1P7U2/zb5v/m2Pzb3//f1v3Y7P/s4f/h3P3c1PzX0f3R1PzV1P3W1/3X1f3X2P3Z1v3Y1f3V////6v/q1P3U2f3a2vzb2/7b2f3Z2P3a2v7b2v3a1/3YmWsuwgAAAJN0Uk5TAGh3Pf////8po6MwS1yZSb1cZplmmZnI/2ujOtU9wvv2/zghD/8E5PjAKW+43Zn/XJmZmT0K2949utFid0t5oyk29C5L1qXvmevoy6OZ34xmbGbrPfj/Zn33qexmZin/ZE//9bxmwijR6t24HbU9qH6+EZij+7BUNFwIihs8e01qw32UhdGceQMM//TIr5ylueX/QXoW7AAAAhxJREFUeJzNVGlbE0EMjpDZVdEVSltRFAWKCCIFBKkcoqJyQ11APLAICniAiig3eAsCKvqLSWa67XT3i/TxA3memUneJO9mMjML8D/lQEaaiZmIwjAR8WC6nz6EUg6nmw9ZiuBI2gQg800dOWod2wuBYIJsDcgh27cHAoMJcjXAItsfsIJByzr+LwR5THBCA+hgTkL+KYZPAxSgOHO2UBQpX3HIS1DCkV74XCnieafCsnJSLlTwcePFSldkmEBDs6sC1TU1l2ohGIepR6KOOnuZs41CmuojHoIrmh1p4MhGaFKFNdNyVXUWW64BXL9BNM1uAiuF0lCpNLcC5NJSDjfNRJ0R0m65exBIWLdptCHmKZ52gA7EToAuLqBbhfAu9E2w3ZOko9GL2EdLBVfWSt4ogKnuq2kKU6p+V8F3HCMaVgQ2LdTFfrmDUIIgIbZGwDdxwDEG7yqCIVrucSvuIz4g/SHvwPazDEWHfY9iGsEI+R7H9VEco/lJ/CqT4ymNcVUNTqiYSXAJV+TcjWf4XNUk9/gi+c7yWXvJ2pRAMR185SJ4rdQ3iDMAb52v+SXBrHS9Y/W9Zc1xN7rntfwF9owskrZUTdoyQCUjKwSs6n+KtWQHP6TsYFyBwpDPGj8CfEKnhOTtIYl8lu9WzMZS8uGL53xE+Kttf2PfdwLWU6I33B2EH9wmsRne2v756/fOn7/DutOHxlbMk7KPZBdeKD2ukNqYFwAAAABJRU5ErkJggg==');
+               opacity: 0.4;
+        }
+   </style>
   </head>
 
-  <body aria-label=""></body>
-
+  <body aria-label="" onload="firepad_init()">
+    <div id='firepad-userlist' style='position:fixed;z-index:99;visibility:hidden;width:300px;height:230px;bottom:60px;right:10px'></div>
+    </body>
   <!-- Startup (do not modify order of script tags!) -->
   <script data-cfasync="false" src="{{CS_STATIC_BASE}}/dist/pages/vscode.js"></script>
+<!-- BEGIN MAIN CODERPAIR MODIFICATION - VSCODE WITH REAL TIME COLLAB AND DEFAULT THEME VARIANT -->
+<script>
+
+  var monaco = {};
+  var wb_monaco = {};
+
+  wb_monaco.logo = "powered-by-wbx";
+  wb_monaco.disabled = {{COLLAB_DISABLED}};
+  wb_monaco.displayName = "{{CURRENT_USER}}";
+  wb_monaco.currentUser = wb_monaco.displayName.replace(/([^a-z0-9]+)/gi, '-');
+
+  wb_monaco.firepad_ref = {
+    childref: "{{FIREBASE_REF}}"   //A starting point for the db
+  };
+
+  function firepad_init() {
+    if(!wb_monaco.disabled){
+        //// Initialize Firebase.
+        var config = {
+            apiKey: "{{FIREBASE_APIKEY}}",
+            authDomain: "{{FIREBASE_AUTHDOMAIN}}",
+            databaseURL: "{{FIREBASE_DATABASEURL}}"
+        };
+        firebase.initializeApp(config);
+        wb_monaco.user = firebase.database().ref('users').push().key;
+
+        wb_monaco.userList = FirepadUserList.fromDiv(firebase.database().ref('users'),
+        document.getElementById('firepad-userlist'), wb_monaco.user, (wb_monaco.displayName!='default'?wb_monaco.displayName:null));
+    }
+  }; 
+
+  //DEBUG
+  isDebug = false; // toggle this to turn on / off for global controll
+  isDebug1 = false; // toggle this to turn on / off firepad logging
+  isDebug2 = false; // toggle this to turn on / off entry logging
+  isDebug3 = false; // toggle this to turn on / off workbench logging
+  var log1,log2,log3;
+  if (isDebug1&&isDebug) log1 = console.log.bind(window.console)
+  else log1 = function(){}
+  if (isDebug2&&isDebug) log2 = console.log.bind(window.console)
+  else log2 = function(){}
+  if (isDebug3&&isDebug) log3 = console.log.bind(window.console)
+  else log3 = function(){}
+
+</script>
+
+<script data-cfasync="false" src="{{CS_STATIC_BASE}}/cpr/coderpair.js"></script>
+<script data-cfasync="false" src="{{CS_STATIC_BASE}}/cpr/userlist.js"></script>
+<!-- END MAIN CODERPAIR MODIFICATION - VSCODE WITH REAL TIME COLLAB AND DEFAULT THEME VARIANT -->
   <script data-cfasync="false" src="{{CS_STATIC_BASE}}/dist/register.js"></script>
   <script data-cfasync="false" src="{{CS_STATIC_BASE}}/lib/vscode/out/vs/loader.js"></script>
   <script>
diff --git a/src/browser/register.ts b/src/browser/register.ts
index 4f834580..db7226e1 100644
--- a/src/browser/register.ts
+++ b/src/browser/register.ts
@@ -5,6 +5,7 @@ const options = getOptions()
 import "./pages/error.css"
 import "./pages/global.css"
 import "./pages/login.css"
+import "./pages/home.css"
 
 if ("serviceWorker" in navigator) {
   const path = normalize(`${options.csStaticBase}/dist/serviceWorker.js`)
diff --git a/src/common/http.ts b/src/common/http.ts
index c08c8673..7b7358cd 100644
--- a/src/common/http.ts
+++ b/src/common/http.ts
@@ -18,3 +18,11 @@ export class HttpError extends Error {
     this.name = this.constructor.name
   }
 }
+
+export enum ApiEndpoint {
+  applications = "/applications",
+  process = "/process",
+  recent = "/recent",
+  run = "/run",
+  status = "/status",
+}
\ No newline at end of file
diff --git a/src/node/app.ts b/src/node/app.ts
index 448ec966..ae08ce16 100644
--- a/src/node/app.ts
+++ b/src/node/app.ts
@@ -22,8 +22,9 @@ export const createApp = async (args: DefaultedArgs): Promise<[Express, Express,
       )
     : http.createServer(app)
 
-  await new Promise<http.Server>(async (resolve, reject) => {
-    server.on("error", reject)
+  await new Promise<void>(async (resolve, reject) => {
+    server.on("error", (err) => {
+      reject(err)})
     if (args.socket) {
       try {
         await fs.unlink(args.socket)
@@ -32,10 +33,10 @@ export const createApp = async (args: DefaultedArgs): Promise<[Express, Express,
           logger.error(error.message)
         }
       }
-      server.listen(args.socket, resolve)
+      server.listen(args.socket,()=>{resolve()})
     } else {
       // [] is the correct format when using :: but Node errors with them.
-      server.listen(args.port, args.host.replace(/^\[|\]$/g, ""), resolve)
+      server.listen(args.port, args.host.replace(/^\[|\]$/g, ""),()=>{resolve()})
     }
   })
 
diff --git a/src/node/appsettings.ts b/src/node/appsettings.ts
new file mode 100644
index 00000000..ba90c51b
--- /dev/null
+++ b/src/node/appsettings.ts
@@ -0,0 +1,5 @@
+export const appSettings = {
+    disabled: false,
+    useCollaboration: false,
+    ref: {}
+  }
diff --git a/src/node/cli.ts b/src/node/cli.ts
index 1653e87a..b35863d3 100644
--- a/src/node/cli.ts
+++ b/src/node/cli.ts
@@ -54,9 +54,14 @@ export interface Args extends VsArgs {
   _: string[]
   "reuse-window"?: boolean
   "new-window"?: boolean
-
   link?: OptionalString
   home?: string
+  users?: any
+  admin?: string
+  "firebase-apiKey"?: string
+  "firebase-authDomain"?: string
+  "firebase-databaseURL"?: string
+  "firebase-ref"?: string
 }
 
 interface Option<T> {
@@ -94,7 +99,7 @@ type OptionType<T> = T extends boolean
   ? "string"
   : T extends string[]
   ? "string[]"
-  : "unknown"
+  : "any"
 
 type Options<T> = {
   [P in keyof T]: Option<OptionType<T[P]>>
@@ -205,6 +210,30 @@ const options: Options<Required<Args>> = {
     type: "string",
     description: "Set a custom link for the 'Go Home' button in the Application Menu",
   },
+  admin: {
+    type: "string",
+    description: "Administrative password.",
+  },
+  users: {
+    type: "any",
+    description: "User accounts.",
+  },
+  "firebase-apiKey":{
+    type: "string",
+    description: "API Key from firebase",
+  },
+  "firebase-authDomain":{
+    type: "string",
+    description: "Firebase authDomain parameter.",
+  },
+  "firebase-databaseURL":{
+    type: "string",
+    description: "Firebase databaseURL parameter.",
+  },
+  "firebase-ref":{
+    type: "string",
+    description: "Firebase child ref.",
+  },
 }
 
 export const optionDescriptions = (): string[] => {
@@ -437,6 +466,10 @@ export async function setDefaults(cliArgs: Args, configArgs?: ConfigArgs): Promi
     args.auth = AuthType.Password
   }
 
+  if (!args.admin) {
+    args.admin = 'admin'
+  }
+
   const addr = bindAddrFromAllSources(configArgs || { _: [] }, cliArgs)
   args.host = addr.host
   args.port = addr.port
@@ -489,6 +522,7 @@ async function defaultConfigFile(): Promise<string> {
   return `bind-addr: 127.0.0.1:8080
 auth: password
 password: ${await generatePassword()}
+admin: ${await generatePassword()}
 cert: false
 `
 }
@@ -525,19 +559,28 @@ export async function readConfigFile(configPath?: string): Promise<ConfigArgs> {
 
   // We convert the config file into a set of flags.
   // This is a temporary measure until we add a proper CLI library.
+  /*
   const configFileArgv = Object.entries(config).map(([optName, opt]) => {
     if (opt === true) {
       return `--${optName}`
     }
     return `--${optName}=${opt}`
   })
-  const args = parse(configFileArgv, {
-    configFile: configPath,
-  })
-  return {
-    ...args,
-    config: configPath,
-  }
+  */
+ const args: {[key: string]: any} = {};
+   for (let [key, value] of Object.entries(config)) {
+     if(value)args[key]=value
+   }
+  
+  //const args = parse(configFileArgv, {
+  //  configFile: configPath,
+  //})
+
+   return {
+    _:[],
+     ...args,
+     config: configPath,
+   }
 }
 
 function parseBindAddr(bindAddr: string): Addr {
diff --git a/src/node/dashboard.ts b/src/node/dashboard.ts
new file mode 100644
index 00000000..3241ee05
--- /dev/null
+++ b/src/node/dashboard.ts
@@ -0,0 +1,88 @@
+
+import { Request } from "express"
+import { appSettings } from "./appsettings"
+import { adminAuthenticated, disableServer} from "./http"
+import { hash } from "./util"
+
+interface Environment {
+  server_disabled: number;
+  collaboration: number;
+}
+
+const env: Environment = {
+  server_disabled: 0,
+  collaboration: 0
+}
+
+/**
+ * Provide update information.
+ */
+export class DashboardProvider {
+
+  public constructor(
+    
+  ) {}
+
+   /**
+     * Try logging in. On failure, show the login page with an error.
+     */
+    public handlePost(req: Request): any {
+      try {
+          let response = {};
+          //console.log(req.body);
+          if(!appSettings.ref){
+            response = {content:{
+              err:'Not permitted. Firebase not initialized.'}
+            };
+          }else if(req.body.form_id=="1") {
+              const admin = adminAuthenticated(req, {
+                  key: typeof req.body.admin === "string" ? hash(req.body.admin) : undefined
+              });
+              if(admin){
+                  response = this.processCollaboration(req);
+              }else{
+                  response = {content:{
+                      admin:0}
+                  };
+              }
+              //console.log(response);
+          }
+          return response
+      } catch (error) {
+        return {content:{
+          err:'An unknown error occurred.'}
+        }
+      }
+    }
+    
+    private processCollaboration(req:Request): any {
+        const disable = (req.body.disable=="on"?1:0);
+        const collaboration = (req.body.collaboration=="on"?1:0);
+        const reset1 = (req.body.reset1=="on"?1:0);
+       
+        if(collaboration != env.collaboration || reset1 == 1 || disable != env.server_disabled){
+                disableServer();
+                if(appSettings.ref){
+                  const ref:any = appSettings.ref;
+                  if (ref)
+                    ref.remove()
+                }
+                appSettings.disabled = true;
+        } //turn off
+        env.server_disabled = disable;
+        env.collaboration = collaboration;
+        appSettings.useCollaboration = env.collaboration?true:false;
+        if(env.server_disabled==0){
+           appSettings.disabled = false;
+        }
+        let response = {content:{
+            admin:1,
+            collab:env.collaboration,
+            reset:reset1,
+            disable:env.server_disabled}
+        };
+        return response
+    }
+
+  
+}
diff --git a/src/node/entry.ts b/src/node/entry.ts
index 2f569b4e..35fccefe 100644
--- a/src/node/entry.ts
+++ b/src/node/entry.ts
@@ -21,6 +21,10 @@ import * as proxyAgent from "./proxy_agent"
 import { register } from "./routes"
 import { humanPath, isFile, open } from "./util"
 import { isChild, wrapper } from "./wrapper"
+import firebase from "firebase"
+import { appSettings } from "./appsettings"
+ 
+let firebaseApp:any = null;
 
 export const runVsCodeCli = (args: DefaultedArgs): void => {
   logger.debug("forking vs code cli...")
@@ -105,6 +109,24 @@ const main = async (args: DefaultedArgs): Promise<void> => {
     )
   }
 
+  // Initialize Firebase
+  const firebaseConfig = {
+    apiKey: args["firebase-apiKey"] || '<API_KEY>',
+    authDomain: args["firebase-authDomain"],
+    databaseURL: args["firebase-databaseURL"] 
+  }
+
+  if(args["firebase-authDomain"]){
+    firebaseApp = firebase.initializeApp(firebaseConfig)
+    console.log("init firebase...")
+  }else{
+    console.log("No firebase configuration specified...Skipping...")
+  }
+  
+  const ref = (args["firebase-authDomain"]?firebaseApp.database().ref():null)
+  const childref = (args["firebase-authDomain"]?ref.child(args["firebase-ref"]):null)
+  appSettings.ref = childref;
+
   const [app, wsApp, server] = await createApp(args)
   const serverAddress = ensureAddress(server)
   await register(app, wsApp, server, args)
diff --git a/src/node/http.ts b/src/node/http.ts
index 18fee9f8..1782d5b5 100644
--- a/src/node/http.ts
+++ b/src/node/http.ts
@@ -1,19 +1,36 @@
 import { field, logger } from "@coder/logger"
-import * as express from "express"
+import {Request, Response, NextFunction} from "express"
 import * as expressCore from "express-serve-static-core"
 import qs from "qs"
 import safeCompare from "safe-compare"
+import { Emitter } from "../common/emitter"
 import { HttpCode, HttpError } from "../common/http"
 import { normalize, Options } from "../common/util"
 import { AuthType } from "./cli"
 import { commit, rootPath } from "./constants"
 import { hash } from "./util"
 
+
+export type Cookies = { [key: string]: string | undefined }
+export type PostData = { [key: string]: string | string[] | undefined }
+
+export interface IAuthUser {
+  user:string,
+	key: string
+}
+
+interface AuthPayload extends Cookies {
+  key?: string
+}
+
+const _onDisable = new Emitter<void>()
+export const onDisable = _onDisable.event
+
 /**
  * Replace common variable strings in HTML templates.
  */
 export const replaceTemplates = <T extends object>(
-  req: express.Request,
+  req: Request,
   content: string,
   extraOpts?: Omit<T, "base" | "csStaticBase" | "logLevel">,
 ): string => {
@@ -34,7 +51,7 @@ export const replaceTemplates = <T extends object>(
 /**
  * Throw an error if not authorized. Call `next` if provided.
  */
-export const ensureAuthenticated = (req: express.Request, _?: express.Response, next?: express.NextFunction): void => {
+export const ensureAuthenticated = (req: Request, _?: Response, next?: NextFunction): void => {
   if (!authenticated(req)) {
     throw new HttpError("Unauthorized", HttpCode.Unauthorized)
   }
@@ -46,23 +63,59 @@ export const ensureAuthenticated = (req: express.Request, _?: express.Response,
 /**
  * Return true if authenticated via cookies.
  */
-export const authenticated = (req: express.Request): boolean => {
+export const authenticated = (req: Request, payload?: AuthPayload): IAuthUser | boolean => {
   switch (req.args.auth) {
     case AuthType.None:
       return true
     case AuthType.Password:
-      // The password is stored in the cookie after being hashed.
-      return !!(
-        req.cookies.key &&
+      if (typeof payload === "undefined") {
+        payload={
+          key:req.cookies.key
+        }
+      }
+      if(
+        payload.key &&
         (req.args["hashed-password"]
-          ? safeCompare(req.cookies.key, req.args["hashed-password"])
-          : req.args.password && safeCompare(req.cookies.key, hash(req.args.password)))
-      )
+          ? safeCompare(payload.key, req.args["hashed-password"])
+          : req.args.password && safeCompare(payload.key, hash(req.args.password)))
+      ){
+        return {user: 'default' , key: payload.key}
+      }
+      if(req.args.users && payload.key){
+        for(let user in req.args.users){
+          if (safeCompare(payload.key, hash(req.args.users[user].password))) {
+            return {user: user , key: payload.key}
+          }
+        }
+      }
+      return false
     default:
       throw new Error(`Unsupported auth type ${req.args.auth}`)
   }
 }
 
+/**
+    * Return the provided password value if the payload contains the right
+    * password otherwise return false.
+    */
+export const adminAuthenticated = (req: Request, payload?: AuthPayload): string | boolean => {
+    if (req.args.admin && payload && payload.key) {
+        if (safeCompare(payload.key, hash(req.args.admin))) {
+           return payload.key;
+        }
+    }
+    return false;
+ };
+
+
+/**
+  * Disable vscode server from dashboard
+  * 
+  */
+export const disableServer = (): void => {
+    _onDisable.emit()
+};
+
 /**
  * Get the relative path that will get us to the root of the page. For each
  * slash we need to go up a directory. For example:
@@ -72,7 +125,7 @@ export const authenticated = (req: express.Request): boolean => {
  * /foo/bar => ./..
  * /foo/bar/ => ./../..
  */
-export const relativeRoot = (req: express.Request): string => {
+export const relativeRoot = (req: Request): string => {
   const depth = (req.originalUrl.split("?", 1)[0].match(/\//g) || []).length
   return normalize("./" + (depth > 1 ? "../".repeat(depth - 1) : ""))
 }
@@ -82,8 +135,8 @@ export const relativeRoot = (req: express.Request): string => {
  * `override` will merge with the existing query (use `undefined` to unset).
  */
 export const redirect = (
-  req: express.Request,
-  res: express.Response,
+  req: Request,
+  res: Response,
   to: string,
   override: expressCore.Query = {},
 ): void => {
diff --git a/src/node/routes/dashboard.ts b/src/node/routes/dashboard.ts
new file mode 100644
index 00000000..5c6d0705
--- /dev/null
+++ b/src/node/routes/dashboard.ts
@@ -0,0 +1,42 @@
+import { Router, Request } from "express"
+import { promises as fs } from "fs"
+import { appSettings } from "../appsettings"
+import * as path from "path"
+import { rootPath } from "../constants"
+import { ensureAuthenticated, authenticated, replaceTemplates, redirect } from "../http"
+import { DashboardProvider } from "../dashboard"
+
+export const router = Router()
+
+const provider = new DashboardProvider()
+
+router.get("/", async (req, res) => {
+  if (!authenticated(req)) {
+    return redirect(req, res, "login", {
+      // req.baseUrl can be blank if already at the root.
+      to: req.baseUrl && req.baseUrl !== "/" ? req.baseUrl : undefined,
+    })
+  }
+  res.send(await getRoot(req))
+})
+
+router.post("/", ensureAuthenticated, async (req, res) => {
+    const response = provider.handlePost(req);
+    res.json(response)
+})
+
+const getRoot = async (req: Request, error?: Error): Promise<string> => {
+  const content = await fs.readFile(path.join(rootPath, "src/browser/pages/home.html"), "utf8")
+  
+  return replaceTemplates(
+    req,
+    content
+    .replace(/{{COLLAB}}/, appSettings.useCollaboration ? "<span style='color:#66b2ff;font-weight:bold'>Enabled</span>" : "<span style='color:#ff6666;font-weight:bold'>Disabled</span>")
+    .replace(/{{VSCODE_SERVER}}/, appSettings.disabled ? "<span style='color:#ff6666;font-weight:bold'>Server Offline</span>" : "<span style='color:#66b2ff;font-weight:bold'>Server Running</span>")
+    .replace(/{{COLLAB_CHECKED}}/, appSettings.useCollaboration ? "checked":"")
+    .replace(/{{VSCODE_SERVER_CHECKED}}/, appSettings.disabled ? "checked":"")
+    .replace(/{{ERROR}}/, error ? "<div class=\"error\">" + error.message + "</div>" : "")
+  )
+}
+
+
diff --git a/src/node/routes/index.ts b/src/node/routes/index.ts
index a7b7c185..59785130 100644
--- a/src/node/routes/index.ts
+++ b/src/node/routes/index.ts
@@ -19,6 +19,7 @@ import * as apps from "./apps"
 import * as domainProxy from "./domainProxy"
 import * as health from "./health"
 import * as login from "./login"
+import * as dashboard from "./dashboard"
 import * as proxy from "./pathProxy"
 // static is a reserved keyword.
 import * as _static from "./static"
@@ -118,6 +119,8 @@ export const register = async (
     })
   }
 
+  app.use("/dashboard", dashboard.router)
+
   app.use("/proxy", proxy.router)
   wsApp.use("/proxy", proxy.wsRouter.router)
 
diff --git a/src/node/routes/login.ts b/src/node/routes/login.ts
index c3ad12ad..5a6a276d 100644
--- a/src/node/routes/login.ts
+++ b/src/node/routes/login.ts
@@ -2,9 +2,8 @@ import { Router, Request } from "express"
 import { promises as fs } from "fs"
 import { RateLimiter as Limiter } from "limiter"
 import * as path from "path"
-import safeCompare from "safe-compare"
 import { rootPath } from "../constants"
-import { authenticated, getCookieDomain, redirect, replaceTemplates } from "../http"
+import { authenticated, getCookieDomain, IAuthUser, redirect, replaceTemplates } from "../http"
 import { hash, humanPath } from "../util"
 
 enum Cookie {
@@ -45,6 +44,7 @@ const limiter = new RateLimiter()
 
 export const router = Router()
 
+/*
 router.use((req, res, next) => {
   const to = (typeof req.query.to === "string" && req.query.to) || "/"
   if (authenticated(req)) {
@@ -52,6 +52,7 @@ router.use((req, res, next) => {
   }
   next()
 })
+*/
 
 router.get("/", async (req, res) => {
   res.send(await getRoot(req))
@@ -67,14 +68,14 @@ router.post("/", async (req, res) => {
       throw new Error("Missing password")
     }
 
-    if (
-      req.args["hashed-password"]
-        ? safeCompare(hash(req.body.password), req.args["hashed-password"])
-        : req.args.password && safeCompare(req.body.password, req.args.password)
-    ) {
+    const userData = authenticated(req, {
+      key: hash(req.body.password)
+    })
+
+    if (userData) {
       // The hash does not add any actual security but we do it for
       // obfuscation purposes (and as a side effect it handles escaping).
-      res.cookie(Cookie.Key, hash(req.body.password), {
+      res.cookie(Cookie.Key, (<IAuthUser>userData).key, {
         domain: getCookieDomain(req.headers.host || "", req.args["proxy-domain"]),
         path: req.body.base || "/",
         sameSite: "lax",
@@ -83,7 +84,7 @@ router.post("/", async (req, res) => {
       const to = (typeof req.query.to === "string" && req.query.to) || "/"
       return redirect(req, res, to, { to: undefined })
     }
-
+    
     console.error(
       "Failed login attempt",
       JSON.stringify({
diff --git a/src/node/routes/vscode.ts b/src/node/routes/vscode.ts
index 38ac42bb..851ba2d1 100644
--- a/src/node/routes/vscode.ts
+++ b/src/node/routes/vscode.ts
@@ -6,8 +6,9 @@ import qs from "qs"
 import { Emitter } from "../../common/emitter"
 import { HttpCode, HttpError } from "../../common/http"
 import { getFirstString } from "../../common/util"
+import { appSettings } from "../appsettings"
 import { commit, rootPath, version } from "../constants"
-import { authenticated, ensureAuthenticated, redirect, replaceTemplates } from "../http"
+import { authenticated, ensureAuthenticated, IAuthUser, redirect, replaceTemplates } from "../http"
 import { getMediaMime, pathToFsPath } from "../util"
 import { VscodeProvider } from "../vscode"
 import { Router as WsRouter } from "../wsRouter"
@@ -16,8 +17,17 @@ export const router = Router()
 
 const vscode = new VscodeProvider()
 
+
+router.get("/",(req, res, next) => {
+  if (appSettings.disabled) {
+    throw new Error(`VS Code is currently disabled. Try again later.`)
+  }
+  next()
+})
+
 router.get("/", async (req, res) => {
-  if (!authenticated(req)) {
+  let userData: IAuthUser | boolean;
+  if (!(userData = authenticated(req))) {
     return redirect(req, res, "login", {
       // req.baseUrl can be blank if already at the root.
       to: req.baseUrl && req.baseUrl !== "/" ? req.baseUrl : undefined,
@@ -28,7 +38,7 @@ router.get("/", async (req, res) => {
     await fs.readFile(path.join(rootPath, "src/browser/pages/vscode.html"), "utf8"),
     (async () => {
       try {
-        return await vscode.initialize({ args: req.args, remoteAuthority: req.headers.host || "" }, req.query)
+        return await vscode.initialize({ args: req.args, remoteAuthority: req.headers.host || "", userData: userData}, req.query)
       } catch (error) {
         const devMessage = commit === "development" ? "It might not have finished compiling." : ""
         throw new Error(`VS Code failed to load. ${devMessage} ${error.message}`)
@@ -36,6 +46,8 @@ router.get("/", async (req, res) => {
     })(),
   ])
 
+  const user = (userData?(<IAuthUser>userData).user:'default')
+
   options.productConfiguration.codeServerVersion = version
 
   res.send(
@@ -50,9 +62,15 @@ router.get("/", async (req, res) => {
       },
     )
       .replace(`"{{REMOTE_USER_DATA_URI}}"`, `'${JSON.stringify(options.remoteUserDataUri)}'`)
+      .replace(`"{{CURRENT_USER}}"`, `'${user}'`)
       .replace(`"{{PRODUCT_CONFIGURATION}}"`, `'${JSON.stringify(options.productConfiguration)}'`)
       .replace(`"{{WORKBENCH_WEB_CONFIGURATION}}"`, `'${JSON.stringify(options.workbenchWebConfiguration)}'`)
-      .replace(`"{{NLS_CONFIGURATION}}"`, `'${JSON.stringify(options.nlsConfiguration)}'`),
+      .replace(`"{{NLS_CONFIGURATION}}"`, `'${JSON.stringify(options.nlsConfiguration)}'`)
+      .replace("{{COLLAB_DISABLED}}", (appSettings.useCollaboration?'false':'true'))
+      .replace("{{FIREBASE_APIKEY}}", (req.args["firebase-apiKey"]?req.args["firebase-apiKey"]:'<API_KEY>'))
+      .replace("{{FIREBASE_AUTHDOMAIN}}", (req.args["firebase-authDomain"]?req.args["firebase-authDomain"]:'<AUTH_DOMAIN>'))
+      .replace("{{FIREBASE_DATABASEURL}}", (req.args["firebase-databaseURL"]?req.args["firebase-databaseURL"]:'<DATABASE_URL>'))
+      .replace("{{FIREBASE_REF}}", (req.args["firebase-ref"]?req.args["firebase-ref"]:''))
   )
 })
 
diff --git a/src/node/util.ts b/src/node/util.ts
index 11128e54..7c460958 100644
--- a/src/node/util.ts
+++ b/src/node/util.ts
@@ -187,7 +187,7 @@ export const open = async (url: string): Promise<void> => {
     url = url.replace(/&/g, "^&")
   }
   const proc = cp.spawn(command, [...args, url], options)
-  await new Promise((resolve, reject) => {
+  await new Promise<void>((resolve, reject) => {
     proc.on("error", reject)
     proc.on("close", (code) => {
       return code !== 0 ? reject(new Error(`Failed to open with code ${code}`)) : resolve()
diff --git a/src/node/vscode.ts b/src/node/vscode.ts
index e382d59b..8c9c6f74 100644
--- a/src/node/vscode.ts
+++ b/src/node/vscode.ts
@@ -6,24 +6,35 @@ import * as ipc from "../../lib/vscode/src/vs/server/ipc"
 import { arrayify, generateUuid } from "../common/util"
 import { rootPath } from "./constants"
 import { settings } from "./settings"
+import { appSettings } from "./appsettings"
 import { SocketProxyProvider } from "./socket"
 import { isFile } from "./util"
 import { onMessage, wrapper } from "./wrapper"
+import { onDisable } from "./http"
 
 export class VscodeProvider {
   public readonly serverRootPath: string
   public readonly vsRootPath: string
   private _vscode?: Promise<cp.ChildProcess>
+  public sockets = new Set<net.Socket>();
   private readonly socketProvider = new SocketProxyProvider()
 
   public constructor() {
     this.vsRootPath = path.resolve(rootPath, "lib/vscode")
     this.serverRootPath = path.join(this.vsRootPath, "out/vs/server")
     wrapper.onDispose(() => this.dispose())
+    onDisable(()=>this.disable())
+  }
+
+  public disable(): void {
+    console.log("disconnect");
+    this.sockets.forEach(socket => socket.destroy());
+    this.dispose();
   }
 
   public async dispose(): Promise<void> {
     this.socketProvider.stop()
+    this.sockets.clear();
     if (this._vscode) {
       const vscode = await this._vscode
       vscode.removeAllListeners()
@@ -117,9 +128,13 @@ export class VscodeProvider {
    * VS Code expects a raw socket. It will handle all the web socket frames.
    */
   public async sendWebsocket(socket: net.Socket, query: ipc.Query): Promise<void> {
+    if (appSettings.disabled) {
+      throw new Error("Server disabled");
+    }
     const vscode = await this._vscode
     // TLS sockets cannot be transferred to child processes so we need an
     // in-between. Non-TLS sockets will be returned as-is.
+    this.sockets.add(socket);
     const socketProxy = await this.socketProvider.createProxy(socket)
     this.send({ type: "socket", query }, vscode, socketProxy)
   }
diff --git a/yarn.lock b/yarn.lock
index e0e3fa62..f4694c19 100644
--- a/yarn.lock
+++ b/yarn.lock
@@ -900,6 +900,247 @@
     minimatch "^3.0.4"
     strip-json-comments "^3.1.1"
 
+"@firebase/analytics-types@0.4.0":
+  version "0.4.0"
+  resolved "https://registry.yarnpkg.com/@firebase/analytics-types/-/analytics-types-0.4.0.tgz#d6716f9fa36a6e340bc0ecfe68af325aa6f60508"
+  integrity sha512-Jj2xW+8+8XPfWGkv9HPv/uR+Qrmq37NPYT352wf7MvE9LrstpLVmFg3LqG6MCRr5miLAom5sen2gZ+iOhVDeRA==
+
+"@firebase/analytics@0.6.2":
+  version "0.6.2"
+  resolved "https://registry.yarnpkg.com/@firebase/analytics/-/analytics-0.6.2.tgz#7f45675a1b524fff4d9e9fe318fd6e2ed067a325"
+  integrity sha512-4Ceov+rPfOEPIdbjlpTim/wbcUUneIesHag4UOzvmFsRRXqbxLwQpyZQWEbTSriUeU8uTKj9yOW32hsskV9Klg==
+  dependencies:
+    "@firebase/analytics-types" "0.4.0"
+    "@firebase/component" "0.1.21"
+    "@firebase/installations" "0.4.19"
+    "@firebase/logger" "0.2.6"
+    "@firebase/util" "0.3.4"
+    tslib "^1.11.1"
+
+"@firebase/app-types@0.6.1":
+  version "0.6.1"
+  resolved "https://registry.yarnpkg.com/@firebase/app-types/-/app-types-0.6.1.tgz#dcbd23030a71c0c74fc95d4a3f75ba81653850e9"
+  integrity sha512-L/ZnJRAq7F++utfuoTKX4CLBG5YR7tFO3PLzG1/oXXKEezJ0kRL3CMRoueBEmTCzVb/6SIs2Qlaw++uDgi5Xyg==
+
+"@firebase/app@0.6.13":
+  version "0.6.13"
+  resolved "https://registry.yarnpkg.com/@firebase/app/-/app-0.6.13.tgz#f2e9fa9e75815e54161dc34659a60f1fffd9a450"
+  integrity sha512-xGrJETzvCb89VYbGSHFHCW7O/y067HRxT7MGehUE1xMxdPVBDNayHnxEuKwzfGvXAjVmajXBKFlKxaCWpgSjCQ==
+  dependencies:
+    "@firebase/app-types" "0.6.1"
+    "@firebase/component" "0.1.21"
+    "@firebase/logger" "0.2.6"
+    "@firebase/util" "0.3.4"
+    dom-storage "2.1.0"
+    tslib "^1.11.1"
+    xmlhttprequest "1.8.0"
+
+"@firebase/auth-interop-types@0.1.5":
+  version "0.1.5"
+  resolved "https://registry.yarnpkg.com/@firebase/auth-interop-types/-/auth-interop-types-0.1.5.tgz#9fc9bd7c879f16b8d1bb08373a0f48c3a8b74557"
+  integrity sha512-88h74TMQ6wXChPA6h9Q3E1Jg6TkTHep2+k63OWg3s0ozyGVMeY+TTOti7PFPzq5RhszQPQOoCi59es4MaRvgCw==
+
+"@firebase/auth-types@0.10.1":
+  version "0.10.1"
+  resolved "https://registry.yarnpkg.com/@firebase/auth-types/-/auth-types-0.10.1.tgz#7815e71c9c6f072034415524b29ca8f1d1770660"
+  integrity sha512-/+gBHb1O9x/YlG7inXfxff/6X3BPZt4zgBv4kql6HEmdzNQCodIRlEYnI+/da+lN+dha7PjaFH7C7ewMmfV7rw==
+
+"@firebase/auth@0.16.1":
+  version "0.16.1"
+  resolved "https://registry.yarnpkg.com/@firebase/auth/-/auth-0.16.1.tgz#8b0c9a9c6ab29694ea6d7f467d91b9d3dd22fce8"
+  integrity sha512-7juD7D/kaxNti/xa5G+ZGJJs+bdJUWOW0MlNBtXwiG+TjMh69EDmwJnQmmc9h/32QVvXt1qo1OGWOoMMpF/2Gg==
+  dependencies:
+    "@firebase/auth-types" "0.10.1"
+
+"@firebase/component@0.1.21":
+  version "0.1.21"
+  resolved "https://registry.yarnpkg.com/@firebase/component/-/component-0.1.21.tgz#56062eb0d449dc1e7bbef3c084a9b5fa48c7c14d"
+  integrity sha512-kd5sVmCLB95EK81Pj+yDTea8pzN2qo/1yr0ua9yVi6UgMzm6zAeih73iVUkaat96MAHy26yosMufkvd3zC4IKg==
+  dependencies:
+    "@firebase/util" "0.3.4"
+    tslib "^1.11.1"
+
+"@firebase/database-types@0.6.1":
+  version "0.6.1"
+  resolved "https://registry.yarnpkg.com/@firebase/database-types/-/database-types-0.6.1.tgz#cf1cfc03e617ed4c2561703781f85ba4c707ff65"
+  integrity sha512-JtL3FUbWG+bM59iYuphfx9WOu2Mzf0OZNaqWiQ7lJR8wBe7bS9rIm9jlBFtksB7xcya1lZSQPA/GAy2jIlMIkA==
+  dependencies:
+    "@firebase/app-types" "0.6.1"
+
+"@firebase/database@0.8.1":
+  version "0.8.1"
+  resolved "https://registry.yarnpkg.com/@firebase/database/-/database-0.8.1.tgz#a7bc1c01052d35817a242c21bfe09ab29ee485a3"
+  integrity sha512-/1HhR4ejpqUaM9Cn3KSeNdQvdlehWIhdfTVWFxS73ZlLYf7ayk9jITwH10H3ZOIm5yNzxF67p/U7Z/0IPhgWaQ==
+  dependencies:
+    "@firebase/auth-interop-types" "0.1.5"
+    "@firebase/component" "0.1.21"
+    "@firebase/database-types" "0.6.1"
+    "@firebase/logger" "0.2.6"
+    "@firebase/util" "0.3.4"
+    faye-websocket "0.11.3"
+    tslib "^1.11.1"
+
+"@firebase/firestore-types@2.1.0":
+  version "2.1.0"
+  resolved "https://registry.yarnpkg.com/@firebase/firestore-types/-/firestore-types-2.1.0.tgz#ad406c6fd7f0eae7ea52979f712daa0166aef665"
+  integrity sha512-jietErBWihMvJkqqEquQy5GgoEwzHnMXXC/TsVoe9FPysXm1/AeJS12taS7ZYvenAtyvL/AEJyKrRKRh4adcJQ==
+
+"@firebase/firestore@2.1.1":
+  version "2.1.1"
+  resolved "https://registry.yarnpkg.com/@firebase/firestore/-/firestore-2.1.1.tgz#e19040faf858cc00cb3b7609945fe490182b36b3"
+  integrity sha512-mcKp8psdKSxujaGjyfmt/thlTG5Gk+gFdJbkx4DnGO1PsJG4H5mE0wG//7tOH7DGeRCAmiagjKhA8nQlf/UNCg==
+  dependencies:
+    "@firebase/component" "0.1.21"
+    "@firebase/firestore-types" "2.1.0"
+    "@firebase/logger" "0.2.6"
+    "@firebase/util" "0.3.4"
+    "@firebase/webchannel-wrapper" "0.4.1"
+    "@grpc/grpc-js" "^1.0.0"
+    "@grpc/proto-loader" "^0.5.0"
+    node-fetch "2.6.1"
+    tslib "^1.11.1"
+
+"@firebase/functions-types@0.4.0":
+  version "0.4.0"
+  resolved "https://registry.yarnpkg.com/@firebase/functions-types/-/functions-types-0.4.0.tgz#0b789f4fe9a9c0b987606c4da10139345b40f6b9"
+  integrity sha512-3KElyO3887HNxtxNF1ytGFrNmqD+hheqjwmT3sI09FaDCuaxGbOnsXAXH2eQ049XRXw9YQpHMgYws/aUNgXVyQ==
+
+"@firebase/functions@0.6.1":
+  version "0.6.1"
+  resolved "https://registry.yarnpkg.com/@firebase/functions/-/functions-0.6.1.tgz#32640b8f877637057dfaaeb122be8c8e99ad1af7"
+  integrity sha512-xNCAY3cLlVWE8Azf+/84OjnaXMoyUstJ3vwVRG0ie22QhsdQuPa1tXTiPX4Tmm+Hbbd/Aw0A/7dkEnuW+zYzaQ==
+  dependencies:
+    "@firebase/component" "0.1.21"
+    "@firebase/functions-types" "0.4.0"
+    "@firebase/messaging-types" "0.5.0"
+    node-fetch "2.6.1"
+    tslib "^1.11.1"
+
+"@firebase/installations-types@0.3.4":
+  version "0.3.4"
+  resolved "https://registry.yarnpkg.com/@firebase/installations-types/-/installations-types-0.3.4.tgz#589a941d713f4f64bf9f4feb7f463505bab1afa2"
+  integrity sha512-RfePJFovmdIXb6rYwtngyxuEcWnOrzdZd9m7xAW0gRxDIjBT20n3BOhjpmgRWXo/DAxRmS7bRjWAyTHY9cqN7Q==
+
+"@firebase/installations@0.4.19":
+  version "0.4.19"
+  resolved "https://registry.yarnpkg.com/@firebase/installations/-/installations-0.4.19.tgz#53f50aeb022996963f89f59560d7b4cf801869da"
+  integrity sha512-QqAQzosKVVqIx7oMt5ujF4NsIXgtlTnej4JXGJ8sQQuJoMnt3T+PFQRHbr7uOfVaBiHYhEaXCcmmhfKUHwKftw==
+  dependencies:
+    "@firebase/component" "0.1.21"
+    "@firebase/installations-types" "0.3.4"
+    "@firebase/util" "0.3.4"
+    idb "3.0.2"
+    tslib "^1.11.1"
+
+"@firebase/logger@0.2.6":
+  version "0.2.6"
+  resolved "https://registry.yarnpkg.com/@firebase/logger/-/logger-0.2.6.tgz#3aa2ca4fe10327cabf7808bd3994e88db26d7989"
+  integrity sha512-KIxcUvW/cRGWlzK9Vd2KB864HlUnCfdTH0taHE0sXW5Xl7+W68suaeau1oKNEqmc3l45azkd4NzXTCWZRZdXrw==
+
+"@firebase/messaging-types@0.5.0":
+  version "0.5.0"
+  resolved "https://registry.yarnpkg.com/@firebase/messaging-types/-/messaging-types-0.5.0.tgz#c5d0ef309ced1758fda93ef3ac70a786de2e73c4"
+  integrity sha512-QaaBswrU6umJYb/ZYvjR5JDSslCGOH6D9P136PhabFAHLTR4TWjsaACvbBXuvwrfCXu10DtcjMxqfhdNIB1Xfg==
+
+"@firebase/messaging@0.7.3":
+  version "0.7.3"
+  resolved "https://registry.yarnpkg.com/@firebase/messaging/-/messaging-0.7.3.tgz#31dded892455e4d0680e1452ff2fbfdfb9e4ce9b"
+  integrity sha512-63nOP2SmQJrj9jrhV3K96L5MRKS6AqmFVLX1XbGk6K6lz38ZC4LIoCcHxzUBXY7fCAuZvNmh/YB3pE8B2mTs8A==
+  dependencies:
+    "@firebase/component" "0.1.21"
+    "@firebase/installations" "0.4.19"
+    "@firebase/messaging-types" "0.5.0"
+    "@firebase/util" "0.3.4"
+    idb "3.0.2"
+    tslib "^1.11.1"
+
+"@firebase/performance-types@0.0.13":
+  version "0.0.13"
+  resolved "https://registry.yarnpkg.com/@firebase/performance-types/-/performance-types-0.0.13.tgz#58ce5453f57e34b18186f74ef11550dfc558ede6"
+  integrity sha512-6fZfIGjQpwo9S5OzMpPyqgYAUZcFzZxHFqOyNtorDIgNXq33nlldTL/vtaUZA8iT9TT5cJlCrF/jthKU7X21EA==
+
+"@firebase/performance@0.4.5":
+  version "0.4.5"
+  resolved "https://registry.yarnpkg.com/@firebase/performance/-/performance-0.4.5.tgz#3ab89208ed6fb80165e5594058e46dc85113cd78"
+  integrity sha512-oenEOaV/UzvV8XPi8afYQ71RzyrHoBesqOyXqb1TOg7dpU+i+UJ5PS8K64DytKUHTxQl+UJFcuxNpsoy9BpWzw==
+  dependencies:
+    "@firebase/component" "0.1.21"
+    "@firebase/installations" "0.4.19"
+    "@firebase/logger" "0.2.6"
+    "@firebase/performance-types" "0.0.13"
+    "@firebase/util" "0.3.4"
+    tslib "^1.11.1"
+
+"@firebase/polyfill@0.3.36":
+  version "0.3.36"
+  resolved "https://registry.yarnpkg.com/@firebase/polyfill/-/polyfill-0.3.36.tgz#c057cce6748170f36966b555749472b25efdb145"
+  integrity sha512-zMM9oSJgY6cT2jx3Ce9LYqb0eIpDE52meIzd/oe/y70F+v9u1LDqk5kUF5mf16zovGBWMNFmgzlsh6Wj0OsFtg==
+  dependencies:
+    core-js "3.6.5"
+    promise-polyfill "8.1.3"
+    whatwg-fetch "2.0.4"
+
+"@firebase/remote-config-types@0.1.9":
+  version "0.1.9"
+  resolved "https://registry.yarnpkg.com/@firebase/remote-config-types/-/remote-config-types-0.1.9.tgz#fe6bbe4d08f3b6e92fce30e4b7a9f4d6a96d6965"
+  integrity sha512-G96qnF3RYGbZsTRut7NBX0sxyczxt1uyCgXQuH/eAfUCngxjEGcZQnBdy6mvSdqdJh5mC31rWPO4v9/s7HwtzA==
+
+"@firebase/remote-config@0.1.30":
+  version "0.1.30"
+  resolved "https://registry.yarnpkg.com/@firebase/remote-config/-/remote-config-0.1.30.tgz#2cd6bbbed526a98b154e13a2cc73e748a77d7c3d"
+  integrity sha512-LAfLDcp1AN0V/7AkxBuTKy+Qnq9fKYKxbA5clrXRNVzJbTVnF5eFGsaUOlkes0ESG6lbqKy5ZcDgdl73zBIhAA==
+  dependencies:
+    "@firebase/component" "0.1.21"
+    "@firebase/installations" "0.4.19"
+    "@firebase/logger" "0.2.6"
+    "@firebase/remote-config-types" "0.1.9"
+    "@firebase/util" "0.3.4"
+    tslib "^1.11.1"
+
+"@firebase/storage-types@0.3.13":
+  version "0.3.13"
+  resolved "https://registry.yarnpkg.com/@firebase/storage-types/-/storage-types-0.3.13.tgz#cd43e939a2ab5742e109eb639a313673a48b5458"
+  integrity sha512-pL7b8d5kMNCCL0w9hF7pr16POyKkb3imOW7w0qYrhBnbyJTdVxMWZhb0HxCFyQWC0w3EiIFFmxoz8NTFZDEFog==
+
+"@firebase/storage@0.4.2":
+  version "0.4.2"
+  resolved "https://registry.yarnpkg.com/@firebase/storage/-/storage-0.4.2.tgz#bc5924b87bd2fdd4ab0de49851c0125ebc236b89"
+  integrity sha512-87CrvKrf8kijVekRBmUs8htsNz7N5X/pDhv3BvJBqw8K65GsUolpyjx0f4QJRkCRUYmh3MSkpa5P08lpVbC6nQ==
+  dependencies:
+    "@firebase/component" "0.1.21"
+    "@firebase/storage-types" "0.3.13"
+    "@firebase/util" "0.3.4"
+    tslib "^1.11.1"
+
+"@firebase/util@0.3.4":
+  version "0.3.4"
+  resolved "https://registry.yarnpkg.com/@firebase/util/-/util-0.3.4.tgz#e389d0e0e2aac88a5235b06ba9431db999d4892b"
+  integrity sha512-VwjJUE2Vgr2UMfH63ZtIX9Hd7x+6gayi6RUXaTqEYxSbf/JmehLmAEYSuxS/NckfzAXWeGnKclvnXVibDgpjQQ==
+  dependencies:
+    tslib "^1.11.1"
+
+"@firebase/webchannel-wrapper@0.4.1":
+  version "0.4.1"
+  resolved "https://registry.yarnpkg.com/@firebase/webchannel-wrapper/-/webchannel-wrapper-0.4.1.tgz#600f2275ff54739ad5ac0102f1467b8963cd5f71"
+  integrity sha512-0yPjzuzGMkW1GkrC8yWsiN7vt1OzkMIi9HgxRmKREZl2wnNPOKo/yScTjXf/O57HM8dltqxPF6jlNLFVtc2qdw==
+
+"@grpc/grpc-js@^1.0.0":
+  version "1.2.2"
+  resolved "https://registry.yarnpkg.com/@grpc/grpc-js/-/grpc-js-1.2.2.tgz#ee4a7417fe15a686a8e369c36ec4c80678445c67"
+  integrity sha512-iK/T984Ni6VnmlQK/LJdUk+VsXSaYIWkgzJ0LyOcxN2SowAmoRjG28kS7B1ui/q/MAv42iM3051WBt5QorFxmg==
+  dependencies:
+    "@types/node" "^12.12.47"
+    google-auth-library "^6.1.1"
+    semver "^6.2.0"
+
+"@grpc/proto-loader@^0.5.0":
+  version "0.5.5"
+  resolved "https://registry.yarnpkg.com/@grpc/proto-loader/-/proto-loader-0.5.5.tgz#6725e7a1827bdf8e92e29fbf4e9ef0203c0906a9"
+  integrity sha512-WwN9jVNdHRQoOBo9FDH7qU+mgfjPc8GygPYms3M+y3fbQLfnCe/Kv/E01t7JRgnrsOHH8euvSbed3mIalXhwqQ==
+  dependencies:
+    lodash.camelcase "^4.3.0"
+    protobufjs "^6.8.6"
+
 "@iarna/toml@^2.2.0":
   version "2.2.5"
   resolved "https://registry.yarnpkg.com/@iarna/toml/-/toml-2.2.5.tgz#b32366c89b43c6f8cefbdefac778b9c828e3ba8c"
@@ -980,6 +1221,59 @@
     "@parcel/utils" "^1.11.0"
     physical-cpu-count "^2.0.0"
 
+"@protobufjs/aspromise@^1.1.1", "@protobufjs/aspromise@^1.1.2":
+  version "1.1.2"
+  resolved "https://registry.yarnpkg.com/@protobufjs/aspromise/-/aspromise-1.1.2.tgz#9b8b0cc663d669a7d8f6f5d0893a14d348f30fbf"
+  integrity sha1-m4sMxmPWaafY9vXQiToU00jzD78=
+
+"@protobufjs/base64@^1.1.2":
+  version "1.1.2"
+  resolved "https://registry.yarnpkg.com/@protobufjs/base64/-/base64-1.1.2.tgz#4c85730e59b9a1f1f349047dbf24296034bb2735"
+  integrity sha512-AZkcAA5vnN/v4PDqKyMR5lx7hZttPDgClv83E//FMNhR2TMcLUhfRUBHCmSl0oi9zMgDDqRUJkSxO3wm85+XLg==
+
+"@protobufjs/codegen@^2.0.4":
+  version "2.0.4"
+  resolved "https://registry.yarnpkg.com/@protobufjs/codegen/-/codegen-2.0.4.tgz#7ef37f0d010fb028ad1ad59722e506d9262815cb"
+  integrity sha512-YyFaikqM5sH0ziFZCN3xDC7zeGaB/d0IUb9CATugHWbd1FRFwWwt4ld4OYMPWu5a3Xe01mGAULCdqhMlPl29Jg==
+
+"@protobufjs/eventemitter@^1.1.0":
+  version "1.1.0"
+  resolved "https://registry.yarnpkg.com/@protobufjs/eventemitter/-/eventemitter-1.1.0.tgz#355cbc98bafad5978f9ed095f397621f1d066b70"
+  integrity sha1-NVy8mLr61ZePntCV85diHx0Ga3A=
+
+"@protobufjs/fetch@^1.1.0":
+  version "1.1.0"
+  resolved "https://registry.yarnpkg.com/@protobufjs/fetch/-/fetch-1.1.0.tgz#ba99fb598614af65700c1619ff06d454b0d84c45"
+  integrity sha1-upn7WYYUr2VwDBYZ/wbUVLDYTEU=
+  dependencies:
+    "@protobufjs/aspromise" "^1.1.1"
+    "@protobufjs/inquire" "^1.1.0"
+
+"@protobufjs/float@^1.0.2":
+  version "1.0.2"
+  resolved "https://registry.yarnpkg.com/@protobufjs/float/-/float-1.0.2.tgz#5e9e1abdcb73fc0a7cb8b291df78c8cbd97b87d1"
+  integrity sha1-Xp4avctz/Ap8uLKR33jIy9l7h9E=
+
+"@protobufjs/inquire@^1.1.0":
+  version "1.1.0"
+  resolved "https://registry.yarnpkg.com/@protobufjs/inquire/-/inquire-1.1.0.tgz#ff200e3e7cf2429e2dcafc1140828e8cc638f089"
+  integrity sha1-/yAOPnzyQp4tyvwRQIKOjMY48Ik=
+
+"@protobufjs/path@^1.1.2":
+  version "1.1.2"
+  resolved "https://registry.yarnpkg.com/@protobufjs/path/-/path-1.1.2.tgz#6cc2b20c5c9ad6ad0dccfd21ca7673d8d7fbf68d"
+  integrity sha1-bMKyDFya1q0NzP0hynZz2Nf79o0=
+
+"@protobufjs/pool@^1.1.0":
+  version "1.1.0"
+  resolved "https://registry.yarnpkg.com/@protobufjs/pool/-/pool-1.1.0.tgz#09fd15f2d6d3abfa9b65bc366506d6ad7846ff54"
+  integrity sha1-Cf0V8tbTq/qbZbw2ZQbWrXhG/1Q=
+
+"@protobufjs/utf8@^1.1.0":
+  version "1.1.0"
+  resolved "https://registry.yarnpkg.com/@protobufjs/utf8/-/utf8-1.1.0.tgz#a777360b5b39a1a2e5106f8e858f2fd2d060c570"
+  integrity sha1-p3c2C1s5oaLlEG+OhY8v0tBgxXA=
+
 "@stylelint/postcss-css-in-js@^0.37.2":
   version "0.37.2"
   resolved "https://registry.yarnpkg.com/@stylelint/postcss-css-in-js/-/postcss-css-in-js-0.37.2.tgz#7e5a84ad181f4234a2480803422a47b8749af3d2"
@@ -1093,6 +1387,11 @@
   resolved "https://registry.yarnpkg.com/@types/json5/-/json5-0.0.29.tgz#ee28707ae94e11d2b827bcbe5270bcea7f3e71ee"
   integrity sha1-7ihweulOEdK4J7y+UnC86n8+ce4=
 
+"@types/long@^4.0.1":
+  version "4.0.1"
+  resolved "https://registry.yarnpkg.com/@types/long/-/long-4.0.1.tgz#459c65fa1867dafe6a8f322c4c51695663cc55e9"
+  integrity sha512-5tXH6Bx/kNGd3MgffdmP4dy2Z+G4eaXw0SE81Tq3BNadtnMR5/ySMzX4SLEzHJzSmPNn4HIdpQsBvXMUykr58w==
+
 "@types/mime@*":
   version "2.0.3"
   resolved "https://registry.yarnpkg.com/@types/mime/-/mime-2.0.3.tgz#c893b73721db73699943bfc3653b1deb7faa4a3a"
@@ -1108,7 +1407,7 @@
   resolved "https://registry.yarnpkg.com/@types/mocha/-/mocha-8.0.3.tgz#51b21b6acb6d1b923bbdc7725c38f9f455166402"
   integrity sha512-vyxR57nv8NfcU0GZu8EUXZLTbCMupIUwy95LJ6lllN+JRPG25CwMHoB1q5xKh8YKhQnHYRAn4yW2yuHbf/5xgg==
 
-"@types/node@*", "@types/node@^12.12.7":
+"@types/node@*", "@types/node@^12.12.47", "@types/node@^12.12.7", "@types/node@^13.7.0":
   version "12.12.67"
   resolved "https://registry.yarnpkg.com/@types/node/-/node-12.12.67.tgz#4f86badb292e822e3b13730a1f9713ed2377f789"
   integrity sha512-R48tgL2izApf+9rYNH+3RBMbRpPeW3N8f0I9HMhggeq4UXwBDqumJ14SDs4ctTMhG11pIOduZ4z3QWGOiMc9Vg==
@@ -1301,6 +1600,13 @@ abab@^2.0.0:
   resolved "https://registry.yarnpkg.com/abab/-/abab-2.0.5.tgz#c0b678fb32d60fc1219c784d6a826fe385aeb79a"
   integrity sha512-9IK9EadsbHo6jLWIpxpR6pL0sazTXV6+SQv25ZB+F7Bj9mJNaOc4nCRabwd5M/JwmUa8idz6Eci6eKfJryPs6Q==
 
+abort-controller@^3.0.0:
+  version "3.0.0"
+  resolved "https://registry.yarnpkg.com/abort-controller/-/abort-controller-3.0.0.tgz#eaf54d53b62bae4138e809ca225c8439a6efb392"
+  integrity sha512-h8lQ8tacZYnR3vNQTgibj+tODHI5/+l06Au2Pcriv/Gmet0eaj4TwWH41sO9wnHDiQsEj19q0drzdWdeAHtweg==
+  dependencies:
+    event-target-shim "^5.0.0"
+
 accepts@~1.3.7:
   version "1.3.7"
   resolved "https://registry.yarnpkg.com/accepts/-/accepts-1.3.7.tgz#531bc726517a3b2b41f850021c6cc15eaab507cd"
@@ -1512,6 +1818,11 @@ arrify@^1.0.1:
   resolved "https://registry.yarnpkg.com/arrify/-/arrify-1.0.1.tgz#898508da2226f380df904728456849c1501a4b0d"
   integrity sha1-iYUI2iIm84DfkEcoRWhJwVAaSw0=
 
+arrify@^2.0.0:
+  version "2.0.1"
+  resolved "https://registry.yarnpkg.com/arrify/-/arrify-2.0.1.tgz#c9655e9331e0abcd588d2a7cad7e9956f66701fa"
+  integrity sha512-3duEwti880xqi4eAMN8AyR4a0ByT90zoYdLlevfrvU43vb0YZwZVfxOgxWrLXXXpyugL0hNZc9G6BiB5B3nUug==
+
 asn1.js@^5.2.0:
   version "5.4.1"
   resolved "https://registry.yarnpkg.com/asn1.js/-/asn1.js-5.4.1.tgz#11a980b84ebb91781ce35b0fdc2ee294e3783f07"
@@ -1661,6 +1972,11 @@ base64-js@^1.0.2:
   resolved "https://registry.yarnpkg.com/base64-js/-/base64-js-1.3.1.tgz#58ece8cb75dd07e71ed08c736abc5fac4dbf8df1"
   integrity sha512-mLQ4i2QO1ytvGWFWmcngKO//JXAQueZvwEKtjgQFM4jIK0kU+ytMfplL8j+n5mspOfjHwoAg+9yhb7BwAHm36g==
 
+base64-js@^1.3.0:
+  version "1.5.1"
+  resolved "https://registry.yarnpkg.com/base64-js/-/base64-js-1.5.1.tgz#1b1b440160a5bf7ad40b650f095963481903930a"
+  integrity sha512-AKpaYlHn8t4SVbOHCy+b5+KKgvR4vrsD8vbvrbiQJps7fKDTkjkDry6ji0rUJjC0kzbNePLwzxq8iypo41qeWA==
+
 base@^0.11.1:
   version "0.11.2"
   resolved "https://registry.yarnpkg.com/base/-/base-0.11.2.tgz#7bde5ced145b6d551a90db87f83c558b4eb48a8f"
@@ -1681,6 +1997,11 @@ bcrypt-pbkdf@^1.0.0:
   dependencies:
     tweetnacl "^0.14.3"
 
+bignumber.js@^9.0.0:
+  version "9.0.1"
+  resolved "https://registry.yarnpkg.com/bignumber.js/-/bignumber.js-9.0.1.tgz#8d7ba124c882bfd8e43260c67475518d0689e4e5"
+  integrity sha512-IdZR9mh6ahOBv/hYGiXyVuyCetmGJhtYkqLBpTStdhEGjegpPlUawydyaF3pbIOFynJTpllEs+NP+CS9jKFLjA==
+
 binary-extensions@^1.0.0:
   version "1.13.1"
   resolved "https://registry.yarnpkg.com/binary-extensions/-/binary-extensions-1.13.1.tgz#598afe54755b2868a5330d2aff9d4ebb53209b65"
@@ -1883,6 +2204,11 @@ buffer-alloc@^1.2.0:
     buffer-alloc-unsafe "^1.1.0"
     buffer-fill "^1.0.0"
 
+buffer-equal-constant-time@1.0.1:
+  version "1.0.1"
+  resolved "https://registry.yarnpkg.com/buffer-equal-constant-time/-/buffer-equal-constant-time-1.0.1.tgz#f8e71132f7ffe6e01a5c9697a4c6f3e48d5cc819"
+  integrity sha1-+OcRMvf/5uAaXJaXpMbz5I1cyBk=
+
 buffer-equal@0.0.1:
   version "0.0.1"
   resolved "https://registry.yarnpkg.com/buffer-equal/-/buffer-equal-0.0.1.tgz#91bc74b11ea405bc916bc6aa908faafa5b4aac4b"
@@ -2345,6 +2671,11 @@ core-js-compat@^3.6.2:
     browserslist "^4.8.5"
     semver "7.0.0"
 
+core-js@3.6.5:
+  version "3.6.5"
+  resolved "https://registry.yarnpkg.com/core-js/-/core-js-3.6.5.tgz#7395dc273af37fb2e50e9bd3d9fe841285231d1a"
+  integrity sha512-vZVEEwZoIsI+vPEuoF9Iqf5H7/M3eeQqWlQnYa8FSKKePuYTf5MWnxb5SDAzCa60b3JBRS5g9b+Dq7b1y/RCrA==
+
 core-js@^2.4.0, core-js@^2.6.5:
   version "2.6.11"
   resolved "https://registry.yarnpkg.com/core-js/-/core-js-2.6.11.tgz#38831469f9922bded8ee21c9dc46985e0399308c"
@@ -2821,6 +3152,11 @@ dom-serializer@0:
     domelementtype "^2.0.1"
     entities "^2.0.0"
 
+dom-storage@2.1.0:
+  version "2.1.0"
+  resolved "https://registry.yarnpkg.com/dom-storage/-/dom-storage-2.1.0.tgz#00fb868bc9201357ea243c7bcfd3304c1e34ea39"
+  integrity sha512-g6RpyWXzl0RR6OTElHKBl7nwnK87GUyZMYC7JWsB/IA73vpqK2K6LT39x4VepLxlSsWBFrPVLnsSR5Jyty0+2Q==
+
 domain-browser@^1.1.1:
   version "1.2.0"
   resolved "https://registry.yarnpkg.com/domain-browser/-/domain-browser-1.2.0.tgz#3d31f50191a6749dd1375a7f522e823d42e54eda"
@@ -2890,6 +3226,13 @@ ecc-jsbn@~0.1.1:
     jsbn "~0.1.0"
     safer-buffer "^2.1.0"
 
+ecdsa-sig-formatter@1.0.11, ecdsa-sig-formatter@^1.0.11:
+  version "1.0.11"
+  resolved "https://registry.yarnpkg.com/ecdsa-sig-formatter/-/ecdsa-sig-formatter-1.0.11.tgz#ae0f0fa2d85045ef14a817daa3ce9acd0489e5bf"
+  integrity sha512-nagl3RYrbNv6kQkeJIpt6NJZy8twLB/2vtz6yN9Z4vRKHN4/QZJIEbqohALSgwKdnksuY3k5Addp5lg8sVoVcQ==
+  dependencies:
+    safe-buffer "^5.0.1"
+
 ee-first@1.1.1:
   version "1.1.1"
   resolved "https://registry.yarnpkg.com/ee-first/-/ee-first-1.1.1.tgz#590c61156b0ae2f4f0255732a158b266bc56b21d"
@@ -3255,6 +3598,11 @@ etag@~1.8.1:
   resolved "https://registry.yarnpkg.com/etag/-/etag-1.8.1.tgz#41ae2eeb65efa62268aebfea83ac7d79299b0887"
   integrity sha1-Qa4u62XvpiJorr/qg6x9eSmbCIc=
 
+event-target-shim@^5.0.0:
+  version "5.0.1"
+  resolved "https://registry.yarnpkg.com/event-target-shim/-/event-target-shim-5.0.1.tgz#5d4d3ebdf9583d63a5333ce2deb7480ab2b05789"
+  integrity sha512-i/2XbnSz/uxRCU6+NdVJgKWDTM427+MqYbkQzD321DuCQJUqOuJKIA0IM2+W2xtYHdKOmZ4dR6fExsd4SXL+WQ==
+
 eventemitter3@^4.0.0:
   version "4.0.7"
   resolved "https://registry.yarnpkg.com/eventemitter3/-/eventemitter3-4.0.7.tgz#2de9b68f6528d5644ef5c59526a1b4a07306169f"
@@ -3345,7 +3693,7 @@ extend-shallow@^3.0.0, extend-shallow@^3.0.2:
     assign-symbols "^1.0.0"
     is-extendable "^1.0.1"
 
-extend@^3.0.0, extend@~3.0.2:
+extend@^3.0.0, extend@^3.0.2, extend@~3.0.2:
   version "3.0.2"
   resolved "https://registry.yarnpkg.com/extend/-/extend-3.0.2.tgz#f8b1136b4071fbd8eb140aff858b1019ec2915fa"
   integrity sha512-fjquC59cD7CyW6urNXK0FBufkZcoiGG80wTuPujX590cB5Ttln20E2UB4S/WARVqhXffZl2LNgS+gQdPIIim/g==
@@ -3433,6 +3781,11 @@ fast-safe-stringify@^2.0.7:
   resolved "https://registry.yarnpkg.com/fast-safe-stringify/-/fast-safe-stringify-2.0.7.tgz#124aa885899261f68aedb42a7c080de9da608743"
   integrity sha512-Utm6CdzT+6xsDk2m8S6uL8VHxNwI6Jub+e9NYTcAms28T84pTa25GJQV9j0CY0N1rM8hK4x6grpF2BQf+2qwVA==
 
+fast-text-encoding@^1.0.0:
+  version "1.0.3"
+  resolved "https://registry.yarnpkg.com/fast-text-encoding/-/fast-text-encoding-1.0.3.tgz#ec02ac8e01ab8a319af182dae2681213cfe9ce53"
+  integrity sha512-dtm4QZH9nZtcDt8qJiOH9fcQd1NAgi+K1O2DbE6GG1PPCK/BWfOH3idCTRQ4ImXRUOyopDEgDEnVEE7Y/2Wrig==
+
 fastest-levenshtein@^1.0.12:
   version "1.0.12"
   resolved "https://registry.yarnpkg.com/fastest-levenshtein/-/fastest-levenshtein-1.0.12.tgz#9990f7d3a88cc5a9ffd1f1745745251700d497e2"
@@ -3457,6 +3810,13 @@ fault@^1.0.1:
   dependencies:
     format "^0.2.0"
 
+faye-websocket@0.11.3:
+  version "0.11.3"
+  resolved "https://registry.yarnpkg.com/faye-websocket/-/faye-websocket-0.11.3.tgz#5c0e9a8968e8912c286639fde977a8b209f2508e"
+  integrity sha512-D2y4bovYpzziGgbHYtGCMjlJM36vAl/y+xUyn1C+FVx8szd1E+86KwVw6XvYSzOP8iMpm1X0I4xJD+QtUb36OA==
+  dependencies:
+    websocket-driver ">=0.5.1"
+
 file-entry-cache@^5.0.1:
   version "5.0.1"
   resolved "https://registry.yarnpkg.com/file-entry-cache/-/file-entry-cache-5.0.1.tgz#ca0f6efa6dd3d561333fb14515065c2fafdf439c"
@@ -3539,6 +3899,26 @@ find-up@^4.1.0:
     locate-path "^5.0.0"
     path-exists "^4.0.0"
 
+firebase@^8.2.1:
+  version "8.2.1"
+  resolved "https://registry.yarnpkg.com/firebase/-/firebase-8.2.1.tgz#fd8eb523a4ca424030d8eb21c2795aa3c1d1031d"
+  integrity sha512-u2dvRIbyHZ2g0dziHKwXvMBubTSf+fgJcijXyy7fXcFFPd3wbDaGlHz7Sc6saOnlJtzZAYmvZUXaIxnStKOOXg==
+  dependencies:
+    "@firebase/analytics" "0.6.2"
+    "@firebase/app" "0.6.13"
+    "@firebase/app-types" "0.6.1"
+    "@firebase/auth" "0.16.1"
+    "@firebase/database" "0.8.1"
+    "@firebase/firestore" "2.1.1"
+    "@firebase/functions" "0.6.1"
+    "@firebase/installations" "0.4.19"
+    "@firebase/messaging" "0.7.3"
+    "@firebase/performance" "0.4.5"
+    "@firebase/polyfill" "0.3.36"
+    "@firebase/remote-config" "0.1.30"
+    "@firebase/storage" "0.4.2"
+    "@firebase/util" "0.3.4"
+
 flat-cache@^2.0.1:
   version "2.0.1"
   resolved "https://registry.yarnpkg.com/flat-cache/-/flat-cache-2.0.1.tgz#5d296d6f04bda44a4630a301413bdbc2ec085ec0"
@@ -3692,6 +4072,25 @@ functional-red-black-tree@^1.0.1:
   resolved "https://registry.yarnpkg.com/functional-red-black-tree/-/functional-red-black-tree-1.0.1.tgz#1b0ab3bd553b2a0d6399d29c0e3ea0b252078327"
   integrity sha1-GwqzvVU7Kg1jmdKcDj6gslIHgyc=
 
+gaxios@^4.0.0:
+  version "4.1.0"
+  resolved "https://registry.yarnpkg.com/gaxios/-/gaxios-4.1.0.tgz#e8ad466db5a4383c70b9d63bfd14dfaa87eb0099"
+  integrity sha512-vb0to8xzGnA2qcgywAjtshOKKVDf2eQhJoiL6fHhgW5tVN7wNk7egnYIO9zotfn3lQ3De1VPdf7V5/BWfCtCmg==
+  dependencies:
+    abort-controller "^3.0.0"
+    extend "^3.0.2"
+    https-proxy-agent "^5.0.0"
+    is-stream "^2.0.0"
+    node-fetch "^2.3.0"
+
+gcp-metadata@^4.2.0:
+  version "4.2.1"
+  resolved "https://registry.yarnpkg.com/gcp-metadata/-/gcp-metadata-4.2.1.tgz#31849fbcf9025ef34c2297c32a89a1e7e9f2cd62"
+  integrity sha512-tSk+REe5iq/N+K+SK1XjZJUrFPuDqGZVzCy2vocIHIGmPlTGsa8owXMJwGkrXr73NO0AzhPW4MF2DEHz7P2AVw==
+  dependencies:
+    gaxios "^4.0.0"
+    json-bigint "^1.0.0"
+
 gensync@^1.0.0-beta.1:
   version "1.0.0-beta.1"
   resolved "https://registry.yarnpkg.com/gensync/-/gensync-1.0.0-beta.1.tgz#58f4361ff987e5ff6e1e7a210827aa371eaac269"
@@ -3825,6 +4224,28 @@ gonzales-pe@^4.3.0:
   dependencies:
     minimist "^1.2.5"
 
+google-auth-library@^6.1.1:
+  version "6.1.3"
+  resolved "https://registry.yarnpkg.com/google-auth-library/-/google-auth-library-6.1.3.tgz#39d868140b70d0c4b32c6f6d8f4ccc1400d84dca"
+  integrity sha512-m9mwvY3GWbr7ZYEbl61isWmk+fvTmOt0YNUfPOUY2VH8K5pZlAIWJjxEi0PqR3OjMretyiQLI6GURMrPSwHQ2g==
+  dependencies:
+    arrify "^2.0.0"
+    base64-js "^1.3.0"
+    ecdsa-sig-formatter "^1.0.11"
+    fast-text-encoding "^1.0.0"
+    gaxios "^4.0.0"
+    gcp-metadata "^4.2.0"
+    gtoken "^5.0.4"
+    jws "^4.0.0"
+    lru-cache "^6.0.0"
+
+google-p12-pem@^3.0.3:
+  version "3.0.3"
+  resolved "https://registry.yarnpkg.com/google-p12-pem/-/google-p12-pem-3.0.3.tgz#673ac3a75d3903a87f05878f3c75e06fc151669e"
+  integrity sha512-wS0ek4ZtFx/ACKYF3JhyGe5kzH7pgiQ7J5otlumqR9psmWMYc+U9cErKlCYVYHoUaidXHdZ2xbo34kB+S+24hA==
+  dependencies:
+    node-forge "^0.10.0"
+
 graceful-fs@^4.1.11, graceful-fs@^4.1.2, graceful-fs@^4.1.6, graceful-fs@^4.2.0:
   version "4.2.4"
   resolved "https://registry.yarnpkg.com/graceful-fs/-/graceful-fs-4.2.4.tgz#2256bde14d3632958c465ebc96dc467ca07a29fb"
@@ -3843,6 +4264,16 @@ growl@1.10.5:
   resolved "https://registry.yarnpkg.com/growl/-/growl-1.10.5.tgz#f2735dc2283674fa67478b10181059355c369e5e"
   integrity sha512-qBr4OuELkhPenW6goKVXiv47US3clb3/IbuWF9KNKEijAy9oeHxU9IgzjvJhHkUzhaj7rOUD7+YGWqUjLp5oSA==
 
+gtoken@^5.0.4:
+  version "5.1.0"
+  resolved "https://registry.yarnpkg.com/gtoken/-/gtoken-5.1.0.tgz#4ba8d2fc9a8459098f76e7e8fd7beaa39fda9fe4"
+  integrity sha512-4d8N6Lk8TEAHl9vVoRVMh9BNOKWVgl2DdNtr3428O75r3QFrF/a5MMu851VmK0AA8+iSvbwRv69k5XnMLURGhg==
+  dependencies:
+    gaxios "^4.0.0"
+    google-p12-pem "^3.0.3"
+    jws "^4.0.0"
+    mime "^2.2.0"
+
 har-schema@^2.0.0:
   version "2.0.0"
   resolved "https://registry.yarnpkg.com/har-schema/-/har-schema-2.0.0.tgz#a94c2224ebcac04782a0d9035521f24735b7ec92"
@@ -4059,6 +4490,11 @@ http-errors@1.7.3, http-errors@~1.7.2:
     statuses ">= 1.5.0 < 2"
     toidentifier "1.0.0"
 
+http-parser-js@>=0.5.1:
+  version "0.5.2"
+  resolved "https://registry.yarnpkg.com/http-parser-js/-/http-parser-js-0.5.2.tgz#da2e31d237b393aae72ace43882dd7e270a8ff77"
+  integrity sha512-opCO9ASqg5Wy2FNo7A0sxy71yGbbkJJXLdgMK04Tcypw9jr2MgWbyubb0+WdmDmGnFflO7fRbqbaihh/ENDlRQ==
+
 http-proxy-agent@^4.0.0, http-proxy-agent@^4.0.1:
   version "4.0.1"
   resolved "https://registry.yarnpkg.com/http-proxy-agent/-/http-proxy-agent-4.0.1.tgz#8a8c8ef7f5932ccf953c296ca8291b95aa74aa3a"
@@ -4116,6 +4552,11 @@ icss-replace-symbols@1.1.0, icss-replace-symbols@^1.1.0:
   resolved "https://registry.yarnpkg.com/icss-replace-symbols/-/icss-replace-symbols-1.1.0.tgz#06ea6f83679a7749e386cfe1fe812ae5db223ded"
   integrity sha1-Bupvg2ead0njhs/h/oEq5dsiPe0=
 
+idb@3.0.2:
+  version "3.0.2"
+  resolved "https://registry.yarnpkg.com/idb/-/idb-3.0.2.tgz#c8e9122d5ddd40f13b60ae665e4862f8b13fa384"
+  integrity sha512-+FLa/0sTXqyux0o6C+i2lOR0VoS60LU/jzUo5xjfY6+7sEEgy4Gz1O7yFBXvjd7N0NyIGWIRg8DcQSLEG+VSPw==
+
 ieee754@^1.1.4:
   version "1.1.13"
   resolved "https://registry.yarnpkg.com/ieee754/-/ieee754-1.1.13.tgz#ec168558e95aa181fd87d37f55c32bbcb6708b84"
@@ -4469,6 +4910,11 @@ is-set@^2.0.1:
   resolved "https://registry.yarnpkg.com/is-set/-/is-set-2.0.1.tgz#d1604afdab1724986d30091575f54945da7e5f43"
   integrity sha512-eJEzOtVyenDs1TMzSQ3kU3K+E0GUS9sno+F0OBT97xsgcJsF9nXMBtkT9/kut5JEpM7oL7X/0qxR17K3mcwIAA==
 
+is-stream@^2.0.0:
+  version "2.0.0"
+  resolved "https://registry.yarnpkg.com/is-stream/-/is-stream-2.0.0.tgz#bde9c32680d6fae04129d6ac9d921ce7815f78e3"
+  integrity sha512-XCoy+WlUr7d1+Z8GgSuXmpuUFC9fOhRXglJMx+dwLKTkL44Cjd4W1Z5P+BQZpr+cR93aGP4S/s7Ftw6Nd/kiEw==
+
 is-string@^1.0.4, is-string@^1.0.5:
   version "1.0.5"
   resolved "https://registry.yarnpkg.com/is-string/-/is-string-1.0.5.tgz#40493ed198ef3ff477b8c7f92f644ec82a5cd3a6"
@@ -4628,6 +5074,13 @@ jsesc@~0.5.0:
   resolved "https://registry.yarnpkg.com/jsesc/-/jsesc-0.5.0.tgz#e7dee66e35d6fc16f710fe91d5cf69f70f08911d"
   integrity sha1-597mbjXW/Bb3EP6R1c9p9w8IkR0=
 
+json-bigint@^1.0.0:
+  version "1.0.0"
+  resolved "https://registry.yarnpkg.com/json-bigint/-/json-bigint-1.0.0.tgz#ae547823ac0cad8398667f8cd9ef4730f5b01ff1"
+  integrity sha512-SiPv/8VpZuWbvLSMtTDU8hEfrZWg/mH/nV/b4o0CYbSxu1UIQPLdwKOCIyLQX+VIPO5vrLX3i8qtqFyhdPSUSQ==
+  dependencies:
+    bignumber.js "^9.0.0"
+
 json-parse-better-errors@^1.0.1:
   version "1.0.2"
   resolved "https://registry.yarnpkg.com/json-parse-better-errors/-/json-parse-better-errors-1.0.2.tgz#bb867cfb3450e69107c131d1c514bab3dc8bcaa9"
@@ -4698,6 +5151,23 @@ jsprim@^1.2.2:
     json-schema "0.2.3"
     verror "1.10.0"
 
+jwa@^2.0.0:
+  version "2.0.0"
+  resolved "https://registry.yarnpkg.com/jwa/-/jwa-2.0.0.tgz#a7e9c3f29dae94027ebcaf49975c9345593410fc"
+  integrity sha512-jrZ2Qx916EA+fq9cEAeCROWPTfCwi1IVHqT2tapuqLEVVDKFDENFw1oL+MwrTvH6msKxsd1YTDVw6uKEcsrLEA==
+  dependencies:
+    buffer-equal-constant-time "1.0.1"
+    ecdsa-sig-formatter "1.0.11"
+    safe-buffer "^5.0.1"
+
+jws@^4.0.0:
+  version "4.0.0"
+  resolved "https://registry.yarnpkg.com/jws/-/jws-4.0.0.tgz#2d4e8cf6a318ffaa12615e9dec7e86e6c97310f4"
+  integrity sha512-KDncfTmOZoOMTFG4mBlG0qUIOlc03fmzH+ru6RgYVZhPkyiy/92Owlt/8UEN+a4TXR1FQetfIpJE8ApdvdVxTg==
+  dependencies:
+    jwa "^2.0.0"
+    safe-buffer "^5.0.1"
+
 kind-of@^3.0.2, kind-of@^3.0.3, kind-of@^3.2.0:
   version "3.2.2"
   resolved "https://registry.yarnpkg.com/kind-of/-/kind-of-3.2.2.tgz#31ea21a734bab9bbb0f32466d893aea51e4a3c64"
@@ -4802,6 +5272,11 @@ locate-path@^6.0.0:
   dependencies:
     p-locate "^5.0.0"
 
+lodash.camelcase@^4.3.0:
+  version "4.3.0"
+  resolved "https://registry.yarnpkg.com/lodash.camelcase/-/lodash.camelcase-4.3.0.tgz#b28aa6288a2b9fc651035c7711f65ab6190331a6"
+  integrity sha1-soqmKIorn8ZRA1x3EfZathkDMaY=
+
 lodash.clone@^4.5.0:
   version "4.5.0"
   resolved "https://registry.yarnpkg.com/lodash.clone/-/lodash.clone-4.5.0.tgz#195870450f5a13192478df4bc3d23d2dea1907b6"
@@ -4841,6 +5316,11 @@ log-symbols@^2.2.0:
   dependencies:
     chalk "^2.0.1"
 
+long@^4.0.0:
+  version "4.0.0"
+  resolved "https://registry.yarnpkg.com/long/-/long-4.0.0.tgz#9a7b71cfb7d361a194ea555241c92f7468d5bf28"
+  integrity sha512-XsP+KhQif4bjX1kbuSiySJFNAehNxgLb6hPRGJ9QsUr8ajHkuXGdrHmFUTUUXhDwVX2R5bY4JNZEwbUiMhV+MA==
+
 longest-streak@^2.0.1:
   version "2.0.4"
   resolved "https://registry.yarnpkg.com/longest-streak/-/longest-streak-2.0.4.tgz#b8599957da5b5dab64dee3fe316fa774597d90e4"
@@ -4853,6 +5333,13 @@ lru-cache@^5.1.1:
   dependencies:
     yallist "^3.0.2"
 
+lru-cache@^6.0.0:
+  version "6.0.0"
+  resolved "https://registry.yarnpkg.com/lru-cache/-/lru-cache-6.0.0.tgz#6d6fe6570ebd96aaf90fcad1dafa3b2566db3a94"
+  integrity sha512-Jo6dJ04CmSjuznwJSS3pUeWmd/H0ffTlkXXgwZi+eq1UCmqQwCh+eLsYOYCwY991i2Fah4h1BEMCx4qThGbsiA==
+  dependencies:
+    yallist "^4.0.0"
+
 magic-string@^0.22.4:
   version "0.22.5"
   resolved "https://registry.yarnpkg.com/magic-string/-/magic-string-0.22.5.tgz#8e9cf5afddf44385c1da5bc2a6a0dbd10b03657e"
@@ -5035,6 +5522,11 @@ mime@1.6.0:
   resolved "https://registry.yarnpkg.com/mime/-/mime-1.6.0.tgz#32cd9e5c64553bd58d19a568af452acff04981b1"
   integrity sha512-x0Vn8spI+wuJ1O6S7gnbaQg8Pxh4NNHb7KSINmEWKiPE4RKOplvijn+NkmYmmRgP68mc70j2EbeTFRsrswaQeg==
 
+mime@^2.2.0:
+  version "2.4.7"
+  resolved "https://registry.yarnpkg.com/mime/-/mime-2.4.7.tgz#962aed9be0ed19c91fd7dc2ece5d7f4e89a90d74"
+  integrity sha512-dhNd1uA2u397uQk3Nv5LM4lm93WYDUXFn3Fu291FJerns4jyTudqhIWe4W04YLy7Uk1tm1Ore04NpjRvQp/NPA==
+
 mime@^2.4.6:
   version "2.4.6"
   resolved "https://registry.yarnpkg.com/mime/-/mime-2.4.6.tgz#e5b407c90db442f2beb5b162373d07b69affa4d1"
@@ -5214,6 +5706,16 @@ node-addon-api@^1.7.1:
   resolved "https://registry.yarnpkg.com/node-addon-api/-/node-addon-api-1.7.2.tgz#3df30b95720b53c24e59948b49532b662444f54d"
   integrity sha512-ibPK3iA+vaY1eEjESkQkM0BbCqFOaZMiXRTtdB0u7b4djtY6JnsjvPdUHVMg6xQt3B8fpTTWHI9A+ADjM9frzg==
 
+node-fetch@2.6.1, node-fetch@^2.3.0:
+  version "2.6.1"
+  resolved "https://registry.yarnpkg.com/node-fetch/-/node-fetch-2.6.1.tgz#045bd323631f76ed2e2b55573394416b639a0052"
+  integrity sha512-V4aYg89jEoVRxRb2fJdAg8FHvI7cEyYdVAh94HH0UIK8oJxUfkjlDQN9RbMx+bEjP7+ggMiFRprSti032Oipxw==
+
+node-forge@^0.10.0:
+  version "0.10.0"
+  resolved "https://registry.yarnpkg.com/node-forge/-/node-forge-0.10.0.tgz#32dea2afb3e9926f02ee5ce8794902691a676bf3"
+  integrity sha512-PPmu8eEeG9saEUvI97fm4OYxXVB6bFvyNTyiUOBichBpFG8A1Ljw3bY62+5oOjDEMHRnd0Y7HQ+x7uzxOzC6JA==
+
 node-forge@^0.7.1:
   version "0.7.6"
   resolved "https://registry.yarnpkg.com/node-forge/-/node-forge-0.7.6.tgz#fdf3b418aee1f94f0ef642cd63486c77ca9724ac"
@@ -6307,6 +6809,11 @@ progress@^2.0.0:
   resolved "https://registry.yarnpkg.com/progress/-/progress-2.0.3.tgz#7e8cf8d8f5b8f239c1bc68beb4eb78567d572ef8"
   integrity sha512-7PiHtLll5LdnKIMw100I+8xJXR5gW2QwWYkT6iJva0bXitZKa/XMrSbdmg3r2Xnaidz9Qumd0VPaMrZlF9V9sA==
 
+promise-polyfill@8.1.3:
+  version "8.1.3"
+  resolved "https://registry.yarnpkg.com/promise-polyfill/-/promise-polyfill-8.1.3.tgz#8c99b3cf53f3a91c68226ffde7bde81d7f904116"
+  integrity sha512-MG5r82wBzh7pSKDRa9y+vllNHz3e3d4CNj1PQE4BQYxLme0gKYYBm9YENq+UkEikyZ0XbiGWxYlVw3Rl9O/U8g==
+
 promise.allsettled@1.0.2:
   version "1.0.2"
   resolved "https://registry.yarnpkg.com/promise.allsettled/-/promise.allsettled-1.0.2.tgz#d66f78fbb600e83e863d893e98b3d4376a9c47c9"
@@ -6318,6 +6825,25 @@ promise.allsettled@1.0.2:
     function-bind "^1.1.1"
     iterate-value "^1.0.0"
 
+protobufjs@^6.8.6:
+  version "6.10.2"
+  resolved "https://registry.yarnpkg.com/protobufjs/-/protobufjs-6.10.2.tgz#b9cb6bd8ec8f87514592ba3fdfd28e93f33a469b"
+  integrity sha512-27yj+04uF6ya9l+qfpH187aqEzfCF4+Uit0I9ZBQVqK09hk/SQzKa2MUqUpXaVa7LOFRg1TSSr3lVxGOk6c0SQ==
+  dependencies:
+    "@protobufjs/aspromise" "^1.1.2"
+    "@protobufjs/base64" "^1.1.2"
+    "@protobufjs/codegen" "^2.0.4"
+    "@protobufjs/eventemitter" "^1.1.0"
+    "@protobufjs/fetch" "^1.1.0"
+    "@protobufjs/float" "^1.0.2"
+    "@protobufjs/inquire" "^1.1.0"
+    "@protobufjs/path" "^1.1.2"
+    "@protobufjs/pool" "^1.1.0"
+    "@protobufjs/utf8" "^1.1.0"
+    "@types/long" "^4.0.1"
+    "@types/node" "^13.7.0"
+    long "^4.0.0"
+
 proxy-addr@~2.0.5:
   version "2.0.6"
   resolved "https://registry.yarnpkg.com/proxy-addr/-/proxy-addr-2.0.6.tgz#fdc2336505447d3f2f2c638ed272caf614bbb2bf"
@@ -6894,7 +7420,7 @@ run-parallel@^1.1.9:
   resolved "https://registry.yarnpkg.com/run-parallel/-/run-parallel-1.1.9.tgz#c9dd3a7cf9f4b2c4b6244e173a6ed866e61dd679"
   integrity sha512-DEqnSRTDw/Tc3FXf49zedI638Z9onwUotBMiUFKmrO2sdFKIbXamXGQ3Axd4qgphxKB4kw/qP1w5kTxnfU1B9Q==
 
-safe-buffer@5.1.2, safe-buffer@^5.0.1, safe-buffer@^5.1.0, safe-buffer@^5.1.1, safe-buffer@^5.1.2, safe-buffer@^5.2.0, safe-buffer@~5.1.0, safe-buffer@~5.1.1, safe-buffer@~5.2.0:
+safe-buffer@5.1.2, safe-buffer@>=5.1.0, safe-buffer@^5.0.1, safe-buffer@^5.1.0, safe-buffer@^5.1.1, safe-buffer@^5.1.2, safe-buffer@^5.2.0, safe-buffer@~5.1.0, safe-buffer@~5.1.1, safe-buffer@~5.2.0:
   version "5.2.1"
   resolved "https://registry.yarnpkg.com/safe-buffer/-/safe-buffer-5.2.1.tgz#1eaf9fa9bdb1fdd4ec75f58f9cdb4e6b7827eec6"
   integrity sha512-rp3So07KcdmmKbGvgaNxQSJr7bGVSVk5S9Eq1F+ppbRo70+YeaDxkw5Dd8NPN+GD6bjnYm2VuPuCXmpuYvmCXQ==
@@ -6940,6 +7466,11 @@ semver@7.0.0:
   resolved "https://registry.yarnpkg.com/semver/-/semver-7.0.0.tgz#5f3ca35761e47e05b206c6daff2cf814f0316b8e"
   integrity sha512-+GB6zVA9LWh6zovYQLALHwv5rb2PHGlJi3lfiqIHxR0uuwCgefcOJc59v9fv1w8GbStwxuuqqAjI9NMAOOgq1A==
 
+semver@^6.2.0:
+  version "6.3.0"
+  resolved "https://registry.yarnpkg.com/semver/-/semver-6.3.0.tgz#ee0a64c8af5e8ceea67687b133761e1becbd1d3d"
+  integrity sha512-b39TBaTSfV6yBrapU89p5fKekE2m/NwnDocOVruQFS1/veMgdzuPcnOM34M6CwxW8jH/lxEa5rBoDeUwu5HHTw==
+
 semver@^7.1.3, semver@^7.2.1, semver@^7.3.2:
   version "7.3.2"
   resolved "https://registry.yarnpkg.com/semver/-/semver-7.3.2.tgz#604962b052b81ed0786aae84389ffba70ffd3938"
@@ -7830,7 +8361,7 @@ tsconfig-paths@^3.9.0:
     minimist "^1.2.0"
     strip-bom "^3.0.0"
 
-tslib@^1.8.1:
+tslib@^1.11.1, tslib@^1.8.1:
   version "1.14.1"
   resolved "https://registry.yarnpkg.com/tslib/-/tslib-1.14.1.tgz#cf2d38bdc34a134bcaf1091c41f6619e2f672d00"
   integrity sha512-Xni35NKzjgMrwevysHTCArtLDpPvye8zV/0E4EyYn43P7/7qvQwPh9BGkHewbMulVntbigmcT7rdX3BNo9wRJg==
@@ -8311,6 +8842,20 @@ webidl-conversions@^4.0.2:
   resolved "https://registry.yarnpkg.com/webidl-conversions/-/webidl-conversions-4.0.2.tgz#a855980b1f0b6b359ba1d5d9fb39ae941faa63ad"
   integrity sha512-YQ+BmxuTgd6UXZW3+ICGfyqRyHXVlD5GtQr5+qjiNW7bF0cqrzX500HVXPBOvgXb5YnzDd+h0zqyv61KUD7+Sg==
 
+websocket-driver@>=0.5.1:
+  version "0.7.4"
+  resolved "https://registry.yarnpkg.com/websocket-driver/-/websocket-driver-0.7.4.tgz#89ad5295bbf64b480abcba31e4953aca706f5760"
+  integrity sha512-b17KeDIQVjvb0ssuSDF2cYXSg2iztliJ4B9WdsuB6J952qCPKmnVq4DyW5motImXHDC1cBT/1UezrJVsKw5zjg==
+  dependencies:
+    http-parser-js ">=0.5.1"
+    safe-buffer ">=5.1.0"
+    websocket-extensions ">=0.1.1"
+
+websocket-extensions@>=0.1.1:
+  version "0.1.4"
+  resolved "https://registry.yarnpkg.com/websocket-extensions/-/websocket-extensions-0.1.4.tgz#7f8473bc839dfd87608adb95d7eb075211578a42"
+  integrity sha512-OqedPIGOfsDlo31UNwYbCFMSaO9m9G/0faIHj5/dZFDMFqPTcx6UwqyOy3COEaEOg/9VsGIpdqn62W5KhoKSpg==
+
 whatwg-encoding@^1.0.1, whatwg-encoding@^1.0.5:
   version "1.0.5"
   resolved "https://registry.yarnpkg.com/whatwg-encoding/-/whatwg-encoding-1.0.5.tgz#5abacf777c32166a51d085d6b4f3e7d27113ddb0"
@@ -8318,6 +8863,11 @@ whatwg-encoding@^1.0.1, whatwg-encoding@^1.0.5:
   dependencies:
     iconv-lite "0.4.24"
 
+whatwg-fetch@2.0.4:
+  version "2.0.4"
+  resolved "https://registry.yarnpkg.com/whatwg-fetch/-/whatwg-fetch-2.0.4.tgz#dde6a5df315f9d39991aa17621853d720b85566f"
+  integrity sha512-dcQ1GWpOD/eEQ97k66aiEVpNnapVj90/+R+SXTPYGHpYBBypfKJEQjLrvMZ7YXbKm21gXd4NcuxUTjiv1YtLng==
+
 whatwg-mimetype@^2.2.0, whatwg-mimetype@^2.3.0:
   version "2.3.0"
   resolved "https://registry.yarnpkg.com/whatwg-mimetype/-/whatwg-mimetype-2.3.0.tgz#3d4b1e0312d2079879f826aff18dbeeca5960fbf"
@@ -8438,6 +8988,11 @@ xmlchars@^2.1.1:
   resolved "https://registry.yarnpkg.com/xmlchars/-/xmlchars-2.2.0.tgz#060fe1bcb7f9c76fe2a17db86a9bc3ab894210cb"
   integrity sha512-JZnDKK8B0RCDw84FNdDAIpZK+JuJw+s7Lz8nksI7SIuU3UXJJslUthsi+uWBUYOwPFwW7W7PRLRfUKpxjtjFCw==
 
+xmlhttprequest@1.8.0:
+  version "1.8.0"
+  resolved "https://registry.yarnpkg.com/xmlhttprequest/-/xmlhttprequest-1.8.0.tgz#67fe075c5c24fef39f9d65f5f7b7fe75171968fc"
+  integrity sha1-Z/4HXFwk/vOfnWX197f+dRcZaPw=
+
 xregexp@2.0.0:
   version "2.0.0"
   resolved "https://registry.yarnpkg.com/xregexp/-/xregexp-2.0.0.tgz#52a63e56ca0b84a7f3a5f3d61872f126ad7a5943"
